<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Greek Directory - Local Greek-Owned Businesses, Churches & Cultural Centers</title>
    <!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-VCVMPQNV9V"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-VCVMPQNV9V');
</script>
    
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="Greek Directory">
    <link rel="apple-touch-startup-image" href="https://social.thegreekdirectory.org/Logocircleonly2.png">
    <link rel="apple-touch-icon" href="https://social.thegreekdirectory.org/Logocircleonly2.png" type="image/x-icon">
    
    <meta name="description" content="Discover Greek and Hellenic American businesses, restaurants, churches, schools, and cultural centers. Your complete guide to the Greek-American community.">
    <meta name="keywords" content="greek, greek american, greek-american, greek americans, greek-americans, directory, greek directory, the greek directory, greek american directory, the greek american directory, local greek, local greeks, hellenic, hellenic american, hellenic-american, hellenic americans, hellenic-americans, hellenic directory, hellenic-american directory, hellenic american directory, local hellenic, greek businesses, greek restaurants, greek orthodox churches, greek cultural centers">
    <link rel="icon" href="https://static.thegreekdirectory.org/bluefavicon.png" media="(prefers-color-scheme: light)">
    <link rel="icon" href="https://static.thegreekdirectory.org/whitefavicon.png" media="(prefers-color-scheme: dark)">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        #map { width: 100%; height: calc(100vh - 300px); max-height: 600px; min-height: 400px; }
        .badge { font-size: 11px; padding: 3px 8px; border-radius: 4px; font-weight: 600; display: inline-block; }
        .badge-open { background: #10b981; color: white; }
        .badge-closed { background: #ef4444; color: white; }
        .badge-opening-soon { background: #fbbf24; color: #78350f; }
        .badge-closing-soon { background: #f59e0b; color: white; }
        .badge-hours-unknown { background: #6b7280; color: white; }
        .badge-featured { background: #fbbf24; color: #78350f; }
        .badge-verified { background: #0000FF; color: white; }
        .badge-claimed { background: #6B7280; color: white; }
        img { pointer-events: none; user-select: none; -webkit-user-drag: none; }
        
        header { z-index: 100 !important; position: relative; }
        #filterPanel { max-height: calc(100vh - 200px); overflow-y: auto; }
        #filterPanel .space-y-4 > div:last-child { padding-bottom: 40px; }
        
        #mapContainer { position: relative; z-index: 50; }
        
        .map-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 1000;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #055193;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .custom-marker {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            border: 3px solid #055193;
            overflow: hidden;
            background: white;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .custom-marker:hover { transform: scale(1.1); z-index: 1000 !important; }
        .custom-marker.featured { border-color: #fbbf24; box-shadow: 0 0 15px rgba(251, 191, 36, 0.6); }
        .custom-marker img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
            pointer-events: none;
            user-select: none;
            -webkit-user-drag: none;
        }
        
        .marker-cluster {
            background: rgba(5, 81, 147, 0.6);
            border: 3px solid #055193;
            border-radius: 50%;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .marker-cluster:hover { transform: scale(1.1); background: rgba(5, 81, 147, 0.8); }
        .marker-cluster-small { width: 40px; height: 40px; }
        .marker-cluster-medium { width: 50px; height: 50px; font-size: 16px; }
        .marker-cluster-large { width: 60px; height: 60px; font-size: 18px; }
        
        .map-controls {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .map-control-btn {
            background: white;
            border: 2px solid #ccc;
            border-radius: 4px;
            padding: 8px 12px;
            display: flex;
            align-items: center;
            gap: 6px;
            cursor: pointer;
            font-size: 14px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.3);
            white-space: nowrap;
        }
        .map-control-btn:hover { background: #f5f5f5; border-color: #055193; }
        .map-control-btn img { width: 20px; height: 20px; pointer-events: none; }
        .map-control-btn.active { background: #4285F4; border-color: #4285F4; color: white; }
        
        .radius-value { font-size: 14px; color: #666; font-weight: 600; }
        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: #ddd;
            outline: none;
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #055193;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: #055193;
            cursor: pointer;
            border: none;
        }
        .map-popup {
            max-width: 320px;
        }
        .map-popup-hero { width: 100%; height: 140px; object-fit: cover; }
        .map-popup-content { padding: 12px; display: flex; gap: 12px; }
        .map-popup-logo { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
        .map-popup-info { flex: 1; min-width: 0; }
        .map-popup-badges { display: flex; gap: 4px; margin-bottom: 6px; flex-wrap: wrap; }
        .map-popup-title {
            font-weight: bold;
            font-size: 16px;
            color: #055193;
            margin-bottom: 4px;
            text-decoration: none;
            display: block;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .map-popup-title:hover { text-decoration: underline; }
        .map-popup-tagline { font-size: 13px; color: #666; margin-bottom: 8px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .map-popup-details { font-size: 12px; color: #444; line-height: 1.6; }
        
        .leaflet-popup-close-button {
            width: 30px !important;
            height: 30px !important;
            padding: 0 !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            top: 8px !important;
            right: 8px !important;
            background: rgba(255, 255, 255, 0.95) !important;
            border-radius: 50% !important;
            border: 2px solid #ccc !important;
            font-size: 24px !important;
            line-height: 1 !important;
            color: #666 !important;
        }
        .leaflet-popup-close-button:hover {
            background: #f0f0f0 !important;
            border-color: #999 !important;
            color: #333 !important;
        }
        
        .subcategory-tag {
            display: inline-block;
            padding: 4px 10px;
            margin: 4px;
            background: #e5e7eb;
            border-radius: 12px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
            user-select: none;
        }
        .subcategory-tag:hover { background: #d1d5db; }
        .subcategory-tag.selected { background: #055193; color: white; }
        
        .star-button {
            position: absolute;
            top: 8px;
            right: 8px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid #fbbf24;
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            z-index: 10;
        }
        .star-button:hover { background: #fbbf24; transform: scale(1.1); }
        .star-button.starred { background: #fbbf24; }
        .star-icon {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #78350f;
            stroke-width: 2;
            stroke-linejoin: round;
        }
        .star-button.starred .star-icon { fill: #78350f; }
        
        .split-view-container { display: flex; height: calc(100vh - 200px); }
        .split-view-listings { flex: 1; overflow-y: auto; padding: 16px; border-right: 2px solid #e5e7eb; }
        .split-view-map { flex: 1; position: relative; }
        .split-view-map #map { height: 100%; max-height: none; }
        
        .toggle-group {
            display: inline-flex;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            overflow: hidden;
        }
        .toggle-option {
            padding: 4px 12px;
            background: white;
            border: none;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .toggle-option:not(:last-child) { border-right: 1px solid #d1d5db; }
        .toggle-option:hover { background: #f3f4f6; }
        .toggle-option.active { background: #055193; color: white; }
        
        @media (min-width: 1024px) {
            .desktop-layout.with-left-filters { display: flex; gap: 24px; }
            .desktop-filters { width: 280px; flex-shrink: 0; }
            .desktop-content { flex: 1; min-width: 0; }
            #filterPanel.desktop-sidebar {
                display: block !important;
                position: sticky;
                top: 80px;
                height: fit-content;
                max-height: calc(100vh - 100px);
                border: 1px solid #e5e7eb;
                border-radius: 8px;
                padding: 16px;
                background: white;
            }
            .listings-2-col { grid-template-columns: repeat(2, 1fr) !important; }
            .listings-3-col { grid-template-columns: repeat(3, 1fr) !important; }
        }
        
        @media (max-width: 768px) {
            .split-view-container { flex-direction: column; }
            .split-view-listings { border-right: none; border-bottom: 2px solid #e5e7eb; max-height: 50%; }
            .map-control-btn span.desktop-only { display: none; }
        }
        
        @media (prefers-color-scheme: dark) {
            body { background: #1a1a1a; color: #e5e5e5; }
            header { background: #2a2a2a; border-color: #3a3a3a; }
            .bg-white { background: #2a2a2a !important; }
            .bg-gray-50 { background: #1a1a1a !important; }
            .bg-gray-100 { background: #3a3a3a !important; }
            .bg-gray-200 { background: #404040 !important; }
            .text-gray-900 { color: #e5e5e5 !important; }
            .text-gray-700 { color: #b0b0b0 !important; }
            .text-gray-600 { color: #999 !important; }
            .text-gray-500 { color: #888 !important; }
            .border-gray-300 { border-color: #404040 !important; }
            .border-gray-200 { border-color: #3a3a3a !important; }
            .shadow-sm, .shadow, .shadow-lg { box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.5) !important; }
            input, select { background: #2a2a2a !important; color: #e5e5e5 !important; }
            .hover\:bg-gray-50:hover { background: #3a3a3a !important; }
            .hover\:bg-gray-200:hover { background: #4a4a4a !important; }
            .map-popup { background: #2a2a2a; }
            .map-popup-title { color: #4a9fff; }
            .map-popup-tagline, .map-popup-details { color: #999; }
            .leaflet-popup-content-wrapper { background: #2a2a2a !important; color: #e5e5e5 !important; }
            .leaflet-popup-tip { background: #2a2a2a !important; }
            .map-loading { background: #2a2a2a; color: #e5e5e5; }
            .subcategory-tag { background: #404040; color: #e5e5e5; }
            .subcategory-tag:hover { background: #4a4a4a; }
            .subcategory-tag.selected { background: #055193; color: white; }
            .star-button { background: rgba(42, 42, 42, 0.9); }
            .split-view-listings { border-right-color: #404040; border-bottom-color: #404040; }
            .leaflet-tile { filter: brightness(0.6) invert(1) contrast(3) hue-rotate(200deg) saturate(0.3) brightness(0.7); }
        }

        .location-search-container { position: relative; }
        .location-search-results {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 8px 8px;
            max-height: 200px;
            overflow-y: auto;
            z-index: 10;
            display: none;
        }
        .location-search-result {
            padding: 8px 12px;
            cursor: pointer;
            transition: background 0.2s;
        }
        .location-search-result:hover {
            background: #f3f4f6;
        }
        .location-search-result.active {
            background: #055193;
            color: white;
        }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <img src="https://social.thegreekdirectory.org/Logo2.png" alt="The Greek Directory" class="h-12 w-auto">
                    <div>
                        <h1 class="text-xl font-bold" style="color: #055193;">The Greek Directory</h1>
                        <p class="text-xs text-gray-600" id="locationSubtitle">Loading...</p>
                    </div>
                </div>
                <button id="starredBtn" class="flex items-center gap-2 px-3 py-2 border border-gray-300 rounded-lg hover:bg-gray-50">
                    <svg class="star-icon" style="width: 18px; height: 18px;" viewBox="0 0 24 24">
                        <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                    </svg>
                    <span class="text-sm font-medium"><span class="hidden sm:inline">View </span>Starred</span>
                    <span id="starredCount" class="text-xs bg-gray-200 px-2 py-0.5 rounded-full">0</span>
                </button>
            </div>

            <div class="relative mb-4">
                <input type="text" id="searchInput" placeholder="Search businesses, churches, schools..." 
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" 
                    style="--tw-ring-color: #055193;">
            </div>

            <div class="flex items-center gap-2 overflow-x-auto pb-2 lg:hidden" id="mobileControls">
                <button id="filterBtn" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg whitespace-nowrap">
                    <span>üîç</span>
                    <span class="text-sm font-medium">Filters</span>
                </button>
                <button id="mapBtn" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg whitespace-nowrap">
                    <span>üó∫Ô∏è</span>
                    <span class="text-sm font-medium">Map</span>
                </button>
                <button id="refreshBtn" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg whitespace-nowrap" style="display: none;">
                    <span>üîÑ</span>
                </button>
                <div class="flex items-center gap-1 ml-auto bg-gray-100 rounded-lg p-1">
                    <button id="gridViewBtn" class="p-2 rounded bg-white shadow-sm"><span>‚äû</span></button>
                    <button id="listViewBtn" class="p-2 rounded"><span>‚ò∞</span></button>
                </div>
            </div>

            <div id="filterPanel" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden lg:hidden">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-900">Filters</h3>
                    <div class="flex gap-2">
                        <button id="clearFiltersBtn" class="text-sm text-blue-600 hover:text-blue-800">Clear All</button>
                        <button id="closeFilterBtn" class="text-gray-500 lg:hidden">‚úï</button>
                    </div>
                </div>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Search Categories & Subcategories</label>
                        <input type="text" id="categorySearch" placeholder="Type to search..." 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                        <div id="categoryFilters" class="grid grid-cols-2 gap-2"></div>
                    </div>
                    <div id="subcategoryContainer" class="hidden">
                        <div class="flex items-center justify-between mb-2">
                            <label class="block text-sm font-medium text-gray-700">Subcategories</label>
                            <div class="toggle-group">
                                <button class="toggle-option active" data-mode="any" onclick="setSubcategoryMode('any')">Any</button>
                                <button class="toggle-option" data-mode="all" onclick="setSubcategoryMode('all')">All</button>
                            </div>
                        </div>
                        <div id="subcategoryFilters" class="flex flex-wrap"></div>
                    </div>
                    <div class="space-y-2">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="openNowFilter" class="w-4 h-4">
                            <span class="text-sm font-medium text-gray-700">Open Now</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="closedNowFilter" class="w-4 h-4">
                            <span class="text-sm font-medium text-gray-700">Closed Now</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="openingSoonFilter" class="w-4 h-4">
                            <span class="text-sm font-medium text-gray-700">Opening Soon (60 min)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="closingSoonFilter" class="w-4 h-4">
                            <span class="text-sm font-medium text-gray-700">Closing Soon (60 min)</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="hoursUnknownFilter" class="w-4 h-4">
                            <span class="text-sm font-medium text-gray-700">Hours Unknown</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="onlineOnlyFilter" class="w-4 h-4">
                            <span class="text-sm font-medium text-gray-700">Online Only</span>
                        </label>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Radius: <span class="radius-value" id="radiusValue">Any distance</span></label>
                        <input type="range" id="radiusFilter" min="0" max="100" value="0" step="1" class="w-full">
                    </div>
                    <div class="location-search-container">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Location Search</label>
                        <input type="text" id="locationSearch" placeholder="City, State, Zip, or Country..." 
                            class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <div id="locationSearchResults" class="location-search-results"></div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                        <select id="countryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">All Countries</option>
                        </select>
                    </div>
                    <div id="stateFilterContainer" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                        <select id="stateFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                            <option value="">All States</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>
    </header>
    <div id="mapContainer" class="hidden border-b relative">
        <div class="map-loading" id="mapLoading">
            <div class="spinner"></div>
            <p class="text-sm text-gray-600 mt-2 text-center">Loading map...</p>
        </div>
        <div id="map"></div>
        <div class="map-controls">
            <button class="map-control-btn" id="splitViewBtn" title="Toggle split view">
                <span>‚äû</span>
                <span class="desktop-only">Split View</span>
            </button>
            <button class="map-control-btn" id="locateBtn" title="Find my location">
                <img src="https://help.apple.com/assets/68FABD5B6EF504342600E3E5/68FABD675A41CCC23909151C/en_US/7e877be3da64a66caf9a6dfb5fddad8f.png" alt="Location">
                <span class="desktop-only">Current Location</span>
            </button>
            <button class="map-control-btn" id="resetMapBtn" title="Reset map view">
                <span>üîÑ</span>
                <span class="desktop-only">Reload</span>
            </button>
        </div>
    </div>

    <div id="splitViewContainer" class="hidden"></div>

    <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="desktop-layout" id="desktopLayout">
            <div class="desktop-filters hidden" id="desktopFiltersContainer">
                <div id="desktopFilterPanel" class="desktop-sidebar">
                    <div class="flex items-center justify-between mb-3">
                        <h3 class="font-semibold text-gray-900">Filters</h3>
                        <button id="toggleFilterPosition" class="text-xs px-2 py-1 bg-gray-200 rounded hover:bg-gray-300" title="Toggle filter position">‚áÑ</button>
                    </div>
                    <button id="clearFiltersBtn2" class="text-sm text-blue-600 hover:text-blue-800 mb-4 block">Clear All</button>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                            <input type="text" id="categorySearch2" placeholder="Categories & subcategories..." 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm mb-2">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <div id="categoryFilters2" class="grid grid-cols-2 gap-2"></div>
                        </div>
                        <div id="subcategoryContainer2" class="hidden">
                            <div class="flex items-center justify-between mb-2">
                                <label class="block text-sm font-medium text-gray-700">Subcategories</label>
                                <div class="toggle-group">
                                    <button class="toggle-option active text-xs" data-mode="any" onclick="setSubcategoryMode('any')">Any</button>
                                    <button class="toggle-option text-xs" data-mode="all" onclick="setSubcategoryMode('all')">All</button>
                                </div>
                            </div>
                            <div id="subcategoryFilters2" class="flex flex-wrap"></div>
                        </div>
                        <div class="space-y-2">
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="openNowFilter2" class="w-4 h-4">
                                <span class="text-sm font-medium text-gray-700">Open Now</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="closedNowFilter2" class="w-4 h-4">
                                <span class="text-sm font-medium text-gray-700">Closed Now</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="openingSoonFilter2" class="w-4 h-4">
                                <span class="text-sm font-medium text-gray-700">Opening Soon</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="closingSoonFilter2" class="w-4 h-4">
                                <span class="text-sm font-medium text-gray-700">Closing Soon</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="hoursUnknownFilter2" class="w-4 h-4">
                                <span class="text-sm font-medium text-gray-700">Hours Unknown</span>
                            </label>
                            <label class="flex items-center gap-2 cursor-pointer">
                                <input type="checkbox" id="onlineOnlyFilter2" class="w-4 h-4">
                                <span class="text-sm font-medium text-gray-700">Online Only</span>
                            </label>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Radius: <span class="radius-value" id="radiusValue2">Any distance</span></label>
                            <input type="range" id="radiusFilter2" min="0" max="100" value="0" step="1" class="w-full">
                        </div>
                        <div class="location-search-container">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Location Search</label>
                            <input type="text" id="locationSearch2" placeholder="City, State, Zip, or Country..." 
                                class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                            <div id="locationSearchResults2" class="location-search-results"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                            <select id="countryFilter2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">All Countries</option>
                            </select>
                        </div>
                        <div id="stateFilterContainer2" class="hidden">
                            <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                            <select id="stateFilter2" class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                <option value="">All States</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="desktop-content">
                <div id="normalViewControls" class="flex items-center justify-between mb-4">
                    <p id="resultsCount" class="text-sm text-gray-600">Loading...</p>
                    <div class="flex items-center gap-2">
                        <button id="mapBtnDesktop" class="hidden lg:flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg whitespace-nowrap">
                            <span>üó∫Ô∏è</span>
                            <span class="text-sm font-medium">Map</span>
                        </button>
                        <div class="hidden lg:flex items-center gap-1 bg-gray-100 rounded-lg p-1">
                            <button id="gridViewBtn2" class="p-2 rounded bg-white shadow-sm"><span>‚äû</span></button>
                            <button id="listViewBtn2" class="p-2 rounded"><span>‚ò∞</span></button>
                        </div>
                        <select id="sortSelect" class="text-sm border border-gray-300 rounded-lg px-3 py-2">
                            <option value="default">Default</option>
                            <option value="az">A-Z</option>
                            <option value="closest">Closest to Me</option>
                        </select>
                    </div>
                </div>

                <div id="normalViewListings">
                    <div id="listingsContainer"></div>
                </div>
            </div>
        </div>
    </div>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    <script>
        const GITHUB_OWNER = 'thegreekdirectory';
        const GITHUB_REPO = 'listings';
        const DATABASE_PATH = 'listings-database.json';
        const CATEGORIES = [
            'Automotive & Transportation', 'Beauty & Health', 'Church & Religious Organization',
            'Cultural/Fraternal Organization', 'Education & Community', 'Entertainment, Arts & Recreation',
            'Food & Hospitality', 'Grocery & Imports', 'Home & Construction', 'Industrial & Manufacturing',
            'Pets & Veterinary', 'Professional & Business Services', 'Real Estate & Development', 'Retail & Shopping'
        ];

        const SUBCATEGORIES = {
            'Automotive & Transportation': ['Auto Detailer', 'Auto Repair Shop', 'Car Dealer', 'Taxi & Limo Service'],
            'Beauty & Health': ['Barbershops', 'Esthetician', 'Hair Salons', 'Nail Salon', 'Spas', 'Chiropractor', 'Dentist', 'Doctor', 'Nutritionist', 'Optometrist', 'Orthodontist', 'Physical Therapist', 'Physical Trainer'],
            'Church & Religious Organization': ['Church'],
            'Cultural/Fraternal Organization': ['Dance Troupe', 'Non-Profit', 'Philanthropic Group', 'Society', 'Youth Organization'],
            'Education & Community': ['Childcare', 'Greek School', 'Senior Care', 'Tutor'],
            'Entertainment, Arts & Recreation': ['Band', 'DJs', 'Entertainment Group', 'Photographer', 'Art'],
            'Food & Hospitality': ['Banquet Hall', 'Catering Service', 'Event Venue', 'Bakeries', 'Deli', 'Pastry Shop', 'Bar', 'Breakfast', 'Coffee', 'Lunch', 'Dinner', 'Restaurant', 'Hotel', 'Airbnb'],
            'Grocery & Imports': ['Butcher Shop', 'Liquor Shop', 'Market', 'Greek Alcohol', 'Honey', 'Olive Oil', 'Food Distribution', 'Food Manufacturer'],
            'Home & Construction': ['Carpenter', 'Electrician', 'General Contractor', 'Handyman', 'HVAC', 'Landscaping', 'Painter', 'Plumber', 'Roofing', 'Tile & Stone Specialist'],
            'Industrial & Manufacturing': ['Food Manufacturer'],
            'Pets & Veterinary': ['Veterinarian', 'Pet Accessories Maker'],
            'Professional & Business Services': ['Business Services', 'Consultant', 'CPA', 'Financial Advisor', 'Insurance Agent', 'IT Service & Repair', 'Lawyer', 'Marketing & Creative Agency', 'Notaries', 'Wedding Planner', 'Travel Agency'],
            'Real Estate & Development': ['Appraiser', 'Broker', 'Developer', 'Lender', 'Property Management', 'Real Estate Agent'],
            'Retail & Shopping': ['Boutique Shop', 'ECommerce', 'Jewelry', 'Souvenir Shop']
        };

        const US_STATES = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
            'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
            'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
            'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
            'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
            'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
            'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
            'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
            'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
            'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
        };

        let allListings = [], filteredListings = [], currentView = 'grid', selectedCategory = 'All';
        let selectedSubcategories = [], subcategoryMode = 'any', selectedCountry = '', selectedState = '';
        let selectedRadius = 0, openNowOnly = false, closedNowOnly = false, openingSoonOnly = false;
        let closingSoonOnly = false, hoursUnknownOnly = false, onlineOnly = false, userLocation = null;
        let map = null, mapOpen = false, splitViewActive = false, filtersOpen = false;
        let markerClusterGroup = null, defaultMapCenter = [41.8781, -87.6298], defaultMapZoom = 10;
        let userLocationMarker = null, mapReady = false, allListingsGeocoded = false;
        let starredListings = [], viewingStarredOnly = false, mapMoved = false, locationButtonActive = false;
        let filterPosition = 'left';
        let searchDebounceTimer = null;

        function loadStarredListings() {
            const stored = getCookie('starredListings');
            if (stored) {
                try { starredListings = JSON.parse(stored); } catch (e) { starredListings = []; }
            }
            updateStarredCount();
        }

        function saveStarredListings() {
            setCookie('starredListings', JSON.stringify(starredListings), 365);
            updateStarredCount();
        }

        function toggleStar(listingId, event) {
            if (event) { event.preventDefault(); event.stopPropagation(); }
            const index = starredListings.indexOf(listingId);
            if (index > -1) starredListings.splice(index, 1);
            else starredListings.push(listingId);
            saveStarredListings();
            renderListings();
        }

        function updateStarredCount() {
            document.getElementById('starredCount').textContent = starredListings.length;
        }

        function toggleStarredView() {
            viewingStarredOnly = !viewingStarredOnly;
            if (viewingStarredOnly) {
                if (starredListings.length === 0) {
                    alert('You haven\'t starred any listings yet!');
                    viewingStarredOnly = false;
                    return;
                }
                filteredListings = allListings.filter(l => starredListings.includes(l.id));
                document.getElementById('resultsCount').textContent = `${filteredListings.length} starred ${filteredListings.length === 1 ? 'listing' : 'listings'}`;
                document.getElementById('starredBtn').style.backgroundColor = '#fbbf24';
                document.getElementById('starredBtn').style.color = '#78350f';
            } else {
                applyFilters();
                document.getElementById('starredBtn').style.backgroundColor = '';
                document.getElementById('starredBtn').style.color = '';
            }
            renderListings();
            updateResultsCount();
        }

        function setCookie(name, value, days) {
            const expires = new Date(Date.now() + days * 864e5).toUTCString();
            document.cookie = name + '=' + encodeURIComponent(value) + '; expires=' + expires + '; path=/';
        }

        function getCookie(name) {
            return document.cookie.split('; ').reduce((r, v) => {
                const parts = v.split('=');
                return parts[0] === name ? decodeURIComponent(parts[1]) : r;
            }, '');
        }

        function isIOSWebApp() {
            return ('standalone' in window.navigator) && window.navigator.standalone;
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (isIOSWebApp()) document.getElementById('refreshBtn').style.display = 'flex';
            loadStarredListings();
            loadListings();
            setupEventListeners();
            createCategoryButtons();
            requestLocationOnLoad();
            loadFiltersFromURL();
            initMap();
            syncFilters();
            checkFilterPosition();
        });
        
        function checkFilterPosition() {
            const screenWidth = window.innerWidth;
            const toggleBtn = document.getElementById('toggleFilterPosition');
            const desktopLayout = document.getElementById('desktopLayout');
            const desktopFilters = document.getElementById('desktopFiltersContainer');
            const mapBtn = document.getElementById('mapBtnDesktop');
            const listingsContainer = document.getElementById('listingsContainer');
            
            if (screenWidth >= 1024) {
                toggleBtn.style.display = 'block';
                mapBtn.classList.remove('hidden');
                if (filterPosition === 'left') {
                    desktopLayout.classList.add('with-left-filters');
                    desktopFilters.classList.remove('hidden');
                    if (currentView === 'grid') {
                        listingsContainer.classList.remove('listings-3-col');
                        listingsContainer.classList.add('listings-2-col');
                    }
                } else {
                    desktopLayout.classList.remove('with-left-filters');
                    desktopFilters.classList.add('hidden');
                    if (currentView === 'grid') {
                        listingsContainer.classList.remove('listings-2-col');
                        listingsContainer.classList.add('listings-3-col');
                    }
                }
            } else {
                toggleBtn.style.display = 'none';
                desktopLayout.classList.remove('with-left-filters');
                desktopFilters.classList.add('hidden');
                mapBtn.classList.add('hidden');
                if (currentView === 'grid') {
                    listingsContainer.classList.remove('listings-2-col', 'listings-3-col');
                }
            }
        }
        function loadFiltersFromURL() {
            const urlParams = new URLSearchParams(window.location.search);
            const searchQuery = urlParams.get('q');
            if (searchQuery) document.getElementById('searchInput').value = searchQuery;
            
            const category = urlParams.get('category');
            if (category && CATEGORIES.includes(category)) selectedCategory = category;
            
            const subcategories = urlParams.get('subcategories');
            if (subcategories) selectedSubcategories = subcategories.split(',');
            
            const subMode = urlParams.get('submode');
            if (subMode === 'all' || subMode === 'any') {
                subcategoryMode = subMode;
                setSubcategoryMode(subMode, true);
            }
            
            const country = urlParams.get('country');
            if (country) {
                selectedCountry = country;
                document.getElementById('countryFilter').value = country;
                document.getElementById('countryFilter2').value = country;
                if (country === 'USA') {
                    document.getElementById('stateFilterContainer').classList.remove('hidden');
                    document.getElementById('stateFilterContainer2').classList.remove('hidden');
                    populateStateFilter('USA');
                }
            }
            
            const state = urlParams.get('state');
            if (state) {
                selectedState = state;
                document.getElementById('stateFilter').value = state;
                document.getElementById('stateFilter2').value = state;
            }
            
            const radius = urlParams.get('radius');
            if (radius) {
                selectedRadius = parseInt(radius);
                document.getElementById('radiusFilter').value = radius;
                document.getElementById('radiusFilter2').value = radius;
                updateRadiusValue();
            }
            
            if (urlParams.get('open') === 'true') {
                openNowOnly = true;
                document.getElementById('openNowFilter').checked = true;
                document.getElementById('openNowFilter2').checked = true;
            }
            
            if (urlParams.get('closed') === 'true') {
                closedNowOnly = true;
                document.getElementById('closedNowFilter').checked = true;
                document.getElementById('closedNowFilter2').checked = true;
            }
            
            if (urlParams.get('opening') === 'true') {
                openingSoonOnly = true;
                document.getElementById('openingSoonFilter').checked = true;
                document.getElementById('openingSoonFilter2').checked = true;
            }
            
            if (urlParams.get('closing') === 'true') {
                closingSoonOnly = true;
                document.getElementById('closingSoonFilter').checked = true;
                document.getElementById('closingSoonFilter2').checked = true;
            }
            
            if (urlParams.get('hours') === 'unknown') {
                hoursUnknownOnly = true;
                document.getElementById('hoursUnknownFilter').checked = true;
                document.getElementById('hoursUnknownFilter2').checked = true;
            }
            
            if (urlParams.get('online') === 'true') {
                onlineOnly = true;
                document.getElementById('onlineOnlyFilter').checked = true;
                document.getElementById('onlineOnlyFilter2').checked = true;
            }
        }

        function updateURL() {
            const url = new URL(window.location);
            const searchTerm = document.getElementById('searchInput').value;
            url.search = '';
            if (selectedCategory && selectedCategory !== 'All') url.searchParams.set('category', selectedCategory);
            if (selectedSubcategories.length > 0) {
                url.searchParams.set('subcategories', selectedSubcategories.join(','));
                url.searchParams.set('submode', subcategoryMode);
            }
            if (selectedCountry) url.searchParams.set('country', selectedCountry);
            if (selectedState) url.searchParams.set('state', selectedState);
            if (selectedRadius > 0) url.searchParams.set('radius', selectedRadius);
            if (openNowOnly) url.searchParams.set('open', 'true');
            if (closedNowOnly) url.searchParams.set('closed', 'true');
            if (openingSoonOnly) url.searchParams.set('opening', 'true');
            if (closingSoonOnly) url.searchParams.set('closing', 'true');
            if (hoursUnknownOnly) url.searchParams.set('hours', 'unknown');
            if (onlineOnly) url.searchParams.set('online', 'true');
            if (searchTerm) url.searchParams.set('q', searchTerm);
            window.history.replaceState({}, '', url);
        }

        function requestLocationOnLoad() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                        console.log('Location acquired:', userLocation);
                        if (!viewingStarredOnly) applyFilters();
                        if (map && mapOpen) addUserLocationMarker();
                    },
                    (error) => console.log('Location permission denied or unavailable:', error.message),
                    { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
                );
            }
        }

        function addUserLocationMarker() {
            if (!map || !userLocation) return;
            if (userLocationMarker) map.removeLayer(userLocationMarker);
            const userIcon = L.divIcon({
                html: '<div style="width: 16px; height: 16px; background: #4285F4; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 8px rgba(0,0,0,0.3);"></div>',
                className: '', iconSize: [22, 22], iconAnchor: [11, 11]
            });
            userLocationMarker = L.marker([userLocation.lat, userLocation.lng], {
                icon: userIcon, zIndexOffset: 1000
            }).addTo(map);
            userLocationMarker.bindPopup('<strong>Your Location</strong>');
        }

        window.setSubcategoryMode = function(mode, skipUpdate) {
            subcategoryMode = mode;
            document.querySelectorAll('.toggle-option').forEach(opt => {
                if (opt.dataset.mode === mode) opt.classList.add('active');
                else opt.classList.remove('active');
            });
            if (!skipUpdate) {
                updateURL();
                if (!viewingStarredOnly) applyFilters();
            }
        };

        async function loadListings() {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${DATABASE_PATH}`);
                const data = await response.json();
                allListings = data.listings.filter(l => l.visible !== false);
                filteredListings = [...allListings];
                populateCountryFilter();
                updateLocationSubtitle();
                applyFilters();
                updateResultsCount();
                geocodeAllListings();
            } catch (error) {
                console.error('Error loading listings:', error);
                document.getElementById('listingsContainer').innerHTML = 
                    '<p class="text-center text-gray-600 py-12">Error loading listings. Please try again.</p>';
            }
        }

        async function geocodeAllListings() {
            let geocodedCount = 0;
            for (let listing of allListings) {
                if (!listing.coordinates && listing.address && !isBasedIn(listing)) {
                    await geocodeListing(listing);
                    geocodedCount++;
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            allListingsGeocoded = true;
            if (map && mapReady) {
                hideMapLoading();
                updateMapMarkers();
            }
        }

        function isBasedIn(listing) {
            return listing.city && listing.state && !listing.address;
        }

        async function geocodeListing(listing) {
            const fullAddress = getFullAddress(listing);
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    listing.coordinates = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                }
            } catch (e) {
                console.error('Geocoding failed for', listing.businessName, e);
            }
        }

        function populateCountryFilter() {
            const countries = [...new Set(allListings.map(l => l.country || 'USA'))].sort();
            ['countryFilter', 'countryFilter2'].forEach(id => {
                const select = document.getElementById(id);
                select.innerHTML = '<option value="">All Countries</option>';
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country === 'USA' ? 'United States' : country;
                    select.appendChild(option);
                });
            });
        }

        function populateStateFilter(country) {
            if (country === 'USA') {
                const states = [...new Set(allListings.filter(l => (l.country || 'USA') === 'USA').map(l => l.state))].sort();
                ['stateFilter', 'stateFilter2'].forEach(id => {
                    const select = document.getElementById(id);
                    select.innerHTML = '<option value="">All States</option>';
                    states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state;
                        option.textContent = `${US_STATES[state] || state} (${state})`;
                        select.appendChild(option);
                    });
                });
            }
        }

        function updateLocationSubtitle() {
            const urlPath = window.location.pathname;
            const pathParts = urlPath.split('/').filter(p => p);
            let subtitle = 'All Listings';
            if (pathParts.length >= 2 && pathParts[0] === 'listings') {
                const country = pathParts[1].toUpperCase();
                if (country === 'USA' && pathParts.length >= 3) {
                    const state = pathParts[2].toUpperCase();
                    subtitle = `${US_STATES[state] || state}, United States Listings`;
                } else if (country === 'USA') {
                    subtitle = 'United States Listings';
                } else {
                    subtitle = `${country} Listings`;
                }
            }
            document.getElementById('locationSubtitle').textContent = subtitle;
        }

        function getFullAddress(listing) {
            if (listing.city && listing.state) {
                if (listing.address) {
                    return `${listing.address}, ${listing.city}, ${listing.state} ${listing.zipCode || ''}`.trim();
                } else {
                    return `${listing.city}, ${listing.state}`.trim();
                }
            }
            return listing.address || '';
        }
        function syncFilters() {
            const filterPairs = [
                'categorySearch', 'openNowFilter', 'closedNowFilter', 'openingSoonFilter',
                'closingSoonFilter', 'hoursUnknownFilter', 'onlineOnlyFilter', 'radiusFilter',
                'countryFilter', 'stateFilter', 'locationSearch'
            ];

            filterPairs.forEach(base => {
                const elem1 = document.getElementById(base);
                const elem2 = document.getElementById(base + '2');
                if (!elem1 || !elem2) return;
                
                elem1.addEventListener('input', () => { 
                    if (base.includes('Filter') && elem1.type === 'checkbox') {
                        elem2.checked = elem1.checked;
                    } else {
                        elem2.value = elem1.value;
                    }
                });
                elem1.addEventListener('change', () => {
                    if (base.includes('Filter') && elem1.type === 'checkbox') {
                        elem2.checked = elem1.checked;
                    } else {
                        elem2.value = elem1.value;
                    }
                });
                
                elem2.addEventListener('input', () => {
                    if (base.includes('Filter') && elem2.type === 'checkbox') {
                        elem1.checked = elem2.checked;
                    } else {
                        elem1.value = elem2.value;
                    }
                });
                elem2.addEventListener('change', () => {
                    if (base.includes('Filter') && elem2.type === 'checkbox') {
                        elem1.checked = elem2.checked;
                    } else {
                        elem1.value = elem2.value;
                    }
                });
            });
        }
        
        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', () => {
                updateURL();
                if (!viewingStarredOnly) applyFilters();
            });
            
            document.getElementById('filterBtn').addEventListener('click', toggleFilters);
            document.getElementById('closeFilterBtn').addEventListener('click', toggleFilters);
            document.getElementById('mapBtn').addEventListener('click', toggleMap);
            document.getElementById('mapBtnDesktop').addEventListener('click', toggleMap);
            document.getElementById('gridViewBtn').addEventListener('click', () => setView('grid'));
            document.getElementById('listViewBtn').addEventListener('click', () => setView('list'));
            document.getElementById('gridViewBtn2').addEventListener('click', () => setView('grid'));
            document.getElementById('listViewBtn2').addEventListener('click', () => setView('list'));
            document.getElementById('starredBtn').addEventListener('click', toggleStarredView);
            document.getElementById('splitViewBtn').addEventListener('click', toggleSplitView);
            document.getElementById('clearFiltersBtn').addEventListener('click', clearAllFilters);
            document.getElementById('clearFiltersBtn2').addEventListener('click', clearAllFilters);
            
            document.getElementById('refreshBtn').addEventListener('click', () => window.location.reload());
            
            document.getElementById('toggleFilterPosition').addEventListener('click', () => {
                filterPosition = filterPosition === 'left' ? 'top' : 'left';
                checkFilterPosition();
            });

            ['radiusFilter', 'radiusFilter2'].forEach(id => {
                const slider = document.getElementById(id);
                slider.addEventListener('input', (e) => {
                    selectedRadius = parseInt(e.target.value);
                    document.getElementById('radiusFilter').value = selectedRadius;
                    document.getElementById('radiusFilter2').value = selectedRadius;
                    updateRadiusValue();
                    updateURL();
                    if (!viewingStarredOnly) applyFilters();
                });
            });
            
            ['openNowFilter', 'openNowFilter2'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    openNowOnly = e.target.checked;
                    document.getElementById('openNowFilter').checked = openNowOnly;
                    document.getElementById('openNowFilter2').checked = openNowOnly;
                    updateURL();
                    if (!viewingStarredOnly) applyFilters();
                });
            });

            ['closedNowFilter', 'closedNowFilter2'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    closedNowOnly = e.target.checked;
                    document.getElementById('closedNowFilter').checked = closedNowOnly;
                    document.getElementById('closedNowFilter2').checked = closedNowOnly;
                    updateURL();
                    if (!viewingStarredOnly) applyFilters();
                });
            });

            ['openingSoonFilter', 'openingSoonFilter2'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    openingSoonOnly = e.target.checked;
                    document.getElementById('openingSoonFilter').checked = openingSoonOnly;
                    document.getElementById('openingSoonFilter2').checked = openingSoonOnly;
                    updateURL();
                    if (!viewingStarredOnly) applyFilters();
                });
            });

            ['closingSoonFilter', 'closingSoonFilter2'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    closingSoonOnly = e.target.checked;
                    document.getElementById('closingSoonFilter').checked = closingSoonOnly;
                    document.getElementById('closingSoonFilter2').checked = closingSoonOnly;
                    updateURL();
                    if (!viewingStarredOnly) applyFilters();
                });
            });

            ['hoursUnknownFilter', 'hoursUnknownFilter2'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    hoursUnknownOnly = e.target.checked;
                    document.getElementById('hoursUnknownFilter').checked = hoursUnknownOnly;
                    document.getElementById('hoursUnknownFilter2').checked = hoursUnknownOnly;
                    updateURL();
                    if (!viewingStarredOnly) applyFilters();
                });
            });
            
            ['onlineOnlyFilter', 'onlineOnlyFilter2'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    onlineOnly = e.target.checked;
                    document.getElementById('onlineOnlyFilter').checked = onlineOnly;
                    document.getElementById('onlineOnlyFilter2').checked = onlineOnly;
                    updateURL();
                    if (!viewingStarredOnly) applyFilters();
                });
            });
            
            document.getElementById('sortSelect').addEventListener('change', () => {
                if (!viewingStarredOnly) applyFilters();
                else renderListings();
            });
            
            ['countryFilter', 'countryFilter2'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    selectedCountry = e.target.value;
                    document.getElementById('countryFilter').value = selectedCountry;
                    document.getElementById('countryFilter2').value = selectedCountry;
                    if (selectedCountry === 'USA') {
                        document.getElementById('stateFilterContainer').classList.remove('hidden');
                        document.getElementById('stateFilterContainer2').classList.remove('hidden');
                        populateStateFilter('USA');
                    } else {
                        document.getElementById('stateFilterContainer').classList.add('hidden');
                        document.getElementById('stateFilterContainer2').classList.add('hidden');
                        selectedState = '';
                    }
                    updateURL();
                    if (!viewingStarredOnly) applyFilters();
                });
            });
            
            ['stateFilter', 'stateFilter2'].forEach(id => {
                document.getElementById(id).addEventListener('change', (e) => {
                    selectedState = e.target.value;
                    document.getElementById('stateFilter').value = selectedState;
                    document.getElementById('stateFilter2').value = selectedState;
                    updateURL();
                    if (!viewingStarredOnly) applyFilters();
                });
            });
            
            const locateBtn = document.getElementById('locateBtn');
            const locateImg = locateBtn.querySelector('img');
            locateBtn.addEventListener('click', () => {
                if (userLocation) {
                    locationButtonActive = true;
                    mapMoved = false;
                    locateImg.src = 'https://help.apple.com/assets/68FABD5B6EF504342600E3E5/68FABD675A41CCC23909151C/en_US/9c3d0cf36d7f9115a669db04944b08c3.png';
                    locateBtn.classList.add('active');
                    map.setView([userLocation.lat, userLocation.lng], 13);
                    addUserLocationMarker();
                } else {
                    requestLocationOnLoad();
                }
            });
            
            document.getElementById('resetMapBtn').addEventListener('click', () => {
                if (map) {
                    map.setView(defaultMapCenter, defaultMapZoom);
                    if (mapReady && allListingsGeocoded) updateMapMarkers();
                }
            });
            
            ['categorySearch', 'categorySearch2'].forEach(id => {
                document.getElementById(id).addEventListener('input', (e) => {
                    if (searchDebounceTimer) clearTimeout(searchDebounceTimer);
                    searchDebounceTimer = setTimeout(() => {
                        filterCategoriesAndSubcategories(e.target.value);
                    }, 300);
                });
            });

            setupLocationSearch();
            
            window.addEventListener('resize', checkFilterPosition);
        }
        function setupLocationSearch() {
            ['locationSearch', 'locationSearch2'].forEach(id => {
                const input = document.getElementById(id);
                const resultsId = id + 'Results';
                const resultsDiv = document.getElementById(resultsId);

                input.addEventListener('input', () => {
                    const query = input.value.toLowerCase().trim();
                    
                    if (id === 'locationSearch') {
                        document.getElementById('locationSearch2').value = input.value;
                    } else {
                        document.getElementById('locationSearch').value = input.value;
                    }

                    if (query.length < 2) {
                        resultsDiv.style.display = 'none';
                        return;
                    }

                    const matches = [];
                    const seen = new Set();

                    allListings.forEach(listing => {
                        const city = listing.city?.toLowerCase();
                        const state = listing.state?.toLowerCase();
                        const zip = listing.zipCode?.toLowerCase();
                        const country = (listing.country || 'USA').toLowerCase();

                        if (city && city.includes(query) && !seen.has(city)) {
                            matches.push({ type: 'city', value: listing.city, state: listing.state, display: `${listing.city}, ${listing.state}` });
                            seen.add(city);
                        }
                        if (state && state.includes(query) && !seen.has(state)) {
                            matches.push({ type: 'state', value: listing.state, display: US_STATES[listing.state] || listing.state });
                            seen.add(state);
                        }
                        if (zip && zip.includes(query) && !seen.has(zip)) {
                            matches.push({ type: 'zip', value: listing.zipCode, city: listing.city, state: listing.state, display: `${listing.zipCode} (${listing.city}, ${listing.state})` });
                            seen.add(zip);
                        }
                        if (country.includes(query) && !seen.has(country)) {
                            matches.push({ type: 'country', value: listing.country || 'USA', display: listing.country === 'USA' ? 'United States' : listing.country });
                            seen.add(country);
                        }
                    });

                    if (matches.length > 0) {
                        resultsDiv.innerHTML = matches.slice(0, 10).map(m => 
                            `<div class="location-search-result" data-type="${m.type}" data-value="${m.value}" data-state="${m.state || ''}" data-city="${m.city || ''}">${m.display}</div>`
                        ).join('');
                        resultsDiv.style.display = 'block';

                        resultsDiv.querySelectorAll('.location-search-result').forEach(elem => {
                            elem.addEventListener('click', () => {
                                const type = elem.dataset.type;
                                const value = elem.dataset.value;

                                if (type === 'city') {
                                    const state = elem.dataset.state;
                                    selectedCountry = 'USA';
                                    selectedState = state;
                                    document.getElementById('countryFilter').value = 'USA';
                                    document.getElementById('countryFilter2').value = 'USA';
                                    document.getElementById('stateFilterContainer').classList.remove('hidden');
                                    document.getElementById('stateFilterContainer2').classList.remove('hidden');
                                    populateStateFilter('USA');
                                    document.getElementById('stateFilter').value = state;
                                    document.getElementById('stateFilter2').value = state;
                                } else if (type === 'state') {
                                    selectedCountry = 'USA';
                                    selectedState = value;
                                    document.getElementById('countryFilter').value = 'USA';
                                    document.getElementById('countryFilter2').value = 'USA';
                                    document.getElementById('stateFilterContainer').classList.remove('hidden');
                                    document.getElementById('stateFilterContainer2').classList.remove('hidden');
                                    populateStateFilter('USA');
                                    document.getElementById('stateFilter').value = value;
                                    document.getElementById('stateFilter2').value = value;
                                } else if (type === 'zip') {
                                    const state = elem.dataset.state;
                                    selectedCountry = 'USA';
                                    selectedState = state;
                                    document.getElementById('countryFilter').value = 'USA';
                                    document.getElementById('countryFilter2').value = 'USA';
                                    document.getElementById('stateFilterContainer').classList.remove('hidden');
                                    document.getElementById('stateFilterContainer2').classList.remove('hidden');
                                    populateStateFilter('USA');
                                    document.getElementById('stateFilter').value = state;
                                    document.getElementById('stateFilter2').value = state;
                                } else if (type === 'country') {
                                    selectedCountry = value;
                                    selectedState = '';
                                    document.getElementById('countryFilter').value = value;
                                    document.getElementById('countryFilter2').value = value;
                                    if (value === 'USA') {
                                        document.getElementById('stateFilterContainer').classList.remove('hidden');
                                        document.getElementById('stateFilterContainer2').classList.remove('hidden');
                                        populateStateFilter('USA');
                                    } else {
                                        document.getElementById('stateFilterContainer').classList.add('hidden');
                                        document.getElementById('stateFilterContainer2').classList.add('hidden');
                                    }
                                }

                                input.value = '';
                                document.getElementById('locationSearch').value = '';
                                document.getElementById('locationSearch2').value = '';
                                resultsDiv.style.display = 'none';
                                updateURL();
                                if (!viewingStarredOnly) applyFilters();
                            });
                        });
                    } else {
                        resultsDiv.style.display = 'none';
                    }
                });

                input.addEventListener('blur', () => {
                    setTimeout(() => {
                        resultsDiv.style.display = 'none';
                    }, 200);
                });
            });
        }

        function clearAllFilters() {
            selectedCategory = 'All';
            selectedSubcategories = [];
            selectedCountry = '';
            selectedState = '';
            selectedRadius = 0;
            openNowOnly = false;
            closedNowOnly = false;
            openingSoonOnly = false;
            closingSoonOnly = false;
            hoursUnknownOnly = false;
            onlineOnly = false;
            
            document.getElementById('searchInput').value = '';
            ['categorySearch', 'categorySearch2'].forEach(id => document.getElementById(id).value = '');
            ['locationSearch', 'locationSearch2'].forEach(id => document.getElementById(id).value = '');
            ['countryFilter', 'countryFilter2'].forEach(id => document.getElementById(id).value = '');
            ['stateFilter', 'stateFilter2'].forEach(id => document.getElementById(id).value = '');
            document.getElementById('stateFilterContainer').classList.add('hidden');
            document.getElementById('stateFilterContainer2').classList.add('hidden');
            ['radiusFilter', 'radiusFilter2'].forEach(id => document.getElementById(id).value = '0');
            ['openNowFilter', 'openNowFilter2'].forEach(id => document.getElementById(id).checked = false);
            ['closedNowFilter', 'closedNowFilter2'].forEach(id => document.getElementById(id).checked = false);
            ['openingSoonFilter', 'openingSoonFilter2'].forEach(id => document.getElementById(id).checked = false);
            ['closingSoonFilter', 'closingSoonFilter2'].forEach(id => document.getElementById(id).checked = false);
            ['hoursUnknownFilter', 'hoursUnknownFilter2'].forEach(id => document.getElementById(id).checked = false);
            ['onlineOnlyFilter', 'onlineOnlyFilter2'].forEach(id => document.getElementById(id).checked = false);
            
            ['subcategoryContainer', 'subcategoryContainer2'].forEach(id => {
                document.getElementById(id).classList.add('hidden');
            });
            
            updateRadiusValue();
            updateURL();
            createCategoryButtons();
            if (!viewingStarredOnly) applyFilters();
        }
        
        function filterCategoriesAndSubcategories(searchTerm) {
            searchTerm = searchTerm.toLowerCase();
            
            const elem1 = document.getElementById('categorySearch');
            const elem2 = document.getElementById('categorySearch2');
            if (elem1) elem1.value = searchTerm;
            if (elem2) elem2.value = searchTerm;

            if (!searchTerm) {
                selectedSubcategories = [];
                updateSubcategoryDisplay();
                createCategoryButtons();
                if (!viewingStarredOnly) applyFilters();
                return;
            }
            
            const matchingSubcategories = [];
            const matchingCategories = new Set();
            
            Object.entries(SUBCATEGORIES).forEach(([category, subs]) => {
                subs.forEach(sub => {
                    if (sub.toLowerCase().includes(searchTerm)) {
                        matchingSubcategories.push({ category, subcategory: sub });
                        matchingCategories.add(category);
                    }
                });
            });

            CATEGORIES.forEach(cat => {
                if (cat.toLowerCase().includes(searchTerm)) {
                    matchingCategories.add(cat);
                }
            });

            createCategoryButtons(Array.from(matchingCategories));

            if (matchingSubcategories.length > 0) {
                updateSubcategoryDisplay(matchingSubcategories);
            } else {
                updateSubcategoryDisplay();
            }
            
            updateURL();
            if (!viewingStarredOnly) applyFilters();
        }

        function createCategoryButtons(filteredCategories) {
            const categoriesToShow = filteredCategories && filteredCategories.length > 0 ? filteredCategories : CATEGORIES;
            
            ['categoryFilters', 'categoryFilters2'].forEach(containerId => {
                const container = document.getElementById(containerId);
                if (!container) return;
                
                container.innerHTML = '';
                
                const allButton = document.createElement('button');
                allButton.className = selectedCategory === 'All' ? 
                    'px-3 py-2 rounded-lg text-sm font-medium text-white' : 
                    'px-3 py-2 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300';
                if (selectedCategory === 'All') allButton.style.backgroundColor = '#055193';
                allButton.textContent = 'All';
                allButton.onclick = () => filterByCategory('All');
                container.appendChild(allButton);
                
                categoriesToShow.forEach(cat => {
                    const button = document.createElement('button');
                    button.className = selectedCategory === cat ? 
                        'px-3 py-2 rounded-lg text-sm font-medium text-white' : 
                        'px-3 py-2 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300 text-left';
                    if (selectedCategory === cat) button.style.backgroundColor = '#055193';
                    button.textContent = cat;
                    button.onclick = () => filterByCategory(cat);
                    container.appendChild(button);
                });
            });
        }
        
        function updateRadiusValue() {
            ['radiusValue', 'radiusValue2'].forEach(id => {
                const valueSpan = document.getElementById(id);
                if (selectedRadius === 0) {
                    valueSpan.textContent = 'Any distance';
                } else {
                    valueSpan.textContent = `${selectedRadius} ${selectedRadius === 1 ? 'mile' : 'miles'}`;
                }
            });
        }
        
        function filterByCategory(category) {
            selectedCategory = category || 'All';
            selectedSubcategories = [];
            
            createCategoryButtons();
            updateSubcategoryDisplay();
            updateURL();
            if (!viewingStarredOnly) applyFilters();
        }
        function updateSubcategoryDisplay(matchingSubcategories) {
            if (selectedCategory && selectedCategory !== 'All' && SUBCATEGORIES[selectedCategory]) {
                ['subcategoryContainer', 'subcategoryContainer2'].forEach((containerId, idx) => {
                    const filtersId = idx === 0 ? 'subcategoryFilters' : 'subcategoryFilters2';
                    document.getElementById(containerId).classList.remove('hidden');
                    const filtersDiv = document.getElementById(filtersId);
                    filtersDiv.innerHTML = '';
                    SUBCATEGORIES[selectedCategory].forEach(sub => {
                        const tag = document.createElement('div');
                        tag.className = 'subcategory-tag';
                        tag.textContent = sub;
                        if (selectedSubcategories.includes(sub)) {
                            tag.classList.add('selected');
                        }
                        tag.onclick = () => toggleSubcategory(sub);
                        filtersDiv.appendChild(tag);
                    });
                });
            } else if (matchingSubcategories && matchingSubcategories.length > 0) {
                ['subcategoryContainer', 'subcategoryContainer2'].forEach((containerId, idx) => {
                    const filtersId = idx === 0 ? 'subcategoryFilters' : 'subcategoryFilters2';
                    document.getElementById(containerId).classList.remove('hidden');
                    const filtersDiv = document.getElementById(filtersId);
                    filtersDiv.innerHTML = '';
                    
                    matchingSubcategories.forEach(item => {
                        const tag = document.createElement('div');
                        tag.className = 'subcategory-tag';
                        tag.textContent = `${item.subcategory} (${item.category})`;
                        if (selectedSubcategories.includes(item.subcategory)) {
                            tag.classList.add('selected');
                        }
                        tag.onclick = () => toggleSubcategory(item.subcategory);
                        filtersDiv.appendChild(tag);
                    });
                });
            } else {
                ['subcategoryContainer', 'subcategoryContainer2'].forEach(id => {
                    document.getElementById(id).classList.add('hidden');
                });
            }
        }
        
        function toggleSubcategory(subcategory) {
            const index = selectedSubcategories.indexOf(subcategory);
            if (index > -1) {
                selectedSubcategories.splice(index, 1);
            } else {
                selectedSubcategories.push(subcategory);
            }
            
            updateSubcategoryDisplay();
            updateURL();
            if (!viewingStarredOnly) applyFilters();
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 3959;
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c;
        }

        function normalizeString(str) {
            return str.toLowerCase().replace(/[^\w\s]/g, '').replace(/\s+/g, ' ').trim();
        }

        function isOpenNow(hours) {
            if (!hours || typeof hours !== 'object' || Object.keys(hours).length === 0) return null;
            const hasAnyHours = Object.values(hours).some(h => h && h.trim() !== '');
            if (!hasAnyHours) return null;
            const now = new Date();
            const centralTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = days[centralTime.getDay()];
            const todayHours = hours[today];
            if (!todayHours || todayHours.toLowerCase() === 'closed') return false;
            const match = todayHours.match(/(\d{1,2}):(\d{2})\s*(AM|PM)\s*-\s*(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) return null;
            const [, startHour, startMin, startPeriod, endHour, endMin, endPeriod] = match;
            let start = parseInt(startHour);
            let end = parseInt(endHour);
            if (startPeriod.toUpperCase() === 'PM' && start !== 12) start += 12;
            if (startPeriod.toUpperCase() === 'AM' && start === 12) start = 0;
            if (endPeriod.toUpperCase() === 'PM' && end !== 12) end += 12;
            if (endPeriod.toUpperCase() === 'AM' && end === 12) end = 0;
            const currentMinutes = centralTime.getHours() * 60 + centralTime.getMinutes();
            const startMinutes = start * 60 + parseInt(startMin);
            const endMinutes = end * 60 + parseInt(endMin);
            return currentMinutes >= startMinutes && currentMinutes <= endMinutes;
        }

        function isOpeningSoon(hours) {
            if (!hours || typeof hours !== 'object') return false;
            const now = new Date();
            const centralTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = days[centralTime.getDay()];
            const todayHours = hours[today];
            if (!todayHours || todayHours.toLowerCase() === 'closed') return false;
            const match = todayHours.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) return false;
            const [, startHour, startMin, startPeriod] = match;
            let start = parseInt(startHour);
            if (startPeriod.toUpperCase() === 'PM' && start !== 12) start += 12;
            if (startPeriod.toUpperCase() === 'AM' && start === 12) start = 0;
            const currentMinutes = centralTime.getHours() * 60 + centralTime.getMinutes();
            const startMinutes = start * 60 + parseInt(startMin);
            const diff = startMinutes - currentMinutes;
            return diff > 0 && diff <= 60;
        }

        function isClosingSoon(hours) {
            if (!hours || typeof hours !== 'object') return false;
            const now = new Date();
            const centralTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = days[centralTime.getDay()];
            const todayHours = hours[today];
            if (!todayHours || todayHours.toLowerCase() === 'closed') return false;
            const match = todayHours.match(/(\d{1,2}):(\d{2})\s*(AM|PM)\s*-\s*(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) return false;
            const [, , , , endHour, endMin, endPeriod] = match;
            let end = parseInt(endHour);
            if (endPeriod.toUpperCase() === 'PM' && end !== 12) end += 12;
            if (endPeriod.toUpperCase() === 'AM' && end === 12) end = 0;
            const currentMinutes = centralTime.getHours() * 60 + centralTime.getMinutes();
            const endMinutes = end * 60 + parseInt(endMin);
            const diff = endMinutes - currentMinutes;
            return diff > 0 && diff <= 60;
        }

        function hasUnknownHours(listing) {
            if (!listing.address || isBasedIn(listing)) return false;
            if (!listing.hours || typeof listing.hours !== 'object') return true;
            const hasAnyHours = Object.values(listing.hours).some(h => h && h.trim() !== '');
            if (!hasAnyHours) return true;
            const now = new Date();
            const centralTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = days[centralTime.getDay()];
            const todayHours = listing.hours[today];
            return !todayHours || todayHours.trim() === '';
        }
        function applyFilters() {
            const searchTerm = normalizeString(document.getElementById('searchInput').value);
            const sortOption = document.getElementById('sortSelect').value;
            
            filteredListings = allListings.filter(listing => {
                const fullAddress = getFullAddress(listing);
                const normalizedName = normalizeString(listing.businessName);
                const normalizedTagline = normalizeString(listing.tagline || '');
                const normalizedDescription = normalizeString(listing.description);
                const normalizedAddress = normalizeString(fullAddress);
                
                const matchesSearch = !searchTerm || 
                    normalizedName.includes(searchTerm) ||
                    normalizedTagline.includes(searchTerm) ||
                    normalizedDescription.includes(searchTerm) ||
                    normalizedAddress.includes(searchTerm);
                    
                const matchesCategory = selectedCategory === 'All' || listing.category === selectedCategory;
                
                let matchesSubcategory = true;
                if (selectedSubcategories.length > 0 && listing.subcategories) {
                    if (subcategoryMode === 'all') {
                        matchesSubcategory = selectedSubcategories.every(sub => listing.subcategories.includes(sub));
                    } else {
                        matchesSubcategory = selectedSubcategories.some(sub => listing.subcategories.includes(sub));
                    }
                } else if (selectedSubcategories.length > 0) {
                    matchesSubcategory = false;
                }
                
                const matchesCountry = !selectedCountry || (listing.country || 'USA') === selectedCountry;
                const matchesState = !selectedState || listing.state === selectedState;
                
                let matchesRadius = true;
                if (selectedRadius > 0) {
                    if (!userLocation) {
                        matchesRadius = true;
                    } else if (!listing.coordinates) {
                        matchesRadius = false;
                    } else {
                        const distance = calculateDistance(
                            userLocation.lat, userLocation.lng,
                            listing.coordinates.lat, listing.coordinates.lng
                        );
                        matchesRadius = distance <= selectedRadius;
                    }
                }
                
                const openStatus = isOpenNow(listing.hours);
                const matchesOpenNow = !openNowOnly || openStatus === true;
                const matchesClosedNow = !closedNowOnly || openStatus === false;
                const matchesOpeningSoon = !openingSoonOnly || isOpeningSoon(listing.hours);
                const matchesClosingSoon = !closingSoonOnly || isClosingSoon(listing.hours);
                const matchesHoursUnknown = !hoursUnknownOnly || hasUnknownHours(listing);
                const matchesOnlineOnly = !onlineOnly || isBasedIn(listing);
                
                return matchesSearch && matchesCategory && matchesSubcategory && matchesCountry && 
                       matchesState && matchesRadius && matchesOpenNow && matchesClosedNow &&
                       matchesOpeningSoon && matchesClosingSoon && matchesHoursUnknown && matchesOnlineOnly;
            });
            
            if (userLocation && sortOption === 'closest') {
                filteredListings.forEach(listing => {
                    if (listing.coordinates) {
                        listing._distance = calculateDistance(
                            userLocation.lat, userLocation.lng,
                            listing.coordinates.lat, listing.coordinates.lng
                        );
                    } else {
                        listing._distance = Infinity;
                    }
                });
            }
            
            filteredListings.sort((a, b) => {
                if (sortOption === 'default') {
                    const aTier = a.tier || 'FREE';
                    const bTier = b.tier || 'FREE';
                    const tierPriority = { PREMIUM: 3, FEATURED: 2, VERIFIED: 1, FREE: 0 };
                    if (tierPriority[aTier] !== tierPriority[bTier]) {
                        return tierPriority[bTier] - tierPriority[aTier];
                    }
                    const aOpen = isOpenNow(a.hours);
                    const bOpen = isOpenNow(b.hours);
                    if (aOpen !== bOpen) {
                        if (aOpen === null && bOpen !== null) return 1;
                        if (bOpen === null && aOpen !== null) return -1;
                        return bOpen ? 1 : -1;
                    }
                    return a.businessName.localeCompare(b.businessName);
                } else if (sortOption === 'az') {
                    return a.businessName.localeCompare(b.businessName);
                } else if (sortOption === 'closest') {
                    return (a._distance || Infinity) - (b._distance || Infinity);
                }
                return 0;
            });
            
            renderListings();
            updateResultsCount();
            if (map) updateMapMarkers();
        }

        function toggleFilters() {
            const panel = document.getElementById('filterPanel');
            filtersOpen = !filtersOpen;
            if (filtersOpen) {
                panel.classList.remove('hidden');
                if (mapOpen) toggleMap();
            } else {
                panel.classList.add('hidden');
            }
        }

        function toggleMap() {
            const container = document.getElementById('mapContainer');
            mapOpen = !mapOpen;
            if (mapOpen) {
                container.classList.remove('hidden');
                if (filtersOpen) toggleFilters();
                if (splitViewActive) toggleSplitView();
                if (map) {
                    setTimeout(() => {
                        map.invalidateSize();
                        updateMapMarkers();
                        if (userLocation) addUserLocationMarker();
                        if (allListingsGeocoded) hideMapLoading();
                    }, 100);
                }
            } else {
                container.classList.add('hidden');
            }
        }

        function toggleSplitView() {
            splitViewActive = !splitViewActive;
            if (splitViewActive) {
                document.getElementById('normalViewControls').classList.add('hidden');
                document.getElementById('normalViewListings').classList.add('hidden');
                document.getElementById('mapContainer').classList.add('hidden');
                const splitContainer = document.getElementById('splitViewContainer');
                splitContainer.classList.remove('hidden');
                splitContainer.className = 'split-view-container';
                splitContainer.innerHTML = `
                    <div class="split-view-listings">
                        <div class="mb-4 flex items-center justify-between">
                            <p class="text-sm text-gray-600">${filteredListings.length} ${filteredListings.length === 1 ? 'listing' : 'listings'} found</p>
                            <select id="splitSortSelect" class="text-sm border border-gray-300 rounded-lg px-3 py-2">
                                <option value="default">Default</option>
                                <option value="az">A-Z</option>
                                <option value="closest">Closest to Me</option>
                            </select>
                        </div>
                        <div id="splitListingsContainer"></div>
                    </div>
                    <div class="split-view-map"><div id="splitMap"></div></div>
                `;
                document.getElementById('splitSortSelect').value = document.getElementById('sortSelect').value;
                document.getElementById('splitSortSelect').addEventListener('change', (e) => {
                    document.getElementById('sortSelect').value = e.target.value;
                    if (!viewingStarredOnly) applyFilters();
                    else renderListings();
                });
                renderSplitViewListings();
                initSplitMap();
            } else {
                document.getElementById('splitViewContainer').classList.add('hidden');
                document.getElementById('splitViewContainer').innerHTML = '';
                document.getElementById('normalViewControls').classList.remove('hidden');
                document.getElementById('normalViewListings').classList.remove('hidden');
                document.getElementById('mapContainer').classList.remove('hidden');
                setTimeout(() => {
                    if (map) {
                        map.invalidateSize();
                        updateMapMarkers();
                    }
                }, 100);
            }
        }
        
        function showMapLoading() {
            const loading = document.getElementById('mapLoading');
            if (loading) loading.style.display = 'block';
        }
        
        function hideMapLoading() {
            const loading = document.getElementById('mapLoading');
            if (loading) loading.style.display = 'none';
        }

        function setView(view) {
            currentView = view;
            document.getElementById('gridViewBtn').className = view === 'grid' ? 'p-2 rounded bg-white shadow-sm' : 'p-2 rounded';
            document.getElementById('listViewBtn').className = view === 'list' ? 'p-2 rounded bg-white shadow-sm' : 'p-2 rounded';
            document.getElementById('gridViewBtn2').className = view === 'grid' ? 'p-2 rounded bg-white shadow-sm' : 'p-2 rounded';
            document.getElementById('listViewBtn2').className = view === 'list' ? 'p-2 rounded bg-white shadow-sm' : 'p-2 rounded';
            renderListings();
        }

        function updateResultsCount() {
            const count = filteredListings.length;
            if (!viewingStarredOnly) {
                document.getElementById('resultsCount').textContent = `${count} ${count === 1 ? 'listing' : 'listings'} found${selectedCategory !== 'All' ? ` in ${selectedCategory}` : ''}`;
            }
        }
        function renderListings() {
            const container = document.getElementById('listingsContainer');
            if (filteredListings.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-600 py-12">No listings found.</p>';
                return;
            }

            if (currentView === 'grid') {
                const screenWidth = window.innerWidth;
                let gridClass = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                
                if (screenWidth >= 1024) {
                    if (filterPosition === 'left') {
                        gridClass = 'grid grid-cols-1 md:grid-cols-2 gap-6 listings-2-col';
                    } else {
                        gridClass = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 listings-3-col';
                    }
                }
                
                container.className = gridClass;
                container.innerHTML = filteredListings.map(l => {
                    const firstPhoto = l.photos && l.photos.length > 0 ? l.photos[0] : l.logo;
                    const fullAddress = getFullAddress(l);
                    const categorySlug = l.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                    const listingUrl = `/listings/${categorySlug}/${l.slug}`;
                    const badges = [];
                    
                    const openStatus = isOpenNow(l.hours);
                    if (openStatus === true) badges.push('<span class="badge badge-open">Open</span>');
                    else if (openStatus === false) badges.push('<span class="badge badge-closed">Closed</span>');
                    if (isOpeningSoon(l.hours)) badges.push('<span class="badge badge-opening-soon">Opening Soon</span>');
                    if (isClosingSoon(l.hours)) badges.push('<span class="badge badge-closing-soon">Closing Soon</span>');
                    if (hasUnknownHours(l)) badges.push('<span class="badge badge-hours-unknown">Hours Unknown</span>');
                    
                    if (l.tier === 'FEATURED' || l.tier === 'PREMIUM') badges.push('<span class="badge badge-featured">Featured</span>');
                    if (l.verified) badges.push('<span class="badge badge-verified">Verified</span>');
                    if (!l.showClaimButton && l.tier === 'FREE') badges.push('<span class="badge badge-claimed">Claimed</span>');
                    
                    const isStarred = starredListings.includes(l.id);
                    
                    return `
                        <a href="${listingUrl}" class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow overflow-hidden block relative">
                            <button class="star-button ${isStarred ? 'starred' : ''}" onclick="toggleStar('${l.id}', event)">
                                <svg class="star-icon" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                            </button>
                            <div class="h-48 bg-gray-200 relative">
                                <img src="${firstPhoto}" alt="${l.businessName}" class="w-full h-full object-cover">
                                ${badges.length > 0 ? `<div class="absolute top-2 left-2 flex gap-2 flex-wrap">${badges.join('')}</div>` : ''}
                            </div>
                            <div class="p-4">
                                <div class="flex gap-3 mb-3">
                                    <img src="${l.logo}" alt="${l.businessName} logo" class="w-16 h-16 rounded object-cover flex-shrink-0">
                                    <div class="flex-1 min-w-0">
                                        <span class="text-xs font-semibold px-2 py-1 rounded-full text-white block w-fit mb-2" style="background-color:#055193;">${l.category}</span>
                                        <h3 class="text-lg font-bold text-gray-900 line-clamp-1">${l.businessName}</h3>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 mb-3 line-clamp-2">${l.tagline || l.description}</p>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div class="flex items-center gap-2">
                                        <span>üìç</span>
                                        <span class="truncate">${fullAddress}</span>
                                    </div>
                                    ${l.phone ? `<div class="flex items-center gap-2"><span>üìû</span><span class="truncate">${l.phone}</span></div>` : ''}
                                </div>
                            </div>
                        </a>
                    `;
                }).join('');
            } else {
                container.className = 'space-y-4';
                container.innerHTML = filteredListings.map(l => {
                    const fullAddress = getFullAddress(l);
                    const categorySlug = l.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                    const listingUrl = `/listings/${categorySlug}/${l.slug}`;
                    const badges = [];
                    
                    const openStatus = isOpenNow(l.hours);
                    if (openStatus === true) badges.push('<span class="badge badge-open">Open</span>');
                    else if (openStatus === false) badges.push('<span class="badge badge-closed">Closed</span>');
                    if (isOpeningSoon(l.hours)) badges.push('<span class="badge badge-opening-soon">Opening Soon</span>');
                    if (isClosingSoon(l.hours)) badges.push('<span class="badge badge-closing-soon">Closing Soon</span>');
                    if (hasUnknownHours(l)) badges.push('<span class="badge badge-hours-unknown">Hours Unknown</span>');
                    
                    if (l.tier === 'FEATURED' || l.tier === 'PREMIUM') badges.push('<span class="badge badge-featured">Featured</span>');
                    if (l.verified) badges.push('<span class="badge badge-verified">Verified</span>');
                    if (!l.showClaimButton && l.tier === 'FREE') badges.push('<span class="badge badge-claimed">Claimed</span>');
                    
                    const isStarred = starredListings.includes(l.id);
                    
                    return `
                        <a href="${listingUrl}" class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow p-4 flex gap-4 block relative">
                            <button class="star-button ${isStarred ? 'starred' : ''}" onclick="toggleStar('${l.id}', event)" style="top: 12px; right: 12px;">
                                <svg class="star-icon" viewBox="0 0 24 24">
                                    <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                                </svg>
                            </button>
                            <img src="${l.logo}" alt="${l.businessName}" class="w-24 h-24 rounded-lg object-cover flex-shrink-0">
                            <div class="flex-1 min-w-0 overflow-hidden pr-12">
                                <div class="flex gap-2 mb-2 flex-wrap">
                                    <span class="text-xs font-semibold px-2 py-1 rounded-full text-white" style="background-color:#055193;">${l.category}</span>
                                    ${badges.join('')}
                                </div>
                                <h3 class="text-lg font-bold text-gray-900 mb-1 truncate">${l.businessName}</h3>
                                <p class="text-sm text-gray-600 mb-2 line-clamp-1">${l.tagline || l.description}</p>
                                <div class="flex flex-col gap-1 text-sm text-gray-600">
                                    <div class="flex items-center gap-1">
                                        <span>üìç</span>
                                        <span class="truncate">${fullAddress}</span>
                                    </div>
                                    ${l.phone ? `<div class="flex items-center gap-1"><span>üìû</span><span class="truncate">${l.phone}</span></div>` : ''}
                                </div>
                            </div>
                        </a>
                    `;
                }).join('');
            }
        }

        function renderSplitViewListings() {
            const container = document.getElementById('splitListingsContainer');
            if (!container) return;
            if (filteredListings.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-600 py-12">No listings found.</p>';
                return;
            }
            container.className = 'space-y-3';
            container.innerHTML = filteredListings.map(l => {
                const fullAddress = getFullAddress(l);
                const categorySlug = l.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                const listingUrl = `/listings/${categorySlug}/${l.slug}`;
                const badges = [];
                
                const openStatus = isOpenNow(l.hours);
                if (openStatus === true) badges.push('<span class="badge badge-open">Open</span>');
                else if (openStatus === false) badges.push('<span class="badge badge-closed">Closed</span>');
                if (isOpeningSoon(l.hours)) badges.push('<span class="badge badge-opening-soon">Opening Soon</span>');
                if (isClosingSoon(l.hours)) badges.push('<span class="badge badge-closing-soon">Closing Soon</span>');
                if (hasUnknownHours(l)) badges.push('<span class="badge badge-hours-unknown">Hours Unknown</span>');
                
                if (l.tier === 'FEATURED' || l.tier === 'PREMIUM') badges.push('<span class="badge badge-featured">Featured</span>');
                if (l.verified) badges.push('<span class="badge badge-verified">Verified</span>');
                if (!l.showClaimButton && l.tier === 'FREE') badges.push('<span class="badge badge-claimed">Claimed</span>');
                
                const isStarred = starredListings.includes(l.id);
                
                return `
                    <a href="${listingUrl}" class="bg-white rounded-lg shadow hover:shadow-lg transition-shadow p-3 flex gap-3 block relative" style="margin-right: 8px;">
                        <button class="star-button ${isStarred ? 'starred' : ''}" onclick="toggleStar('${l.id}', event)" style="top: 8px; right: 8px; width: 32px; height: 32px;">
                            <svg class="star-icon" style="width: 16px; height: 16px;" viewBox="0 0 24 24">
                                <path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/>
                            </svg>
                        </button>
                        <img src="${l.logo}" alt="${l.businessName}" class="w-16 h-16 rounded-lg object-cover flex-shrink-0">
                        <div class="flex-1 min-w-0 overflow-hidden pr-8">
                            <div class="flex gap-1 mb-1 flex-wrap">
                                ${badges.join('')}
                            </div>
                            <h3 class="text-base font-bold text-gray-900 mb-1 truncate">${l.businessName}</h3>
                            <p class="text-xs text-gray-600 mb-1 truncate">${l.tagline || l.description}</p>
                            <div class="text-xs text-gray-600">
                                <div class="flex items-center gap-1 truncate">
                                    <span>üìç</span>
                                    <span class="truncate">${fullAddress}</span>
                                </div>
                            </div>
                        </div>
                    </a>
                `;
            }).join('');
        }

        window.toggleStar = toggleStar;
        function initMap() {
            if (map) return;
            showMapLoading();
            map = L.map('map', { center: defaultMapCenter, zoom: defaultMapZoom, zoomControl: true });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: null, maxZoom: 19
            }).addTo(map);
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 50,
                disableClusteringAtZoom: 18,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count >= 10) size = 'medium';
                    if (count >= 50) size = 'large';
                    return L.divIcon({
                        html: `<div class="marker-cluster marker-cluster-${size}">${count}</div>`,
                        className: '',
                        iconSize: size === 'small' ? [40, 40] : size === 'medium' ? [50, 50] : [60, 60]
                    });
                }
            });
            map.addLayer(markerClusterGroup);
            if (userLocation) addUserLocationMarker();
            map.on('movestart', () => {
                if (locationButtonActive && !mapMoved) {
                    mapMoved = true;
                    locationButtonActive = false;
                    const locateBtn = document.getElementById('locateBtn');
                    const locateImg = locateBtn.querySelector('img');
                    locateImg.src = 'https://help.apple.com/assets/68FABD5B6EF504342600E3E5/68FABD675A41CCC23909151C/en_US/7e877be3da64a66caf9a6dfb5fddad8f.png';
                    locateBtn.classList.remove('active');
                }
            });
            setTimeout(() => {
                map.invalidateSize();
                mapReady = true;
                updateMapMarkers();
                if (allListingsGeocoded) hideMapLoading();
            }, 500);
        }

        function initSplitMap() {
            const splitMapDiv = document.getElementById('splitMap');
            if (!splitMapDiv) return;
            const splitMap = L.map('splitMap', { center: defaultMapCenter, zoom: defaultMapZoom, zoomControl: true });
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: null, maxZoom: 19
            }).addTo(splitMap);
            const splitMarkerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 50, disableClusteringAtZoom: 18, spiderfyOnMaxZoom: true,
                showCoverageOnHover: false, zoomToBoundsOnClick: true,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = count >= 50 ? 'large' : count >= 10 ? 'medium' : 'small';
                    return L.divIcon({
                        html: `<div class="marker-cluster marker-cluster-${size}">${count}</div>`,
                        className: '', iconSize: size === 'small' ? [40, 40] : size === 'medium' ? [50, 50] : [60, 60]
                    });
                }
            });
            splitMap.addLayer(splitMarkerClusterGroup);
            if (userLocation) {
                const userIcon = L.divIcon({
                    html: '<div style="width: 16px; height: 16px; background: #4285F4; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 8px rgba(0,0,0,0.3);"></div>',
                    className: '', iconSize: [22, 22], iconAnchor: [11, 11]
                });
                L.marker([userLocation.lat, userLocation.lng], {
                    icon: userIcon, zIndexOffset: 1000
                }).addTo(splitMap).bindPopup('<strong>Your Location</strong>');
            }
            const bounds = [];
            filteredListings.forEach(listing => {
                if (listing.coordinates && !isBasedIn(listing)) {
                    const openStatus = isOpenNow(listing.hours);
                    const isFeatured = listing.tier === 'FEATURED' || listing.tier === 'PREMIUM';
                    const iconClass = isFeatured ? 'custom-marker featured' : 'custom-marker';
                    const iconHtml = `<div class="${iconClass}"><img src="${listing.logo}" alt="${listing.businessName}"></div>`;
                    const customIcon = L.divIcon({ html: iconHtml, className: '', iconSize: [40, 40], iconAnchor: [20, 20] });
                    const marker = L.marker([listing.coordinates.lat, listing.coordinates.lng], { icon: customIcon, riseOnHover: true });
                    const badges = [];
                    
                    if (openStatus === true) badges.push('<span class="badge badge-open">Open</span>');
                    else if (openStatus === false) badges.push('<span class="badge badge-closed">Closed</span>');
                    if (isOpeningSoon(listing.hours)) badges.push('<span class="badge badge-opening-soon">Opening Soon</span>');
                    if (isClosingSoon(listing.hours)) badges.push('<span class="badge badge-closing-soon">Closing Soon</span>');
                    if (hasUnknownHours(listing)) badges.push('<span class="badge badge-hours-unknown">Hours Unknown</span>');
                    
                    if (isFeatured) badges.push('<span class="badge badge-featured">Featured</span>');
                    if (listing.verified) badges.push('<span class="badge badge-verified">Verified</span>');
                    if (!listing.showClaimButton && listing.tier === 'FREE') badges.push('<span class="badge badge-claimed">Claimed</span>');
                    
                    const categorySlug = listing.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                    const firstPhoto = listing.photos && listing.photos.length > 0 ? listing.photos[0] : listing.logo;
                    const popupContent = `
                        <div class="map-popup">
                            <img src="${firstPhoto}" alt="${listing.businessName}" class="map-popup-hero">
                            <div class="map-popup-content">
                                <img src="${listing.logo}" alt="${listing.businessName}" class="map-popup-logo">
                                <div class="map-popup-info">
                                    <div class="map-popup-badges">${badges.join('')}</div>
                                    <a href="/listings/${categorySlug}/${listing.slug}" class="map-popup-title">${listing.businessName}</a>
                                    <div class="map-popup-tagline">${listing.tagline || listing.description.substring(0, 60) + '...'}</div>
                                    <div class="map-popup-details">üìç ${getFullAddress(listing)}<br>${listing.phone ? 'üìû ' + listing.phone : ''}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    marker.bindPopup(popupContent, { maxWidth: 320, className: 'custom-popup' });
                    marker.on('popupopen', () => {
                        const closeBtn = document.querySelector('.leaflet-popup-close-button');
                        if (closeBtn) closeBtn.textContent = '√ó';
                    });
                    splitMarkerClusterGroup.addLayer(marker);
                    bounds.push([listing.coordinates.lat, listing.coordinates.lng]);
                }
            });
            if (bounds.length > 0) splitMap.fitBounds(L.latLngBounds(bounds), { padding: [50, 50], maxZoom: 15 });
            setTimeout(() => splitMap.invalidateSize(), 250);
        }

        function updateMapMarkers() {
            if (!map || !markerClusterGroup || !mapReady) return;
            markerClusterGroup.clearLayers();
            const bounds = [];
            filteredListings.forEach(listing => {
                if (listing.coordinates && !isBasedIn(listing)) {
                    const openStatus = isOpenNow(listing.hours);
                    const isFeatured = listing.tier === 'FEATURED' || listing.tier === 'PREMIUM';
                    const firstPhoto = listing.photos && listing.photos.length > 0 ? listing.photos[0] : listing.logo;
                    const iconClass = isFeatured ? 'custom-marker featured' : 'custom-marker';
                    const iconHtml = `<div class="${iconClass}"><img src="${listing.logo}" alt="${listing.businessName}"></div>`;
                    const customIcon = L.divIcon({ html: iconHtml, className: '', iconSize: [40, 40], iconAnchor: [20, 20] });
                    const marker = L.marker([listing.coordinates.lat, listing.coordinates.lng], { icon: customIcon, riseOnHover: true });
                    const badges = [];
                    
                    if (openStatus === true) badges.push('<span class="badge badge-open">Open</span>');
                    else if (openStatus === false) badges.push('<span class="badge badge-closed">Closed</span>');
                    if (isOpeningSoon(listing.hours)) badges.push('<span class="badge badge-opening-soon">Opening Soon</span>');
                    if (isClosingSoon(listing.hours)) badges.push('<span class="badge badge-closing-soon">Closing Soon</span>');
                    if (hasUnknownHours(listing)) badges.push('<span class="badge badge-hours-unknown">Hours Unknown</span>');
                    
                    if (isFeatured) badges.push('<span class="badge badge-featured">Featured</span>');
                    if (listing.verified) badges.push('<span class="badge badge-verified">Verified</span>');
                    if (!listing.showClaimButton && listing.tier === 'FREE') badges.push('<span class="badge badge-claimed">Claimed</span>');
                    
                    const categorySlug = listing.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                    const popupContent = `
                        <div class="map-popup">
                            <img src="${firstPhoto}" alt="${listing.businessName}" class="map-popup-hero">
                            <div class="map-popup-content">
                                <img src="${listing.logo}" alt="${listing.businessName}" class="map-popup-logo">
                                <div class="map-popup-info">
                                    <div class="map-popup-badges">${badges.join('')}</div>
                                    <a href="/listings/${categorySlug}/${listing.slug}" class="map-popup-title">${listing.businessName}</a>
                                    <div class="map-popup-tagline">${listing.tagline || listing.description.substring(0, 60) + '...'}</div>
                                    <div class="map-popup-details">üìç ${getFullAddress(listing)}<br>${listing.phone ? 'üìû ' + listing.phone : ''}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    marker.bindPopup(popupContent, { maxWidth: 320, className: 'custom-popup' });
                    marker.on('popupopen', () => {
                        const closeBtn = document.querySelector('.leaflet-popup-close-button');
                        if (closeBtn) closeBtn.textContent = '√ó';
                    });
                    markerClusterGroup.addLayer(marker);
                    bounds.push([listing.coordinates.lat, listing.coordinates.lng]);
                }
            });
            if (bounds.length > 0) map.fitBounds(L.latLngBounds(bounds), { padding: [50, 50], maxZoom: 15 });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>The Greek Directory - Chicagoland</title>
    <link rel="icon" href="https://social.thegreekdirectory.org/Logo2.png">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .line-clamp-2 { display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }
        .line-clamp-1 { display: -webkit-box; -webkit-line-clamp: 1; -webkit-box-orient: vertical; overflow: hidden; }
        #map { width: 100%; height: 400px; }
    </style>
</head>
<body class="bg-gray-50">
    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 py-4">
            <div class="flex items-center justify-between mb-4">
                <div class="flex items-center gap-3">
                    <img src="https://social.thegreekdirectory.org/Logo2.png" alt="The Greek Directory" class="h-12 w-auto">
                    <div>
                        <h1 class="text-xl font-bold" style="color: #055193;">The Greek Directory</h1>
                        <p class="text-xs text-gray-600">Chicagoland Listings</p>
                    </div>
                </div>
            </div>

            <div class="relative mb-4">
                <input type="text" id="searchInput" placeholder="Search businesses, churches, schools..." 
                    class="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" 
                    style="--tw-ring-color: #055193;">
            </div>

            <div class="flex items-center gap-2 overflow-x-auto pb-2">
                <button id="filterBtn" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg whitespace-nowrap">
                    <span>üîç</span>
                    <span class="text-sm font-medium">Filters</span>
                </button>
                <button id="mapBtn" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg whitespace-nowrap">
                    <span>üó∫Ô∏è</span>
                    <span class="text-sm font-medium">Map</span>
                </button>
                <div class="flex items-center gap-1 ml-auto bg-gray-100 rounded-lg p-1">
                    <button id="gridViewBtn" class="p-2 rounded"><span>‚äû</span></button>
                    <button id="listViewBtn" class="p-2 rounded bg-white shadow-sm"><span>‚ò∞</span></button>
                </div>
            </div>

            <div id="filterPanel" class="mt-4 p-4 bg-gray-50 rounded-lg border border-gray-200 hidden">
                <div class="flex items-center justify-between mb-3">
                    <h3 class="font-semibold text-gray-900">Filter by Category</h3>
                    <button id="closeFilterBtn" class="text-gray-500">‚úï</button>
                </div>
                <div id="categoryFilters" class="grid grid-cols-2 gap-2"></div>
            </div>
        </div>
    </header>

    <div id="mapContainer" class="hidden border-b">
        <div id="map"></div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="flex items-center justify-between">
            <p id="resultsCount" class="text-sm text-gray-600">Loading...</p>
            <select id="sortSelect" class="text-sm border border-gray-300 rounded-lg px-3 py-2">
                <option value="name">Sort by Name</option>
                <option value="newest">Newest First</option>
            </select>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 pb-8">
        <div id="listingsContainer"></div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const GITHUB_OWNER = 'YOUR_GITHUB_USERNAME';
        const GITHUB_REPO = 'YOUR_REPO_NAME';
        const DATABASE_PATH = 'listings-database.json';

        const CATEGORIES = [
            'Restaurant/Bakery',
            'Church/Religious Organization',
            'Greek School/Cultural Center',
            'Grocery/Imports',
            'Event Services',
            'Retail',
            'Real Estate',
            'Legal/Financial',
            'Other'
        ];

        let allListings = [];
        let filteredListings = [];
        let currentView = 'list';
        let selectedCategory = 'All';
        let map = null;

        document.addEventListener('DOMContentLoaded', () => {
            loadListings();
            setupEventListeners();
            createCategoryFilters();
        });

        async function loadListings() {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${DATABASE_PATH}`);
                const data = await response.json();
                allListings = data.listings.filter(l => l.visible !== false);
                filteredListings = allListings;
                renderListings();
                updateResultsCount();
            } catch (error) {
                console.error('Error loading listings:', error);
                document.getElementById('listingsContainer').innerHTML = 
                    '<p class="text-center text-gray-600 py-12">Error loading listings. Please try again.</p>';
            }
        }

        function setupEventListeners() {
            document.getElementById('searchInput').addEventListener('input', applyFilters);
            document.getElementById('filterBtn').addEventListener('click', toggleFilters);
            document.getElementById('closeFilterBtn').addEventListener('click', toggleFilters);
            document.getElementById('mapBtn').addEventListener('click', toggleMap);
            document.getElementById('gridViewBtn').addEventListener('click', () => setView('grid'));
            document.getElementById('listViewBtn').addEventListener('click', () => setView('list'));
        }

        function createCategoryFilters() {
            const container = document.getElementById('categoryFilters');
            const allBtn = document.createElement('button');
            allBtn.textContent = 'All';
            allBtn.className = 'px-3 py-2 rounded-lg text-sm font-medium text-white';
            allBtn.style.backgroundColor = '#055193';
            allBtn.onclick = () => filterByCategory('All');
            container.appendChild(allBtn);

            CATEGORIES.forEach(cat => {
                const btn = document.createElement('button');
                btn.textContent = cat;
                btn.className = 'px-3 py-2 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300 text-left';
                btn.onclick = () => filterByCategory(cat);
                container.appendChild(btn);
            });
        }

        function filterByCategory(category) {
            selectedCategory = category;
            const buttons = document.querySelectorAll('#categoryFilters button');
            buttons.forEach((btn, idx) => {
                const isSelected = (idx === 0 && category === 'All') || btn.textContent === category;
                if (isSelected) {
                    btn.className = 'px-3 py-2 rounded-lg text-sm font-medium text-white';
                    btn.style.backgroundColor = '#055193';
                } else {
                    btn.className = 'px-3 py-2 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300 text-left';
                }
            });
            applyFilters();
        }

        function applyFilters() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            filteredListings = allListings.filter(listing => {
                const matchesSearch = !searchTerm || 
                    listing.businessName.toLowerCase().includes(searchTerm) ||
                    listing.description.toLowerCase().includes(searchTerm) ||
                    listing.address.toLowerCase().includes(searchTerm);
                const matchesCategory = selectedCategory === 'All' || listing.category === selectedCategory;
                return matchesSearch && matchesCategory;
            });
            renderListings();
            updateResultsCount();
        }

        function toggleFilters() {
            document.getElementById('filterPanel').classList.toggle('hidden');
        }

        function toggleMap() {
            const container = document.getElementById('mapContainer');
            container.classList.toggle('hidden');
            if (!container.classList.contains('hidden') && !map) {
                map = L.map('map').setView([41.8781, -87.6298], 11);
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '¬© OpenStreetMap contributors'
                }).addTo(map);

                filteredListings.forEach(listing => {
                    fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(listing.address)}`)
                        .then(r => r.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                const marker = L.marker([parseFloat(data[0].lat), parseFloat(data[0].lon)]).addTo(map);
                                marker.bindPopup(`
                                    <div style="min-width:200px;">
                                        <h3 style="margin:0 0 8px 0;font-weight:bold;color:#055193;">${listing.businessName}</h3>
                                        <p style="margin:0 0 4px 0;font-size:12px;color:#666;">${listing.category}</p>
                                        <p style="margin:0;font-size:12px;">${listing.address}</p>
                                        <a href="/listings/${listing.slug}.html" style="display:inline-block;margin-top:8px;padding:4px 8px;background:#055193;color:white;text-decoration:none;border-radius:4px;font-size:12px;">View</a>
                                    </div>
                                `);
                            }
                        });
                });
            }
        }

        function setView(view) {
            currentView = view;
            document.getElementById('gridViewBtn').className = view === 'grid' ? 'p-2 rounded bg-white shadow-sm' : 'p-2 rounded';
            document.getElementById('listViewBtn').className = view === 'list' ? 'p-2 rounded bg-white shadow-sm' : 'p-2 rounded';
            renderListings();
        }

        function updateResultsCount() {
            const count = filteredListings.length;
            document.getElementById('resultsCount').textContent = `${count} ${count === 1 ? 'listing' : 'listings'} found${selectedCategory !== 'All' ? ` in ${selectedCategory}` : ''}`;
        }

        function renderListings() {
            const container = document.getElementById('listingsContainer');
            if (filteredListings.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-600 py-12">No listings found.</p>';
                return;
            }

            if (currentView === 'grid') {
                container.className = 'grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6';
                container.innerHTML = filteredListings.map(l => {
                    const firstPhoto = l.photos && l.photos.length > 0 ? l.photos[0] : 'https://via.placeholder.com/800x400/055193/FFFFFF?text=No+Photo';
                    return `
                        <a href="/listings/${l.slug}.html" class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow overflow-hidden block">
                            <div class="h-48 bg-gray-200">
                                <img src="${firstPhoto}" alt="${l.businessName}" class="w-full h-full object-cover">
                            </div>
                            <div class="p-4">
                                <div class="flex gap-3 mb-3">
                                    <img src="${l.logo}" alt="${l.businessName} logo" class="w-16 h-16 rounded object-cover flex-shrink-0">
                                    <div class="flex-1 min-w-0">
                                        <span class="text-xs font-semibold px-2 py-1 rounded-full text-white block w-fit mb-2" style="background-color:#055193;">${l.category}</span>
                                        <h3 class="text-lg font-bold text-gray-900 line-clamp-1">${l.businessName}</h3>
                                    </div>
                                </div>
                                <p class="text-sm text-gray-600 mb-3 line-clamp-2">${l.description}</p>
                                <div class="text-sm text-gray-600 space-y-1">
                                    <div class="flex items-center gap-2">
                                        <span>üìç</span>
                                        <span class="truncate">${l.address}</span>
                                    </div>
                                    <div class="flex items-center gap-2">
                                        <span>üìû</span>
                                        <span>${l.phone}</span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    `;
                }).join('');
            } else {
                container.className = 'space-y-4';
                container.innerHTML = filteredListings.map(l => {
                    const firstPhoto = l.photos && l.photos.length > 0 ? l.photos[0] : l.logo;
                    return `
                        <a href="/listings/${l.slug}.html" class="bg-white rounded-lg shadow-sm hover:shadow-md transition-shadow p-4 flex gap-4 block">
                            <img src="${firstPhoto}" alt="${l.businessName}" class="w-24 h-24 rounded-lg object-cover flex-shrink-0">
                            <div class="flex-1 min-w-0">
                                <span class="text-xs font-semibold px-2 py-1 rounded-full text-white" style="background-color:#055193;">${l.category}</span>
                                <h3 class="text-lg font-bold text-gray-900 mt-2 mb-1">${l.businessName}</h3>
                                <p class="text-sm text-gray-600 mb-2 line-clamp-1">${l.description}</p>
                                <div class="flex gap-4 text-sm text-gray-600">
                                    <div class="flex items-center gap-1">
                                        <span>üìç</span>
                                        <span class="truncate">${l.address}</span>
                                    </div>
                                    <div class="flex items-center gap-1">
                                        <span>üìû</span>
                                        <span>${l.phone}</span>
                                    </div>
                                </div>
                            </div>
                        </a>
                    `;
                }).join('');
            }
        }
    </script>
</body>
</html>

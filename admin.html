<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - The Greek Directory</title>
    <link rel="icon" href="https://social.thegreekdirectory.org/Logo2.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .hidden { display: none !important; }
        .image-preview { 
            width: 100px; 
            height: 100px; 
            object-fit: contain;
            background: #f3f4f6;
            border-radius: 8px; 
            border: 2px solid #e5e7eb; 
            pointer-events: none; 
            user-select: none; 
            -webkit-user-drag: none; 
        }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
        .upload-progress { display: none; background: #eff6ff; border: 1px solid #3b82f6; padding: 12px; border-radius: 8px; margin-top: 8px; }
        .sortable-ghost { opacity: 0.4; }
        .photo-item { position: relative; cursor: move; }
        .photo-item .delete-photo { position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
        .photo-item .photo-number { position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7); color: white; border-radius: 4px; padding: 2px 6px; font-size: 12px; font-weight: bold; }
        .owner-field { display: flex; gap: 8px; align-items: center; }
        .visibility-toggle { cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 12px; transition: all 0.2s; }
        .visibility-toggle.visible { background: #10b981; color: white; }
        .visibility-toggle.hidden { background: #ef4444; color: white; }
        img { pointer-events: none; user-select: none; -webkit-user-drag: none; }
        .analytics-tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .analytics-tab.active { border-bottom-color: #055193; color: #055193; font-weight: 600; }
        .analytics-stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; }
        .analytics-detail-row { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .analytics-detail-row:hover { background: #f9fafb; }
        .subcategory-checkbox { display: flex; align-items: center; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; margin: 4px; cursor: pointer; transition: all 0.2s; }
        .subcategory-checkbox:hover { background: #f3f4f6; }
        .subcategory-checkbox input[type="checkbox"] { margin-right: 8px; }
        .subcategory-checkbox input[type="checkbox"]:checked + label { font-weight: 600; color: #055193; }
    </style>
    
    <!-- SVG Sprites for Yelp and TripAdvisor -->
    <svg width="0" height="0" class="hidden">
      <symbol version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2400 3160" id="yelp-icon">
        <path d="M0 0 C3.36669602 0.00318677 6.73253066 -0.02054504 10.09912109 -0.0456543 C29.31999973 -0.10118676 48.21577968 1.40188287 66.60302734 7.31567383 C67.22806152 7.51499512 67.8530957 7.71431641 68.49707031 7.91967773 C84.33909829 13.08374156 99.35811382 20.92210785 111.60302734 32.31567383 C112.11671875 32.78312012 112.63041016 33.25056641 113.15966797 33.73217773 C131.861949 50.87593534 143.67945252 72.73038835 145.83374023 98.19848633 C145.92831701 99.22470596 146.02289379 100.2509256 146.12033653 101.3082428 C146.4283003 104.68487939 146.72124033 108.06261714 147.01318359 111.44067383 C147.22883073 113.85908718 147.44490934 116.2774621 147.66139221 118.69580078 C149.89670328 143.89297233 151.85423632 169.11198735 153.74247742 194.33719254 C154.0491887 198.43128878 154.35740654 202.52526948 154.66589355 206.61923218 C161.86665442 302.2451326 168.55969677 397.91005406 218.91466141 1172.88392258 C219.07897372 1175.7472199 219.24368094 1178.61049397 219.40882492 1181.47374344 C221.15142342 1211.68913589 222.78217004 1241.90910205 224.21677661 1272.14068913 C224.31578591 1274.21342713 224.41665947 1276.28606609 224.51809883 1278.35868645 C227.54999537 1340.80697901 228.53435634 1419.04195046 184.54492188 1469.11352539 C182.29557868 1471.58342365 179.96396447 1473.95140675 177.60302734 1476.31567383 C176.74064453 1477.1896582 175.87826172 1478.06364258 174.98974609 1478.96411133 C153.37684255 1499.77653697 120.17667551 1509.7420006 90.66040039 1509.61645508 C48.12239429 1508.76894878 13.72476032 1483.00753198 -15.39697266 1454.31567383 C-17.27408899 1452.32794171 -19.06411774 1450.31573279 -20.81103516 1448.21411133 C-22.68543065 1445.97037682 -24.66482748 1443.8397365 -26.64697266 1441.69067383 C-42.48611343 1424.0856829 -55.70209563 1404.2424685 -68.39697266 1384.31567383 C-68.96029297 1383.43363281 -69.52361328 1382.5515918 -70.10400391 1381.64282227 C-73.61914584 1376.13801478 -77.12290719 1370.62605884 -80.62207031 1365.11108398 C-82.99448722 1361.37460894 -85.37271988 1357.64185083 -87.75073242 1353.90893555 C-93.13990593 1345.44819313 -98.51083871 1336.97627059 -103.86279297 1328.49194336 C-110.01218487 1318.74830293 -116.20658614 1309.03329803 -122.39697266 1299.31567383 C-129.57149376 1288.05316224 -136.73832405 1276.78619639 -143.86279297 1265.49194336 C-150.01218487 1255.74830293 -156.20658614 1246.03329803 -162.39697266 1236.31567383 C-169.57007367 1225.05539148 -176.73616269 1213.79107432 -183.85839844 1202.49853516 C-187.68927958 1196.42779877 -191.54034197 1190.37007876 -195.39697266 1184.31567383 C-200.23468895 1176.72109301 -205.05440337 1169.115523 -209.85791016 1161.49926758 C-213.68899624 1155.4283137 -217.54018434 1149.37032622 -221.39697266 1143.31567383 C-226.23468895 1135.72109301 -231.05440337 1128.115523 -235.85791016 1120.49926758 C-239.68899624 1114.4283137 -243.54018434 1108.37032622 -247.39697266 1102.31567383 C-252.23468895 1094.72109301 -257.05440337 1087.115523 -261.85791016 1079.49926758 C-265.68899624 1073.4283137 -269.54018434 1067.37032622 -273.39697266 1061.31567383 C-278.23468895 1053.72109301 -283.05440337 1046.115523 -287.85791016 1038.49926758 C-291.68899624 1032.4283137 -295.54018434 1026.37032622 -299.39697266 1020.31567383 C-304.23468895 1012.72109301 -309.05440337 1005.115523 -313.85791016 997.49926758 C-317.68899624 991.4283137 -321.54018434 985.37032622 -325.39697266 979.31567383 C-330.23468895 971.72109301 -335.05440337 964.115523 -339.85791016 956.49926758 C-343.68899624 950.4283137 -347.54018434 944.37032622 -351.39697266 938.31567383 C-356.23468895 930.72109301 -361.05440337 923.115523 -365.85791016 915.49926758 C-369.68899634 909.42831354 -373.54021762 903.37034755 -377.39697266 897.31567383 C-384.24575067 886.56281128 -391.05543619 875.78562021 -397.85595703 865.00219727 C-403.68441877 855.76147855 -409.52781277 846.53060822 -415.39697266 837.31567383 C-421.26329792 828.10518997 -427.10370283 818.8786838 -432.92919922 809.64233398 C-435.41680623 805.69907138 -437.9070368 801.75746615 -440.39697266 797.81567383 C-441.3969849 796.23234823 -442.39698491 794.6490149 -443.39697266 793.06567383 C-443.89197266 792.28192383 -444.38697266 791.49817383 -444.89697266 790.69067383 C-449.39697265 783.56567384 -449.39697265 783.56567384 -450.89648438 781.19140625 C-451.89806301 779.60560058 -452.89969073 778.01982591 -453.90136719 776.43408203 C-456.3776145 772.51382626 -458.85304966 768.59306275 -461.32666016 764.67114258 C-466.6658052 756.20802968 -472.02137465 747.75568635 -477.39697266 739.31567383 C-483.26329792 730.10518997 -489.10370283 720.8786838 -494.92919922 711.64233398 C-497.41680623 707.69907138 -499.9070368 703.75746615 -502.39697266 699.81567383 C-503.3969849 698.23234823 -504.39698491 696.6490149 -505.39697266 695.06567383 C-505.89197266 694.28192383 -506.38697266 693.49817383 -506.89697266 692.69067383 C-520.39697266 671.31567383 -533.89697266 649.94067383 -547.39697266 628.56567383 C-547.89173096 627.78232666 -548.38648926 626.99897949 -548.89624023 626.19189453 C-549.89875509 624.60453857 -550.9011962 623.01713604 -551.90356445 621.4296875 C-554.36449228 617.53251987 -556.82658977 613.63610282 -559.29150391 609.74145508 C-564.81350967 601.0129737 -570.30528869 592.26642112 -575.77197266 583.50317383 C-581.81785872 573.81399634 -587.92862755 564.16792255 -594.06884766 554.53833008 C-602.39414784 541.48143628 -610.62304911 528.36492213 -618.82373047 515.22949219 C-624.64827855 505.90379661 -630.5161801 496.60596865 -636.39697266 487.31567383 C-644.80192986 474.03778149 -653.15233274 460.72672322 -661.47363281 447.39624023 C-664.61286489 442.36820896 -667.75504417 437.34202042 -670.89697266 432.31567383 C-672.14698729 430.31568298 -673.39698728 428.31568297 -674.64697266 426.31567383 C-675.57509766 424.83067383 -675.57509766 424.83067383 -676.52197266 423.31567383 C-678.39697266 420.31567383 -680.27197266 417.31567383 -682.14697266 414.31567383 C-682.76580322 413.32559326 -683.38463379 412.3355127 -684.0222168 411.31542969 C-685.27157858 409.31635321 -686.52076492 407.31716708 -687.76977539 405.31787109 C-690.90310719 400.30282511 -694.03951005 395.28974996 -697.18212891 390.28051758 C-705.1252134 377.61177458 -712.9748114 364.89109861 -720.70947266 352.09399414 C-722.40474285 349.30288089 -724.11773028 346.52330919 -725.83447266 343.74536133 C-726.91795807 341.97722535 -728.00129795 340.20900017 -729.08447266 338.44067383 C-729.57778076 337.65080078 -730.07108887 336.86092773 -730.5793457 336.04711914 C-741.56028108 318.01072572 -740.40892504 294.85746672 -735.65478516 274.89770508 C-731.13942178 257.71284748 -722.51473027 242.06998092 -711.39697266 228.31567383 C-710.98656738 227.7984375 -710.57616211 227.28120117 -710.15332031 226.74829102 C-705.04601332 220.3174501 -699.83927285 214.43451337 -693.39697266 209.31567383 C-692.37990234 208.48551758 -691.36283203 207.65536133 -690.31494141 206.80004883 C-676.2590188 195.43641476 -661.15216634 186.12681469 -645.39697266 177.31567383 C-644.48802246 176.80633301 -643.57907227 176.29699219 -642.64257812 175.7722168 C-605.7055344 155.17551733 -566.77705695 138.6187875 -527.39697266 123.31567383 C-525.63643555 122.63045654 -525.63643555 122.63045654 -523.84033203 121.93139648 C-505.6256896 114.86934229 -487.26269516 108.26529577 -468.81152344 101.8527832 C-465.91183912 100.84468328 -463.01443774 99.83044504 -460.11914062 98.80981445 C-387.31728912 73.1580123 -312.60963977 52.31847368 -65.58447266 4.00317383 C-64.31369873 3.85581787 -63.0429248 3.70846191 -61.73364258 3.55664062 C-57.62456765 3.10524794 -53.51310589 2.69600232 -49.39697266 2.31567383 C-48.47140564 2.22953827 -47.54583862 2.14340271 -46.59222412 2.05465698 C-31.04988905 0.64433687 -15.60545992 -0.03074182 0 0 Z " fill="#BE2418" transform="translate(993.39697265625,4.684326171875)"></path>
      </symbol>
      <symbol version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 366 366" id="tripadvisor-icon">
        <path d="M0 0 C0.75812988 0.2367041 1.51625977 0.4734082 2.29736328 0.71728516 C21.53481034 6.90381292 40.24761047 16.2741664 56 29 C56.86262451 29.69561035 56.86262451 29.69561035 57.74267578 30.40527344 C95.54856688 61.23906203 120.5015571 103.78730568 126.3125 152.62646484 C131.31586266 202.41885785 117.58638501 250.9631596 85.92578125 289.8125 C55.32289446 326.57700906 11.7598783 350.5920067 -36.03222656 355.53564453 C-85.82962503 359.74960909 -134.09026863 345.4654487 -172.60253906 313.44604492 C-175.45328573 311.01976893 -178.23803886 308.52655203 -181 306 C-181.94230469 305.14148438 -182.88460937 304.28296875 -183.85546875 303.3984375 C-216.89718572 271.83477713 -235.6116688 226.11845992 -237.33984375 180.84765625 C-238.44558008 129.57567422 -220.04374805 83.16227448 -185.06640625 45.84765625 C-177.97665924 38.44627201 -170.25447823 32.05735697 -162 26 C-161.44570312 25.58540527 -160.89140625 25.17081055 -160.3203125 24.74365234 C-115.11510679 -8.72252547 -53.09015518 -16.58155196 0 0 Z " fill="#33DFA0" transform="translate(237,9)"></path>
        <path d="M0 0 C8.98085558 6.4818349 15.30600146 15.92479182 18.24609375 26.62109375 C18.69217228 29.86202582 18.77098823 33.03985465 18.74609375 36.30859375 C18.74037354 37.18491455 18.73465332 38.06123535 18.72875977 38.96411133 C18.37611248 51.88620031 13.24975129 61.41316286 4.37109375 70.55078125 C-5.23019872 79.57135039 -16.78338377 83.22880713 -29.828125 82.93359375 C-39.32929476 81.91878256 -47.24562784 78.38694468 -54.75390625 72.62109375 C-55.62015625 72.04359375 -56.48640625 71.46609375 -57.37890625 70.87109375 C-64.24013385 64.37098339 -68.09066367 56.58448008 -70.75390625 47.62109375 C-70.94597656 47.00105469 -71.13804688 46.38101563 -71.3359375 45.7421875 C-73.77748865 33.35188588 -70.86124014 22.70431507 -64.69140625 11.99609375 C-57.59776372 1.43109423 -47.75720217 -4.25916607 -35.8125 -7.984375 C-22.83144528 -10.47220522 -10.91058097 -7.00022875 0 0 Z " fill="#33DC9E" transform="translate(141.75390625,159.37890625)"></path>
        <path d="M0 0 C1.16789062 0.36738281 1.16789062 0.36738281 2.359375 0.7421875 C14.92592793 5.15218899 22.39037658 13.89342089 28.8125 25.1875 C33.67506347 36.7040977 33.35244195 49.27439145 29 61 C23.12042523 72.92810285 14.87078321 81.78824205 2.19311523 86.26928711 C-10.79587034 90.46605886 -22.20286246 90.09894527 -34.5 83.875 C-45.85472399 77.14255303 -53.36800073 67.95632275 -57.38696289 55.43994141 C-58.4129545 51.35640491 -58.53171643 47.38220066 -58.5 43.1875 C-58.49500488 42.31383789 -58.49000977 41.44017578 -58.48486328 40.54003906 C-58.16318954 28.55602849 -53.2104517 19.38959935 -44.96875 10.91015625 C-32.66463569 -0.72243069 -16.38032623 -5.61058418 0 0 Z " fill="#33DC9E" transform="translate(262,153)"></path>
      </symbol>
    </svg>
</head>
<body class="bg-gray-50">
    <div id="loginPage" class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full">
            <div class="text-center mb-8">
                <img src="https://social.thegreekdirectory.org/Logo2.png" alt="The Greek Directory" class="h-20 w-auto mx-auto mb-4">
                <h1 class="text-3xl font-bold mb-2" style="color: #055193;">Admin Portal</h1>
            </div>
            <div class="bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Sign In</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Personal Access Token</label>
                        <input type="password" id="githubToken" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="--tw-ring-color: #055193;" placeholder="Enter token...">
                    </div>
                    <button id="loginBtn" class="w-full py-3 px-4 rounded-lg text-white font-semibold" style="background-color: #055193;">Sign In</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardPage" class="hidden">
        <header class="bg-white shadow-sm border-b sticky top-0 z-50">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="https://social.thegreekdirectory.org/Logo2.png" alt="The Greek Directory" class="h-12 w-auto">
                    <h1 class="text-xl font-bold" style="color: #055193;">Admin Portal</h1>
                </div>
                <button id="logoutBtn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Logout</button>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="mb-6 flex gap-3">
                <button id="newListingBtn" class="px-4 py-2 text-white rounded-lg font-medium" style="background-color: #055193;">+ New Listing</button>
                <input type="text" id="adminSearch" placeholder="Search listings..." 
                    class="px-4 py-2 border border-gray-300 rounded-lg" 
                    oninput="renderTable()">
                <button id="refreshBtn" class="px-4 py-2 bg-gray-200 text-gray-900 rounded-lg font-medium">ðŸ”„ Refresh</button>
            </div>

            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">ID</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Status</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Tier</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Business Name</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Category</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Location</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Last Updated</th>
                                <th class="text-right py-3 px-4 font-semibold text-gray-900">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="listingsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Modal - Complete form structure -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-lg max-w-4xl w-full my-8">
            <div class="p-6 border-b flex items-center justify-between">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-900">Edit Listing</h2>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Tier & Status</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tier</label>
                                <select id="editTier" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="updateVerifiedBasedOnTier()">
                                    <option value="FREE">Free</option>
                                    <option value="VERIFIED">Verified</option>
                                    <option value="FEATURED">Featured</option>
                                    <option value="PREMIUM">Premium</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Show Claim Button</label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="editShowClaim" class="w-4 h-4 mr-2">
                                    <span class="text-sm">Display on page</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Basic Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Business Name *</label>
                                <input type="text" id="editBusinessName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tagline (max 150 chars) *</label>
                                <input type="text" id="editTagline" maxlength="150" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <p class="text-xs text-gray-500 mt-1"><span id="taglineCount">0</span>/150 characters</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea id="editDescription" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Use Enter/Return to create new paragraphs"></textarea>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                                <select id="editCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="updateSubcategoriesForCategory()">
                                    <option>Automotive & Transportation</option>
                                    <option>Beauty & Health</option>
                                    <option>Church & Religious Organization</option>
                                    <option>Cultural/Fraternal Organization</option>
                                    <option>Education & Community</option>
                                    <option>Entertainment, Arts & Recreation</option>
                                    <option>Food & Hospitality</option>
                                    <option>Grocery & Imports</option>
                                    <option>Home & Construction</option>
                                    <option>Industrial & Manufacturing</option>
                                    <option>Pets & Veterinary</option>
                                    <option>Professional & Business Services</option>
                                    <option>Real Estate & Development</option>
                                    <option>Retail & Shopping</option>
                                </select>
                            </div>
                            <div id="subcategoriesContainer" class="hidden md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subcategories * (Select at least 1)</label>
                                <div id="subcategoryCheckboxes" class="grid grid-cols-2 gap-2"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                <input type="tel" id="editPhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Address (leave empty if Based In only)</label>
                                <input type="text" id="editAddress" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                <input type="text" id="editCity" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                                <select id="editState" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option><option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option><option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option><option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Zip Code</label>
                                <input type="text" id="editZipCode" maxlength="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="60601">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                                <input type="text" id="editCountry" value="USA" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="editEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                                <input type="url" id="editWebsite" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Hours of Operation</h3>
                        <div class="grid grid-cols-1 gap-3">
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Monday:</label>
                                <input type="text" id="editHoursMonday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Tuesday:</label>
                                <input type="text" id="editHoursTuesday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Wednesday:</label>
                                <input type="text" id="editHoursWednesday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Thursday:</label>
                                <input type="text" id="editHoursThursday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Friday:</label>
                                <input type="text" id="editHoursFriday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Saturday:</label>
                                <input type="text" id="editHoursSaturday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Sunday:</label>
                                <input type="text" id="editHoursSunday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Images</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Logo (leave empty to use category default)</label>
                                <input type="file" id="logoUpload" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <div id="logoProgress" class="upload-progress"></div>
                                <div id="logoPreview" class="mt-2"></div>
                                <input type="hidden" id="editLogo">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Photos (max 15, leave empty to use category default) - Drag to reorder</label>
                                <input type="file" id="photosUpload" accept="image/*" multiple class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <div id="photosProgress" class="upload-progress"></div>
                                <div id="photosPreview" class="mt-2 image-grid"></div>
                                <input type="hidden" id="editPhotos">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Social Media</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Facebook</label>
                                <input type="text" id="editFacebook" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Instagram</label>
                                <input type="text" id="editInstagram" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Twitter/X</label>
                                <input type="text" id="editTwitter" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">YouTube</label>
                                <input type="text" id="editYoutube" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">TikTok</label>
                                <input type="text" id="editTiktok" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">LinkedIn (full URL)</label>
                                <input type="url" id="editLinkedin" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Social 1 (full URL)</label>
                                <input type="url" id="editOther1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Social 2 (full URL)</label>
                                <input type="url" id="editOther2" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Social 3 (full URL)</label>
                                <input type="url" id="editOther3" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Review Sites</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Google Reviews (full URL)</label>
                                <input type="url" id="editGoogle" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Yelp (full URL)</label>
                                <input type="url" id="editYelp" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">TripAdvisor (full URL)</label>
                                <input type="url" id="editTripadvisor" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Review 1 (full URL)</label>
                                <input type="url" id="editReviewOther1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Review 2 (full URL)</label>
                                <input type="url" id="editReviewOther2" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Review 3 (full URL)</label>
                                <input type="url" id="editReviewOther3" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Owner Info (Optional - Private)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="owner-field">
                                <input type="text" id="editOwnerName" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Full Name">
                                <button class="visibility-toggle visible" data-field="name" onclick="toggleOwnerFieldVisibility('name')">Visible</button>
                            </div>
                            <div class="owner-field">
                                <input type="text" id="editOwnerTitle" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Title (Owner, Manager, etc.)">
                                <button class="visibility-toggle visible" data-field="title" onclick="toggleOwnerFieldVisibility('title')">Visible</button>
                            </div>
                            <div class="owner-field">
                                <input type="text" id="editOwnerGreece" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="From Greece (Athens, Crete, etc.)">
                                <button class="visibility-toggle hidden" data-field="greece" onclick="toggleOwnerFieldVisibility('greece')">Hidden</button>
                            </div>
                            <div class="owner-field">
                                <input type="email" id="editOwnerEmail" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Owner Email">
                                <button class="visibility-toggle hidden" data-field="email" onclick="toggleOwnerFieldVisibility('email')">Hidden</button>
                            </div>
                            <div class="owner-field">
                                <input type="tel" id="editOwnerPhone" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Owner Phone">
                                <button class="visibility-toggle hidden" data-field="phone" onclick="toggleOwnerFieldVisibility('phone')">Hidden</button>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Business Portal Password (15 characters)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="editPassword" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-mono" placeholder="Auto-generated or custom">
                                    <button type="button" onclick="generatePasswordField()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Generate</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Password for business portal access</p>
                            </div>
                        </div>
                        <input type="hidden" id="ownerFieldsVisibility" value='{"name":true,"title":true,"greece":false,"email":false,"phone":false}'>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end gap-3">
                <button id="cancelEdit" class="px-6 py-2 bg-gray-200 text-gray-900 rounded-lg font-medium">Cancel</button>
                <button id="saveEdit" class="px-6 py-2 text-white rounded-lg font-medium" style="background-color: #055193;">Save</button>
            </div>
        </div>
    </div>
    <!-- Analytics Modal -->
    <div id="analyticsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-hidden flex flex-col">
            <div class="flex items-center justify-between p-6 border-b">
                <h2 class="text-2xl font-bold text-gray-900">Analytics for <span id="analyticsBusinessName"></span></h2>
                <button id="closeAnalytics" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
            </div>
            
            <div class="flex border-b overflow-x-auto">
                <div class="analytics-tab active" data-tab="overview">Overview</div>
                <div class="analytics-tab" data-tab="today">Today</div>
                <div class="analytics-tab" data-tab="yesterday">Yesterday</div>
                <div class="analytics-tab" data-tab="week">Past Week</div>
                <div class="analytics-tab" data-tab="month">Past 30 Days</div>
                <div class="analytics-tab" data-tab="alltime">All Time</div>
            </div>
            
            <div class="flex-1 overflow-y-auto p-6">
                <div class="flex items-center justify-between mb-6">
                    <div class="text-sm text-gray-600">Last updated: <span id="analyticsLastUpdated"></span></div>
                    <button id="refreshAnalytics" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">ðŸ”„ Refresh</button>
                </div>
                
                <div id="analyticsContent"></div>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="deleteModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-lg max-w-md w-full p-6">
            <h2 class="text-2xl font-bold text-red-600 mb-4">Delete Listing</h2>
            <p class="text-gray-700 mb-4">Are you sure you want to delete <strong id="deleteBusinessName"></strong>?</p>
            <p class="text-gray-700 mb-4">Type <strong>DELETE</strong> to confirm:</p>
            <input type="text" id="deleteConfirmInput" class="w-full px-4 py-2 border border-gray-300 rounded-lg mb-4" placeholder="Type DELETE">
            <div class="flex gap-3">
                <button id="cancelDelete" class="flex-1 px-4 py-2 bg-gray-200 text-gray-900 rounded-lg font-medium">Cancel</button>
                <button id="confirmDelete" class="flex-1 px-4 py-2 bg-red-600 text-white rounded-lg font-medium">Confirm Delete</button>
            </div>
        </div>
    </div>

<script>
    const GITHUB_OWNER = 'thegreekdirectory';
    const GITHUB_REPO = 'listings';
    const LINKS_REPO = 'links';
    const DATABASE_PATH = 'listings-database.json';
    const LINKS_DATABASE_PATH = 'data/links.json';

    const SUBCATEGORIES = {
        'Automotive & Transportation': ['Auto Detailer', 'Auto Repair Shop', 'Car Dealer', 'Taxi & Limo Service'],
        'Beauty & Health': ['Barbershops', 'Esthetician', 'Hair Salons', 'Nail Salon', 'Spas', 'Chiropractor', 'Dentist', 'Doctor', 'Nutritionist', 'Optometrist', 'Orthodontist', 'Physical Therapist', 'Physical Trainer'],
        'Church & Religious Organization': ['Church'],
        'Cultural/Fraternal Organization': ['Dance Troupe', 'Non-Profit', 'Philanthropic Group', 'Society', 'Youth Organization'],
        'Education & Community': ['Childcare', 'Greek School', 'Senior Care', 'Tutor'],
        'Entertainment, Arts & Recreation': ['Band', 'DJs', 'Entertainment Group', 'Photographer', 'Art'],
        'Food & Hospitality': ['Banquet Hall', 'Catering Service', 'Event Venue', 'Bakeries', 'Deli', 'Pastry Shop', 'Bar', 'Breakfast', 'Coffee', 'Lunch', 'Dinner', 'Restaurant', 'Hotel', 'Airbnb'],
        'Grocery & Imports': ['Butcher Shop', 'Liquor Shop', 'Market', 'Greek Alcohol', 'Honey', 'Olive Oil', 'Food Distribution', 'Food Manufacturer'],
        'Home & Construction': ['Carpenter', 'Electrician', 'General Contractor', 'Handyman', 'HVAC', 'Landscaping', 'Painter', 'Plumber', 'Roofing', 'Tile & Stone Specialist'],
        'Industrial & Manufacturing': ['Food Manufacturer'],
        'Pets & Veterinary': ['Veterinarian', 'Pet Accessories Maker'],
        'Professional & Business Services': ['Business Services', 'Consultant', 'CPA', 'Financial Advisor', 'Insurance Agent', 'IT Service & Repair', 'Lawyer', 'Marketing & Creative Agency', 'Notaries', 'Wedding Planner', 'Travel Agency'],
        'Real Estate & Development': ['Appraiser', 'Broker', 'Developer', 'Lender', 'Property Management', 'Real Estate Agent'],
        'Retail & Shopping': ['Boutique Shop', 'ECommerce', 'Jewelry', 'Souvenir Shop']
    };

    const CATEGORY_IMAGES = {
        'automotive-transportation': {
            main: 'https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?w=200&h=200&fit=crop&q=80'
        },
        'beauty-health': {
            main: 'https://images.unsplash.com/photo-1560750588-73207b1ef5b8?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1560750588-73207b1ef5b8?w=200&h=200&fit=crop&q=80'
        },
        'church-religious-organization': {
            main: 'https://images.unsplash.com/photo-1438232992991-995b7058bbb3?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1438232992991-995b7058bbb3?w=200&h=200&fit=crop&q=80'
        },
        'cultural-fraternal-organization': {
            main: 'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=200&h=200&fit=crop&q=80'
        },
        'education-community': {
            main: 'https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=200&h=200&fit=crop&q=80'
        },
        'entertainment-arts-recreation': {
            main: 'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=200&h=200&fit=crop&q=80'
        },
        'food-hospitality': {
            main: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=200&h=200&fit=crop&q=80'
        },
        'grocery-imports': {
            main: 'https://images.unsplash.com/photo-1542838132-92c53300491e?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1542838132-92c53300491e?w=200&h=200&fit=crop&q=80'
        },
        'home-construction': {
            main: 'https://images.unsplash.com/photo-1503387762-592deb58ef4e?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1503387762-592deb58ef4e?w=200&h=200&fit=crop&q=80'
        },
        'industrial-manufacturing': {
            main: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=200&h=200&fit=crop&q=80'
        },
        'pets-veterinary': {
            main: 'https://images.unsplash.com/photo-1548199973-03cce0bbc87b?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1548199973-03cce0bbc87b?w=200&h=200&fit=crop&q=80'
        },
        'professional-business-services': {
            main: 'https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=200&h=200&fit=crop&q=80'
        },
        'real-estate-development': {
            main: 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=200&h=200&fit=crop&q=80'
        },
        'retail-shopping': {
            main: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=200&h=200&fit=crop&q=80'
        }
    };

    function getCategoryDefaults(category) {
        const slug = category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        return CATEGORY_IMAGES[slug] || {
            main: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&q=80',
            logo: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=200&h=200&fit=crop&q=80'
        };
    }

    let githubToken = null;
    let allListings = [];
    let editingListing = null;
    let databaseSha = null;
    let linksDatabaseSha = null;
    let linksData = null;
    let uploadedImages = { logo: null, photos: [] };
    let deletingListingId = null;
    let photosSortable = null;
    let ownerFieldsVisibility = { name: true, title: true, greece: false, email: false, phone: false };
    let selectedSubcategories = [];
    let nextListingId = 1;

    function generatePassword(length = 15) {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
        let password = '';
        for (let i = 0; i < length; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return password;
    }

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }
    // Login and authentication
document.getElementById('loginBtn').addEventListener('click', async () => {
    githubToken = document.getElementById('githubToken').value.trim();
    if (!githubToken) {
        alert('Please enter your GitHub token');
        return;
    }
    sessionStorage.setItem('githubToken', githubToken);
    await testToken();
});

async function testToken() {
    try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${DATABASE_PATH}`, {
            headers: { 'Authorization': `token ${githubToken}` }
        });
        if (response.ok) {
            showDashboard();
            await loadListings();
            await loadLinksDatabase();
        } else {
            alert('ERROR: Invalid token.');
        }
    } catch (error) {
        alert('ERROR: Connection to repo failed.');
    }
}

function showDashboard() {
    document.getElementById('loginPage').classList.add('hidden');
    document.getElementById('dashboardPage').classList.remove('hidden');
}

document.getElementById('logoutBtn').addEventListener('click', () => {
    githubToken = null;
    sessionStorage.clear();
    location.reload();
});

// Load links database
async function loadLinksDatabase() {
    try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${LINKS_REPO}/contents/${LINKS_DATABASE_PATH}`, {
            headers: { 'Authorization': `token ${githubToken}` }
        });
        if (response.ok) {
            const data = await response.json();
            linksDatabaseSha = data.sha;
            const content = JSON.parse(atob(data.content));
            linksData = content;
        }
    } catch (error) {
        console.error('Error loading links database:', error);
        linksData = { links: [] };
    }
}

// Create redirect links for listing and business portal
async function createLinksRedirect(listingId, slug, categorySlug) {
    try {
        if (!linksData) {
            await loadLinksDatabase();
        }

        // Create listing redirect: /r/l/{listingId}
        const listingLinkId = generateUUID();
        const listingPath = `/r/l/${listingId}`;
        const listingUrl = `https://thegreekdirectory.org/listings/${categorySlug}/${slug}`;
        
        // Create business portal redirect: /r/b/{listingId}
        const portalLinkId = generateUUID();
        const portalPath = `/r/b/${listingId}`;
        const portalUrl = `https://thegreekdirectory.org/business-portal.html?slug=${slug}`;

        // Add to links data if they don't exist
        const listingLinkExists = linksData.links.some(l => l.path === listingPath);
        const portalLinkExists = linksData.links.some(l => l.path === portalPath);

        if (!listingLinkExists) {
            linksData.links.push({
                id: listingLinkId,
                title: `Listing #${listingId}`,
                path: listingPath,
                redirectTo: listingUrl
            });
        } else {
            // Update existing
            const existingLink = linksData.links.find(l => l.path === listingPath);
            existingLink.redirectTo = listingUrl;
        }

        if (!portalLinkExists) {
            linksData.links.push({
                id: portalLinkId,
                title: `Portal #${listingId}`,
                path: portalPath,
                redirectTo: portalUrl
            });
        } else {
            // Update existing
            const existingLink = linksData.links.find(l => l.path === portalPath);
            existingLink.redirectTo = portalUrl;
        }

        // Save links database
        await saveLinksDatabase();

        // Generate redirect HTML files
        await generateRedirectFile(listingPath, listingUrl);
        await generateRedirectFile(portalPath, portalUrl);

        console.log('Links created successfully');
    } catch (error) {
        console.error('Error creating links:', error);
    }
}

async function saveLinksDatabase() {
    try {
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(linksData, null, 2))));
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${LINKS_REPO}/contents/${LINKS_DATABASE_PATH}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${githubToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'Update links database',
                content: content,
                sha: linksDatabaseSha
            })
        });

        if (response.ok) {
            const data = await response.json();
            linksDatabaseSha = data.content.sha;
        }
    } catch (error) {
        console.error('Error saving links database:', error);
    }
}

async function generateRedirectFile(path, redirectUrl) {
    try {
        // Get template
        const templateResponse = await fetch(`https://raw.githubusercontent.com/${GITHUB_OWNER}/${LINKS_REPO}/main/r/_template.html`);
        let template = await templateResponse.text();
        
        template = template.replace(/{{REDIRECT_URL}}/g, redirectUrl);
        
        // Save to path
        const filePath = path.substring(1) + '.html'; // Remove leading / and add .html
        
        let fileSha = null;
        try {
            const existingFile = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${LINKS_REPO}/contents/${filePath}`, {
                headers: { 'Authorization': `token ${githubToken}` }
            });
            if (existingFile.ok) {
                const existingData = await existingFile.json();
                fileSha = existingData.sha;
            }
        } catch (e) {}

        const htmlContent = btoa(unescape(encodeURIComponent(template)));
        await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${LINKS_REPO}/contents/${filePath}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${githubToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Generate redirect for ${path}`,
                content: htmlContent,
                ...(fileSha && { sha: fileSha })
            })
        });
    } catch (error) {
        console.error('Error generating redirect file:', error);
    }
}

async function loadListings() {
    console.log('ðŸ”„ Loading listings from GitHub...');
    try {
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${DATABASE_PATH}`, {
            headers: { 'Authorization': `token ${githubToken}` }
        });
        
        if (!response.ok) {
            throw new Error(`Failed to fetch: ${response.status}`);
        }
        
        const data = await response.json();
        databaseSha = data.sha;
        console.log('Database SHA:', databaseSha);
        
        const content = JSON.parse(atob(data.content));
        allListings = content.listings || [];
        console.log('Loaded', allListings.length, 'listings');
        
        // Calculate next listing ID
        nextListingId = Math.max(...allListings.map(l => l.listingId || 0), 0) + 1;
        console.log('Next listing ID will be:', nextListingId);
        
        renderTable();
    } catch (error) {
        console.error('âŒ Error loading listings:', error);
        alert('Failed to load listings');
    }
}
    
if (sessionStorage.getItem('githubToken')) {
    githubToken = sessionStorage.getItem('githubToken');
    testToken();
}

function renderTable() {
    const tbody = document.getElementById('listingsTableBody');
    const searchTerm = document.getElementById('adminSearch') ? document.getElementById('adminSearch').value.toLowerCase() : '';
    
    const filtered = searchTerm ? allListings.filter(l => 
        l.businessName.toLowerCase().includes(searchTerm) ||
        l.category.toLowerCase().includes(searchTerm) ||
        (l.city && l.city.toLowerCase().includes(searchTerm))
    ) : allListings;
    
    tbody.innerHTML = filtered.map(l => {
        const categorySlug = l.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        const listingUrl = `/listings/${categorySlug}/${l.slug}`;
        const tier = l.tier || 'FREE';
        const tierColors = {
            FREE: 'bg-gray-100 text-gray-700',
            VERIFIED: 'bg-blue-100 text-blue-700',
            FEATURED: 'bg-yellow-100 text-yellow-700',
            PREMIUM: 'bg-purple-100 text-purple-700'
        };
        
        return `
        <tr class="border-b hover:bg-gray-50">
            <td class="py-4 px-4 text-sm font-mono text-gray-600">#${l.listingId || 'N/A'}</td>
            <td class="py-4 px-4">
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" ${l.visible ? 'checked' : ''} onchange="toggleVisibility('${l.id}')" class="w-4 h-4">
                    <span class="ml-2 text-sm">${l.visible ? 'ðŸ‘ï¸ Visible' : 'ðŸš« Hidden'}</span>
                </label>
            </td>
            <td class="py-4 px-4">
                <span class="px-2 py-1 rounded text-xs font-medium ${tierColors[tier]}">${tier}</span>
            </td>
            <td class="py-4 px-4 font-medium">${l.businessName}</td>
            <td class="py-4 px-4 text-gray-600">${l.category}</td>
            <td class="py-4 px-4 text-sm text-gray-600">${l.city || ''}, ${l.state || ''}</td>
            <td class="py-4 px-4 text-sm text-gray-600">${new Date(l.metadata.updatedAt).toLocaleString()}</td>
            <td class="py-4 px-4">
                <div class="flex justify-end gap-2">
                    <button onclick="showAnalytics('${l.id}')" class="px-3 py-1 bg-green-100 text-green-700 rounded hover:bg-green-200">ðŸ“Š</button>
                    <button onclick="editListing('${l.id}')" class="px-3 py-1 bg-blue-100 text-blue-700 rounded hover:bg-blue-200">Edit</button>
                    <a href="${listingUrl}" target="_blank" class="px-3 py-1 bg-gray-100 text-gray-700 rounded hover:bg-gray-200">View</a>
                    <button onclick="showDeleteModal('${l.id}')" class="px-3 py-1 bg-red-100 text-red-700 rounded hover:bg-red-200">Delete</button>
                </div>
            </td>
        </tr>
    `}).join('');
}

window.toggleVisibility = async function(id) {
    const listing = allListings.find(l => l.id === id);
    listing.visible = !listing.visible;
    listing.metadata.updatedAt = new Date().toISOString();
    await saveDatabase(true);
};

document.getElementById('newListingBtn').addEventListener('click', () => {
    editingListing = null;
    document.getElementById('modalTitle').textContent = 'New Listing';
    clearForm();
    document.getElementById('editModal').classList.remove('hidden');
    setTimeout(initPhotosSortable, 100);
});

window.editListing = function(id) {
    editingListing = allListings.find(l => l.id === id);
    document.getElementById('modalTitle').textContent = 'Edit Listing';
    fillForm(editingListing);
    document.getElementById('editModal').classList.remove('hidden');
    setTimeout(initPhotosSortable, 100);
};

document.getElementById('closeModal').addEventListener('click', () => {
    if (confirm('Are you sure you want to cancel? All inputted info will be deleted.')) {
        document.getElementById('editModal').classList.add('hidden');
        clearForm();
    }
});

document.getElementById('cancelEdit').addEventListener('click', () => {
    if (confirm('Are you sure you want to cancel? All inputted info will be deleted.')) {
        document.getElementById('editModal').classList.add('hidden');
        clearForm();
    }
});

document.getElementById('editTagline').addEventListener('input', (e) => {
    document.getElementById('taglineCount').textContent = e.target.value.length;
});

window.updateVerifiedBasedOnTier = function() {
    const tier = document.getElementById('editTier').value;
};

window.toggleOwnerFieldVisibility = function(field) {
    ownerFieldsVisibility[field] = !ownerFieldsVisibility[field];
    const button = document.querySelector(`.visibility-toggle[data-field="${field}"]`);
    if (ownerFieldsVisibility[field]) {
        button.className = 'visibility-toggle visible';
        button.textContent = 'Visible';
    } else {
        button.className = 'visibility-toggle hidden';
        button.textContent = 'Hidden';
    }
    document.getElementById('ownerFieldsVisibility').value = JSON.stringify(ownerFieldsVisibility);
};

window.generatePasswordField = function() {
    const password = generatePassword(15);
    document.getElementById('editPassword').value = password;
};

window.updateSubcategoriesForCategory = function() {
    const category = document.getElementById('editCategory').value;
    const container = document.getElementById('subcategoriesContainer');
    
    if (SUBCATEGORIES[category]) {
        container.classList.remove('hidden');
        const checkboxDiv = document.getElementById('subcategoryCheckboxes');
        checkboxDiv.innerHTML = '';
        
        SUBCATEGORIES[category].forEach(sub => {
            const checked = selectedSubcategories.includes(sub);
            const div = document.createElement('div');
            div.className = 'subcategory-checkbox';
            div.innerHTML = `
                <input type="checkbox" id="subcat-${sub.replace(/\s+/g, '-')}" ${checked ? 'checked' : ''} onchange="toggleSubcategory('${sub}')">
                <label for="subcat-${sub.replace(/\s+/g, '-')}">${sub}</label>
            `;
            checkboxDiv.appendChild(div);
        });
    } else {
        container.classList.add('hidden');
    }
};

window.toggleSubcategory = function(subcategory) {
    const index = selectedSubcategories.indexOf(subcategory);
    if (index > -1) {
        selectedSubcategories.splice(index, 1);
    } else {
        selectedSubcategories.push(subcategory);
    }
};

document.getElementById('refreshBtn').addEventListener('click', loadListings);

// FIXED: Form data collection with password
async function getFormData() {
    const name = document.getElementById('editBusinessName').value.trim();
    const tagline = document.getElementById('editTagline').value.trim();
    const category = document.getElementById('editCategory').value;
    const password = document.getElementById('editPassword').value.trim(); // GET PASSWORD
    
    if (!name) { alert('Business name required'); return null; }
    if (!tagline) { alert('Tagline required'); return null; }
    if (!category) { alert('Category required'); return null; }
    if (selectedSubcategories.length === 0) {
        alert('At least one subcategory required');
        return null;
    }

    return {
        businessName: name,
        tagline: tagline,
        description: document.getElementById('editDescription').value || '',
        category: category,
        subcategories: selectedSubcategories,
        phone: document.getElementById('editPhone').value || null,
        address: document.getElementById('editAddress').value || null,
        city: document.getElementById('editCity').value || null,
        state: document.getElementById('editState').value || null,
        zipCode: document.getElementById('editZipCode').value || null,
        country: document.getElementById('editCountry').value || 'USA',
        email: document.getElementById('editEmail').value || null,
        website: document.getElementById('editWebsite').value || null,
        tier: document.getElementById('editTier').value,
        verified: document.getElementById('editTier').value !== 'FREE',
        showClaimButton: document.getElementById('editShowClaim').checked,
        businessPortalPassword: password || null, // SAVE PASSWORD
        hours: {
            monday: document.getElementById('editHoursMonday').value || null,
            tuesday: document.getElementById('editHoursTuesday').value || null,
            wednesday: document.getElementById('editHoursWednesday').value || null,
            thursday: document.getElementById('editHoursThursday').value || null,
            friday: document.getElementById('editHoursFriday').value || null,
            saturday: document.getElementById('editHoursSaturday').value || null,
            sunday: document.getElementById('editHoursSunday').value || null
        },
        socialMedia: {
            facebook: document.getElementById('editFacebook').value || null,
            instagram: document.getElementById('editInstagram').value || null,
            twitter: document.getElementById('editTwitter').value || null,
            youtube: document.getElementById('editYoutube').value || null,
            tiktok: document.getElementById('editTiktok').value || null,
            linkedin: document.getElementById('editLinkedin').value || null,
            other1: document.getElementById('editOther1').value || null,
            other2: document.getElementById('editOther2').value || null,
            other3: document.getElementById('editOther3').value || null
        },
        reviews: {
            google: document.getElementById('editGoogle').value || null,
            yelp: document.getElementById('editYelp').value || null,
            tripadvisor: document.getElementById('editTripadvisor').value || null,
            other1: document.getElementById('editReviewOther1').value || null,
            other2: document.getElementById('editReviewOther2').value || null,
            other3: document.getElementById('editReviewOther3').value || null
        },
        ownerInfo: {
            fullName: document.getElementById('editOwnerName').value || null,
            title: document.getElementById('editOwnerTitle').value || null,
            fromGreece: document.getElementById('editOwnerGreece').value || null,
            ownerEmail: document.getElementById('editOwnerEmail').value || null,
            ownerPhone: document.getElementById('editOwnerPhone').value || null,
            visibility: ownerFieldsVisibility
        }
    };
}

function generateSlug(name) {
    return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
}

// UPDATED: Save edit with better error handling and page generation
document.getElementById('saveEdit').addEventListener('click', async () => {
    console.log('=== SAVE BUTTON CLICKED ===');
    
    const listing = await getFormData();
    if (!listing) {
        console.log('Form data validation failed');
        return;
    }

    console.log('Form data collected:', listing.businessName);

    const slug = editingListing ? editingListing.slug : generateSlug(listing.businessName);
    const categorySlug = listing.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');

    console.log('Slug:', slug);
    console.log('Category slug:', categorySlug);

    const defaults = getCategoryDefaults(listing.category);
    
    // Handle logo upload
    if (uploadedImages.logo) {
        console.log('Uploading logo...');
        document.getElementById('logoProgress').style.display = 'block';
        document.getElementById('logoProgress').textContent = 'Uploading logo...';
        const logoPath = await uploadImage(uploadedImages.logo, slug, 'logo/logo', categorySlug);
        if (logoPath) {
            listing.logo = logoPath;
            console.log('Logo uploaded:', logoPath);
        }
        document.getElementById('logoProgress').style.display = 'none';
    } else if (editingListing && editingListing.logo) {
        listing.logo = editingListing.logo;
        console.log('Using existing logo:', listing.logo);
    } else {
        listing.logo = defaults.logo;
        console.log('Using default logo:', listing.logo);
    }

    // Handle photos upload
    if (uploadedImages.photos.length > 0) {
        console.log('Uploading', uploadedImages.photos.length, 'photos...');
        document.getElementById('photosProgress').style.display = 'block';
        const photoPaths = [];
        for (let i = 0; i < uploadedImages.photos.length; i++) {
            if (uploadedImages.photos[i].existing) {
                photoPaths.push(uploadedImages.photos[i].url);
                console.log(`Photo ${i+1}: Using existing`);
            } else {
                document.getElementById('photosProgress').textContent = `Uploading photo ${i + 1} of ${uploadedImages.photos.length}...`;
                const photoPath = await uploadImage(uploadedImages.photos[i], slug, `photos/photo-${i + 1}`, categorySlug);
                if (photoPath) {
                    photoPaths.push(photoPath);
                    console.log(`Photo ${i+1}: Uploaded to ${photoPath}`);
                }
            }
        }
        listing.photos = photoPaths;
        document.getElementById('photosProgress').style.display = 'none';
    } else if (editingListing && editingListing.photos) {
        listing.photos = editingListing.photos;
        console.log('Using existing photos:', listing.photos.length);
    } else {
        listing.photos = [defaults.main];
        console.log('Using default photo');
    }

    listing.verified = listing.tier !== 'FREE';

    // Update or create listing in array
    if (editingListing) {
        console.log('ðŸ“ UPDATING existing listing:', editingListing.id);
        const index = allListings.findIndex(l => l.id === editingListing.id);
        console.log('Found at index:', index);
        
        listing.id = editingListing.id;
        listing.slug = editingListing.slug;
        listing.listingId = editingListing.listingId;
        listing.metadata = {
            createdAt: editingListing.metadata.createdAt,
            updatedAt: new Date().toISOString()
        };
        listing.analytics = editingListing.analytics || {
            views: 0,
            callClicks: 0,
            websiteClicks: 0,
            directionClicks: 0,
            shareClicks: 0,
            sharePlatforms: {},
            videoPlays: 0,
            lastViewed: new Date().toISOString(),
            detailedViews: []
        };
        listing.visible = editingListing.visible !== undefined ? editingListing.visible : true;
        
        allListings[index] = listing;
        console.log('Updated listing at index', index);
    } else {
        console.log('âœ¨ CREATING new listing');
        listing.id = slug;
        listing.slug = slug;
        listing.listingId = nextListingId;
        console.log('Assigned listing ID:', listing.listingId);
        
        nextListingId++; // Increment for next listing
        
        listing.visible = true;
        listing.metadata = {
            createdAt: new Date().toISOString(),
            updatedAt: new Date().toISOString()
        };
        listing.analytics = {
            views: 0,
            callClicks: 0,
            websiteClicks: 0,
            directionClicks: 0,
            shareClicks: 0,
            sharePlatforms: {},
            videoPlays: 0,
            lastViewed: new Date().toISOString(),
            detailedViews: []
        };
        
        allListings.push(listing);
        console.log('Added to allListings array, new count:', allListings.length);
    }

    // STEP 1: Save database FIRST and wait for it to complete
    console.log('');
    console.log('ðŸ“¦ STEP 1: Saving database...');
    const dbSaved = await saveDatabase(false); // Show alert
    
    if (!dbSaved) {
        console.error('âŒ Database save failed, aborting...');
        alert('Failed to save database. Listing page will not be generated.');
        return;
    }
    
    console.log('âœ… Database saved successfully');
    console.log('');

    // STEP 2: Generate listing page
    console.log('ðŸ“„ STEP 2: Generating listing page...');
    const pageGenerated = await generateListingPage(listing);
    
    if (!pageGenerated) {
        console.log('âš ï¸ Page generation failed, but database was saved');
    } else {
        console.log('âœ… Page generated successfully');
    }
    console.log('');

    // STEP 3: Create redirect links
    console.log('ðŸ”— STEP 3: Creating redirect links...');
    try {
        await createLinksRedirect(listing.listingId, slug, categorySlug);
        console.log('âœ… Redirect links created');
    } catch (error) {
        console.error('âš ï¸ Failed to create redirect links:', error);
    }
    console.log('');

    console.log('=== SAVE COMPLETE ===');
    console.log('');
    
    // Close modal and refresh
    document.getElementById('editModal').classList.add('hidden');
    uploadedImages = { logo: null, photos: [] };
    selectedSubcategories = [];
    
// FIXED: Save database function
async function saveDatabase(silent = false) {
    console.log('ðŸ’¾ Starting database save...');
    console.log('Current allListings count:', allListings.length);
    
    try {
        // First, get the current SHA to make sure we have the latest
        console.log('Fetching current database SHA...');
        const getCurrentSha = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${DATABASE_PATH}`, {
            headers: { 'Authorization': `token ${githubToken}` }
        });
        
        if (!getCurrentSha.ok) {
            throw new Error(`Failed to fetch current database: ${getCurrentSha.status}`);
        }
        
        const currentData = await getCurrentSha.json();
        databaseSha = currentData.sha;
        console.log('Current SHA:', databaseSha);
        
        // Create the content
        const databaseContent = { listings: allListings };
        const jsonString = JSON.stringify(databaseContent, null, 2);
        console.log('JSON string length:', jsonString.length);
        
        const content = btoa(unescape(encodeURIComponent(jsonString)));
        console.log('Base64 content length:', content.length);
        
        // Upload to GitHub
        console.log('Uploading to GitHub...');
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${DATABASE_PATH}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${githubToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Update listings database - ${allListings.length} listings`,
                content: content,
                sha: databaseSha
            })
        });

        if (response.ok) {
            const data = await response.json();
            databaseSha = data.content.sha;
            console.log('âœ… Database saved successfully! New SHA:', databaseSha);
            
            if (!silent) {
                alert('âœ… Database saved successfully!');
            }
            
            return true;
        } else {
            const error = await response.json();
            console.error('âŒ Failed to save database:', response.status, error);
            alert(`ERROR: Failed to save database. ${error.message || 'Unknown error'}`);
            return false;
        }
    } catch (error) {
        console.error('âŒ Error in saveDatabase:', error);
        alert(`ERROR: ${error.message}`);
        return false;
    }
}
    
// Image upload handlers
document.getElementById('logoUpload').addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const base64 = event.target.result.split(',')[1];
            uploadedImages.logo = { file: file, base64: base64 };
            document.getElementById('logoPreview').innerHTML = `<img src="${event.target.result}" class="image-preview">`;
        };
        reader.readAsDataURL(file);
    }
});

document.getElementById('photosUpload').addEventListener('change', async (e) => {
    const files = Array.from(e.target.files).slice(0, 15);
    
    for (const file of files) {
        const reader = new FileReader();
        reader.onload = (event) => {
            const base64 = event.target.result.split(',')[1];
            uploadedImages.photos.push({ file: file, base64: base64, url: event.target.result });
            renderPhotosPreview();
        };
        reader.readAsDataURL(file);
    }
});

function renderPhotosPreview() {
    const preview = document.getElementById('photosPreview');
    preview.innerHTML = uploadedImages.photos.map((photo, idx) => `
        <div class="photo-item" data-index="${idx}">
            <div class="photo-number">#${idx + 1}</div>
            <img src="${photo.url}" class="image-preview">
            <div class="delete-photo" onclick="deletePhoto(${idx})">Ã—</div>
        </div>
    `).join('');
    
    if (photosSortable) {
        photosSortable.destroy();
    }
    initPhotosSortable();
}

function initPhotosSortable() {
    const preview = document.getElementById('photosPreview');
    if (preview && preview.children.length > 0) {
        photosSortable = Sortable.create(preview, {
            animation: 150,
            ghostClass: 'sortable-ghost',
            onEnd: function(evt) {
                const oldIndex = evt.oldIndex;
                const newIndex = evt.newIndex;
                const item = uploadedImages.photos.splice(oldIndex, 1)[0];
                uploadedImages.photos.splice(newIndex, 0, item);
                renderPhotosPreview();
            }
        });
    }
}

window.deletePhoto = function(index) {
    uploadedImages.photos.splice(index, 1);
    renderPhotosPreview();
};

async function uploadImage(imageObj, slug, filename, categorySlug) {
    const ext = imageObj.file ? imageObj.file.name.split('.').pop() : 'jpg';
    const folder = filename.includes('logo') ? 'logo' : 'photos';
    const path = `images/${categorySlug}/${slug}/${folder}/${filename}.${ext}`;
    
    try {
        let fileSha = null;
        try {
            const existingFile = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`, {
                headers: { 'Authorization': `token ${githubToken}` }
            });
            if (existingFile.ok) {
                const existingData = await existingFile.json();
                fileSha = existingData.sha;
            }
        } catch (e) {}

        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${path}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${githubToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Upload ${filename} for ${slug}`,
                content: imageObj.base64,
                ...(fileSha && { sha: fileSha })
            })
        });

        if (response.ok) {
            return `https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${path}`;
        }
    } catch (error) {
        console.error('Image upload failed:', error);
    }
    return null;
}

function clearForm() {
    document.querySelectorAll('#editModal input, #editModal textarea, #editModal select').forEach(el => {
        if (el.type === 'checkbox') el.checked = false;
        else if (el.type !== 'file') el.value = '';
    });
    document.getElementById('editCountry').value = 'USA';
    document.getElementById('editTier').value = 'FREE';
    document.getElementById('logoPreview').innerHTML = '';
    document.getElementById('photosPreview').innerHTML = '';
    document.getElementById('taglineCount').textContent = '0';
    uploadedImages = { logo: null, photos: [] };
    selectedSubcategories = [];
    ownerFieldsVisibility = { name: true, title: true, greece: false, email: false, phone: false };
    document.querySelectorAll('.visibility-toggle').forEach(btn => {
        const field = btn.getAttribute('data-field');
        if (ownerFieldsVisibility[field]) {
            btn.className = 'visibility-toggle visible';
            btn.textContent = 'Visible';
        } else {
            btn.className = 'visibility-toggle hidden';
            btn.textContent = 'Hidden';
        }
    });
    document.getElementById('subcategoriesContainer').classList.add('hidden');
}

function fillForm(l) {
    document.getElementById('editBusinessName').value = l.businessName;
    document.getElementById('editTagline').value = l.tagline || '';
    document.getElementById('taglineCount').textContent = (l.tagline || '').length;
    document.getElementById('editDescription').value = l.description || '';
    document.getElementById('editCategory').value = l.category;
    
    selectedSubcategories = l.subcategories || [];
    updateSubcategoriesForCategory();
    
    document.getElementById('editPhone').value = l.phone || '';
    document.getElementById('editAddress').value = l.address || '';
    document.getElementById('editCity').value = l.city || '';
    document.getElementById('editState').value = l.state || 'IL';
    document.getElementById('editZipCode').value = l.zipCode || '';
    document.getElementById('editCountry').value = l.country || 'USA';
    document.getElementById('editEmail').value = l.email || '';
    document.getElementById('editWebsite').value = l.website || '';
    document.getElementById('editTier').value = l.tier || 'FREE';
    document.getElementById('editShowClaim').checked = l.showClaimButton !== false;
    document.getElementById('editPassword').value = l.businessPortalPassword || '';

    const h = l.hours || {};
    document.getElementById('editHoursMonday').value = h.monday || '';
    document.getElementById('editHoursTuesday').value = h.tuesday || '';
    document.getElementById('editHoursWednesday').value = h.wednesday || '';
    document.getElementById('editHoursThursday').value = h.thursday || '';
    document.getElementById('editHoursFriday').value = h.friday || '';
    document.getElementById('editHoursSaturday').value = h.saturday || '';
    document.getElementById('editHoursSunday').value = h.sunday || '';

    if (l.logo) {
        document.getElementById('logoPreview').innerHTML = `<img src="${l.logo}" class="image-preview">`;
    }

    if (l.photos && l.photos.length > 0) {
        uploadedImages.photos = l.photos.map(url => ({ url: url, existing: true }));
        renderPhotosPreview();
    }

    const s = l.socialMedia || {};
    document.getElementById('editFacebook').value = s.facebook || '';
    document.getElementById('editInstagram').value = s.instagram || '';
    document.getElementById('editTwitter').value = s.twitter || '';
    document.getElementById('editYoutube').value = s.youtube || '';
    document.getElementById('editTiktok').value = s.tiktok || '';
    document.getElementById('editLinkedin').value = s.linkedin || '';
    document.getElementById('editOther1').value = s.other1 || '';
    document.getElementById('editOther2').value = s.other2 || '';
    document.getElementById('editOther3').value = s.other3 || '';

    const r = l.reviews || {};
    document.getElementById('editGoogle').value = r.google || '';
    document.getElementById('editYelp').value = r.yelp || '';
    document.getElementById('editTripadvisor').value = r.tripadvisor || '';
    document.getElementById('editReviewOther1').value = r.other1 || '';
    document.getElementById('editReviewOther2').value = r.other2 || '';
    document.getElementById('editReviewOther3').value = r.other3 || '';

    const o = l.ownerInfo || {};
    document.getElementById('editOwnerName').value = o.fullName || '';
    document.getElementById('editOwnerTitle').value = o.title || '';
    document.getElementById('editOwnerGreece').value = o.fromGreece || '';
    document.getElementById('editOwnerEmail').value = o.ownerEmail || '';
    document.getElementById('editOwnerPhone').value = o.ownerPhone || '';
    
    ownerFieldsVisibility = o.visibility || { name: true, title: true, greece: false, email: false, phone: false };
    document.querySelectorAll('.visibility-toggle').forEach(btn => {
        const field = btn.getAttribute('data-field');
        if (ownerFieldsVisibility[field]) {
            btn.className = 'visibility-toggle visible';
            btn.textContent = 'Visible';
        } else {
            btn.className = 'visibility-toggle hidden';
            btn.textContent = 'Hidden';
        }
    });
}

// Delete functionality
window.showDeleteModal = function(id) {
    deletingListingId = id;
    const listing = allListings.find(l => l.id === id);
    document.getElementById('deleteBusinessName').textContent = listing.businessName;
    document.getElementById('deleteConfirmInput').value = '';
    document.getElementById('deleteModal').classList.remove('hidden');
};

document.getElementById('cancelDelete').addEventListener('click', () => {
    document.getElementById('deleteModal').classList.add('hidden');
    deletingListingId = null;
});

document.getElementById('confirmDelete').addEventListener('click', async () => {
    const input = document.getElementById('deleteConfirmInput').value;
    if (input !== 'DELETE') {
        alert('You must type DELETE to confirm');
        return;
    }

    const index = allListings.findIndex(l => l.id === deletingListingId);
    if (index > -1) {
        allListings.splice(index, 1);
        await saveDatabase(false);
        document.getElementById('deleteModal').classList.add('hidden');
        deletingListingId = null;
        alert('Listing deleted successfully');
    }
});

// Analytics functions
window.showAnalytics = function(id) {
    const listing = allListings.find(l => l.id === id);
    document.getElementById('analyticsBusinessName').textContent = listing.businessName;
    document.getElementById('analyticsLastUpdated').textContent = new Date().toLocaleString();
    
    window.currentAnalyticsListing = listing;
    
    document.querySelectorAll('.analytics-tab').forEach(tab => {
        tab.addEventListener('click', () => {
            document.querySelectorAll('.analytics-tab').forEach(t => t.classList.remove('active'));
            tab.classList.add('active');
            renderAnalytics(listing, tab.dataset.tab);
        });
    });
    
    renderAnalytics(listing, 'overview');
    document.getElementById('analyticsModal').classList.remove('hidden');
};

document.getElementById('closeAnalytics').addEventListener('click', () => {
    document.getElementById('analyticsModal').classList.add('hidden');
});

document.getElementById('refreshAnalytics').addEventListener('click', async () => {
    if (window.currentAnalyticsListing) {
        await loadListings();
        const updated = allListings.find(l => l.id === window.currentAnalyticsListing.id);
        if (updated) {
            window.currentAnalyticsListing = updated;
            const activeTab = document.querySelector('.analytics-tab.active').dataset.tab;
            renderAnalytics(updated, activeTab);
            document.getElementById('analyticsLastUpdated').textContent = new Date().toLocaleString();
        }
    }
});

function renderAnalytics(listing, period) {
    const analytics = listing.analytics || {
        views: 0,
        callClicks: 0,
        websiteClicks: 0,
        directionClicks: 0,
        shareClicks: 0,
        sharePlatforms: {},
        lastViewed: 'Never',
        detailedViews: []
    };
    
    const content = document.getElementById('analyticsContent');
    const tier = listing.tier || 'FREE';
    
    if (period === 'overview') {
        let html = `
            <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-8">
                <div class="analytics-stat-card">
                    <div class="text-4xl font-bold mb-2">${analytics.views || 0}</div>
                    <div class="text-sm opacity-90">Total Views</div>
                </div>
                <div class="analytics-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <div class="text-4xl font-bold mb-2">${analytics.callClicks || 0}</div>
                    <div class="text-sm opacity-90">Call Clicks</div>
                </div>
                <div class="analytics-stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                    <div class="text-4xl font-bold mb-2">${analytics.websiteClicks || 0}</div>
                    <div class="text-sm opacity-90">Website Clicks</div>
                </div>
                <div class="analytics-stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                    <div class="text-4xl font-bold mb-2">${analytics.directionClicks || 0}</div>
                    <div class="text-sm opacity-90">Direction Clicks</div>
                </div>`;
        
        if (tier === 'FEATURED' || tier === 'PREMIUM') {
            html += `
                <div class="analytics-stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                    <div class="text-4xl font-bold mb-2">${analytics.shareClicks || 0}</div>
                    <div class="text-sm opacity-90">Total Shares</div>
                </div>`;
        }
        
        html += `
                <div class="analytics-stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                    <div class="text-lg font-bold mb-2">${analytics.lastViewed ? new Date(analytics.lastViewed).toLocaleString() : 'Never'}</div>
                    <div class="text-sm opacity-90">Last Viewed</div>
                </div>
            </div>`;
        
        if (tier === 'PREMIUM' && analytics.sharePlatforms && Object.keys(analytics.sharePlatforms).length > 0) {
            html += `
                <h3 class="text-xl font-bold text-gray-900 mb-4">Share Platform Breakdown</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">`;
            
            Object.entries(analytics.sharePlatforms).forEach(([platform, count]) => {
                html += `
                    <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold mb-1">${count}</div>
                        <div class="text-sm opacity-90 capitalize">${platform}</div>
                    </div>`;
            });
            
            html += `</div>`;
        }
        
        html += `
            <h3 class="text-xl font-bold text-gray-900 mb-4">Recent Activity</h3>
            <div class="bg-gray-50 rounded-lg overflow-hidden">
                ${renderDetailedViews(analytics.detailedViews || [], 'alltime')}
            </div>
        `;
        
        content.innerHTML = html;
    } else {
        const filteredViews = filterViewsByPeriod(analytics.detailedViews || [], period);
        const stats = calculatePeriodStats(filteredViews);
        
        let html = `
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-8">
                <div class="bg-gradient-to-br from-purple-500 to-purple-700 text-white p-6 rounded-lg">
                    <div class="text-3xl font-bold mb-1">${stats.views}</div>
                    <div class="text-sm opacity-90">Views</div>
                </div>
                <div class="bg-gradient-to-br from-pink-500 to-red-600 text-white p-6 rounded-lg">
                    <div class="text-3xl font-bold mb-1">${stats.callClicks}</div>
                    <div class="text-sm opacity-90">Calls</div>
                </div>
                <div class="bg-gradient-to-br from-blue-500 to-cyan-400 text-white p-6 rounded-lg">
                    <div class="text-3xl font-bold mb-1">${stats.websiteClicks}</div>
                    <div class="text-sm opacity-90">Website</div>
                </div>
                <div class="bg-gradient-to-br from-green-500 to-emerald-400 text-white p-6 rounded-lg">
                    <div class="text-3xl font-bold mb-1">${stats.directionClicks}</div>
                    <div class="text-sm opacity-90">Directions</div>
                </div>`;
        
        if (tier === 'FEATURED' || tier === 'PREMIUM') {
            html += `
                <div class="bg-gradient-to-br from-yellow-500 to-orange-500 text-white p-6 rounded-lg">
                    <div class="text-3xl font-bold mb-1">${stats.shareClicks}</div>
                    <div class="text-sm opacity-90">Shares</div>
                </div>`;
        }
        
        html += `</div>`;
        
        if (tier === 'PREMIUM' && stats.sharePlatforms && Object.keys(stats.sharePlatforms).length > 0) {
            html += `
                <h3 class="text-xl font-bold text-gray-900 mb-4">Share Platforms (${period})</h3>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">`;
            
            Object.entries(stats.sharePlatforms).forEach(([platform, count]) => {
                html += `
                    <div class="bg-gradient-to-br from-indigo-500 to-purple-500 text-white p-4 rounded-lg">
                        <div class="text-2xl font-bold mb-1">${count}</div>
                        <div class="text-sm opacity-90 capitalize">${platform}</div>
                    </div>`;
            });
            
            html += `</div>`;
        }
        
        html += `
            <h3 class="text-xl font-bold text-gray-900 mb-4">Detailed Activity</h3>
            <div class="bg-gray-50 rounded-lg overflow-hidden">
                ${renderDetailedViews(filteredViews, period)}
            </div>
        `;
        
        content.innerHTML = html;
    }
}

function renderDetailedViews(views, period) {
    if (!views || views.length === 0) {
        return '<div class="p-8 text-center text-gray-500">No activity recorded for this period</div>';
    }
    
    return views.slice(0, 100).map(view => `
        <div class="analytics-detail-row">
            <div class="flex items-center justify-between">
                <div>
                    <div class="font-semibold text-gray-900">${view.action}${view.platform ? ` (${view.platform})` : ''}</div>
                    <div class="text-sm text-gray-600">${new Date(view.timestamp).toLocaleString()}</div>
                </div>
                <div class="text-sm text-gray-500">
                    ${view.userAgent ? view.userAgent.substring(0, 50) + '...' : 'Unknown device'}
                </div>
            </div>
        </div>
    `).join('') + (views.length > 100 ? `<div class="p-4 text-center text-gray-500">... and ${views.length - 100} more</div>` : '');
}

function filterViewsByPeriod(views, period) {
    const now = new Date();
    const periodMap = {
        'today': 1,
        'yesterday': 2,
        'week': 7,
        'month': 30,
        'alltime': Infinity
    };
    
    const days = periodMap[period] || Infinity;
    if (days === Infinity) return views;
    
    const cutoff = new Date(now - days * 24 * 60 * 60 * 1000);
    
    if (period === 'yesterday') {
        const yesterday = new Date(now);
        yesterday.setDate(yesterday.getDate() - 1);
        yesterday.setHours(0, 0, 0, 0);
        const yesterdayEnd = new Date(yesterday);
        yesterdayEnd.setHours(23, 59, 59, 999);
        
        return views.filter(v => {
            const vDate = new Date(v.timestamp);
            return vDate >= yesterday && vDate <= yesterdayEnd;
        });
    } else if (period === 'today') {
        const today = new Date(now);
        today.setHours(0, 0, 0, 0);
        return views.filter(v => new Date(v.timestamp) >= today);
    }
    
    return views.filter(v => new Date(v.timestamp) >= cutoff);
}

function calculatePeriodStats(views) {
    const stats = {
        views: views.filter(v => v.action === 'view').length,
        callClicks: views.filter(v => v.action === 'call').length,
        websiteClicks: views.filter(v => v.action === 'website').length,
        directionClicks: views.filter(v => v.action === 'directions').length,
        shareClicks: views.filter(v => v.action === 'share').length,
        sharePlatforms: {}
    };
    
    views.filter(v => v.action === 'share' && v.platform).forEach(v => {
        stats.sharePlatforms[v.platform] = (stats.sharePlatforms[v.platform] || 0) + 1;
    });
    
    return stats;
}
// FIXED: Generate listing HTML page with better error handling
async function generateListingPage(listing) {
    console.log('Starting page generation for:', listing.businessName);
    
    try {
        // Fetch template
        console.log('Fetching template...');
        const templateResponse = await fetch(`https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/listing-template.html`);
        
        if (!templateResponse.ok) {
            console.error('Template fetch failed:', templateResponse.status, templateResponse.statusText);
            alert('ERROR: Could not fetch listing template. Make sure listing-template.html exists in your repo.');
            return false;
        }
        
        let template = await templateResponse.text();
        console.log('Template fetched successfully, length:', template.length);

        const isBasedIn = listing.city && listing.state && !listing.address;
        const fullAddress = isBasedIn ? `${listing.city}, ${listing.state}` : 
            (listing.city && listing.state ? 
                `${listing.address}, ${listing.city}, ${listing.state} ${listing.zipCode || ''}`.trim() : 
                listing.address);

        const mapsAddress = fullAddress.replace(/\s+/g, '+').replace(/,/g, '');
        const majorCities = ['chicago', 'new york', 'los angeles', 'san francisco', 'boston', 'philadelphia', 'miami', 'atlanta', 'seattle', 'portland', 'denver'];
        const chicagoSuburbs = ['evanston', 'skokie', 'oak park', 'naperville', 'schaumburg', 'arlington heights', 'deerfield', 'downers grove'];
        const city = (listing.city || '').toLowerCase();
        const needsState = !majorCities.includes(city) && !chicagoSuburbs.includes(city);
        const cityState = listing.city ? (needsState ? ` - ${listing.city}, ${listing.state}` : ` - ${listing.city}`) : '';
        const inCity = listing.city ? ` in ${listing.city}` : '';

        // Build carousel HTML
        let carouselHTML = '';
        let carouselControls = '';
        if (listing.photos && listing.photos.length > 0) {
            carouselHTML = listing.photos.map(p => `<div class="carousel-slide"><img src="${p}" alt="${listing.businessName}" class="w-full h-full object-cover"></div>`).join('');
            if (listing.photos.length > 1) {
                const dots = listing.photos.map((_, i) => `<div class="carousel-dot ${i === 0 ? 'active' : ''}" onclick="goToSlide(${i})"></div>`).join('');
                carouselControls = `<div class="carousel-nav carousel-prev" onclick="prevSlide()">â€¹</div><div class="carousel-nav carousel-next" onclick="nextSlide()">â€º</div><div class="carousel-dots">${dots}</div>`;
            }
        } else {
            carouselHTML = `<div class="carousel-slide"><img src="${listing.logo}" alt="${listing.businessName}" class="w-full h-full object-cover"></div>`;
        }

        // Build status badges
        let statusBadges = '';
        if (listing.verified) {
            statusBadges += '<span class="badge badge-verified">Verified</span>';
        }
        if (!listing.showClaimButton && listing.tier === 'FREE') {
            statusBadges += '<span class="badge badge-claimed">Claimed</span>';
        }
        if (listing.tier === 'FEATURED' || listing.tier === 'PREMIUM') {
            statusBadges += '<span class="badge badge-featured">Featured</span>';
        }
        if (listing.hours && Object.values(listing.hours).some(h => h)) {
            statusBadges += '<span class="badge" id="openClosedBadge"></span>';
        }

        const descriptionParagraphs = (listing.description || '')
            .split('\n')
            .filter(p => p.trim())
            .map(p => `<p class="mb-3">${p}</p>`)
            .join('');

        // Build social media HTML
        let socialHTML = '';
        if (listing.socialMedia) {
            const icons = [];
            const s = listing.socialMedia;
            
            if (s.facebook) icons.push(`<a href="https://www.facebook.com/${s.facebook}" target="_blank" rel="noopener noreferrer" class="social-icon social-facebook" title="Facebook"><svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M24 12.073c0-6.627-5.373-12-12-12s-12 5.373-12 12c0 5.99 4.388 10.954 10.125 11.854v-8.385H7.078v-3.47h3.047V9.43c0-3.007 1.792-4.669 4.533-4.669 1.312 0 2.686.235 2.686.235v2.953H15.83c-1.491 0-1.956.925-1.956 1.874v2.25h3.328l-.532 3.47h-2.796v8.385C19.612 23.027 24 18.062 24 12.073z"/></svg></a>`);
            if (s.instagram) icons.push(`<a href="https://www.instagram.com/${s.instagram}" target="_blank" rel="noopener noreferrer" class="social-icon social-instagram" title="Instagram"><svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163c0-3.403-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"/></svg></a>`);
            if (s.twitter) icons.push(`<a href="https://twitter.com/${s.twitter}" target="_blank" rel="noopener noreferrer" class="social-icon social-twitter" title="X / Twitter"><svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M18.244 2.25h3.308l-7.227 8.26 8.502 11.24H16.17l-5.214-6.817L4.99 21.75H1.68l7.73-8.835L1.254 2.25H8.08l4.713 6.231zm-1.161 17.52h1.833L7.084 4.126H5.117z"/></svg></a>`);
            if (s.youtube) icons.push(`<a href="https://www.youtube.com/@${s.youtube}" target="_blank" rel="noopener noreferrer" class="social-icon social-youtube" title="YouTube"><svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814zM9.545 15.568V8.432L15.818 12l-6.273 3.568z"/></svg></a>`);
            if (s.tiktok) icons.push(`<a href="https://www.tiktok.com/@${s.tiktok}" target="_blank" rel="noopener noreferrer" class="social-icon social-tiktok" title="TikTok"><svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M12.525.02c1.31-.02 2.61-.01 3.91-.02.08 1.53.63 3.09 1.75 4.17 1.12 1.11 2.7 1.62 4.24 1.79v4.03c-1.44-.05-2.89-.35-4.2-.97-.57-.26-1.1-.59-1.62-.93-.01 2.92.01 5.84-.02 8.75-.08 1.4-.54 2.79-1.35 3.94-1.31 1.92-3.58 3.17-5.91 3.21-1.43.08-2.86-.31-4.08-1.03-2.02-1.19-3.44-3.37-3.65-5.71-.02-.5-.03-1-.01-1.49.18-1.9 1.12-3.72 2.58-4.96 1.66-1.44 3.98-2.13 6.15-1.72.02 1.48-.04 2.96-.04 4.44-.99-.32-2.15-.23-3.02.37-.63.41-1.11 1.04-1.36 1.75-.21.51-.15 1.07-.14 1.61.24 1.64 1.82 3.02 3.5 2.87 1.12-.01 2.19-.66 2.77-1.61.19-.33.40-.67.41-1.06.1-1.79.06-3.57.07-5.36.01-4.03-.01-8.05.02-12.07z"/></svg></a>`);
            if (s.linkedin) icons.push(`<a href="${s.linkedin}" target="_blank" rel="noopener noreferrer" class="social-icon social-linkedin" title="LinkedIn"><svg width="22" height="22" fill="currentColor" viewBox="0 0 24 24"><path d="M20.447 20.452h-3.554v-5.569c0-1.328-.027-3.037-1.852-3.037-1.853 0-2.136 1.445-2.136 2.939v5.667H9.351V9h3.414v1.561h.046c.477-.9 1.637-1.85 3.37-1.85 3.601 0 4.267 2.37 4.267 5.455v6.286zM5.337 7.433c-1.144 0-2.063-.926-2.063-2.065 0-1.138.92-2.063 2.063-2.063 1.14 0 2.064.925 2.064 2.063 0 1.139-.925 2.065-2.064 2.065zm1.782 13.019H3.555V9h3.564v11.452zM22.225 0H1.771C.792 0 0 .774 0 1.729v20.542C0 23.227.792 24 1.771 24h20.451C23.2 24 24 23.227 24 22.271V1.729C24 .774 23.2 0 22.222 0h.003z"/></svg></a>`);
            
            if (icons.length > 0) {
                socialHTML = `<div class="mb-6"><h2 class="text-xl font-bold text-gray-900 mb-3">Follow Us!</h2><div class="flex flex-wrap gap-2">${icons.join('')}</div></div>`;
            }
        }

        // Build review HTML (shortened for space)
        let reviewHTML = '';
        if (listing.reviews) {
            const reviewIcons = [];
            const r = listing.reviews;
            if (r.google) reviewIcons.push(`<a href="${r.google}" target="_blank" rel="noopener noreferrer" class="social-icon social-google" title="Google Reviews"><svg width="22" height="22" viewBox="0 0 24 24"><path d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z" fill="#4285F4"/><path d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z" fill="#34A853"/><path d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z" fill="#FBBC05"/><path d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z" fill="#EA4335"/></svg></a>`);
            if (r.yelp) reviewIcons.push(`<a href="${r.yelp}" target="_blank" rel="noopener noreferrer" class="social-icon social-yelp" title="Yelp"><svg width="22" height="22"><use href="#yelp-icon"/></svg></a>`);
            if (r.tripadvisor) reviewIcons.push(`<a href="${r.tripadvisor}" target="_blank" rel="noopener noreferrer" class="social-icon social-tripadvisor" title="TripAdvisor"><svg width="22" height="22"><use href="#tripadvisor-icon"/></svg></a>`);
            
            if (reviewIcons.length > 0) {
                reviewHTML = `<div class="mb-8"><h2 class="text-xl font-bold text-gray-900 mb-3">Reviews</h2><div class="flex flex-wrap gap-2">${reviewIcons.join('')}</div></div>`;
            }
        }

        // Build hours HTML
        let hoursHTML = '';
        let hoursJSON = 'null';
        if (listing.hours && Object.values(listing.hours).some(h => h)) {
            hoursJSON = JSON.stringify(listing.hours);
            const days = ['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'];
            const hoursLines = days.map(day => {
                const h = listing.hours[day.toLowerCase()];
                return h ? `<div class="flex justify-between"><span class="font-medium">${day}:</span><span>${h}</span></div>` : '';
            }).filter(Boolean).join('');
            hoursHTML = `<div class="flex items-start gap-3"><span class="mt-1">ðŸ•’</span><div class="flex-1"><p class="font-semibold text-gray-900">Hours</p><div class="space-y-1">${hoursLines}</div><div class="hours-disclaimer">These are normal operating hours. To find special hours, visit this listing's website or socials, or contact them directly.</div></div></div>`;
        }

        const addressLabel = isBasedIn ? 'Based In' : 'Address';
        const addressSection = fullAddress ? `<div class="flex items-start gap-3"><span class="mt-1">ðŸ“</span><div><p class="font-semibold text-gray-900">${addressLabel}</p><p class="text-gray-700">${fullAddress}</p></div></div>` : '';
        const phoneSection = listing.phone ? `<div class="flex items-start gap-3"><span class="mt-1">ðŸ“ž</span><div><p class="font-semibold text-gray-900">Phone</p><a href="tel:${listing.phone}" class="text-blue-600 hover:underline">${listing.phone}</a></div></div>` : '';
        const phoneButton = listing.phone ? `<a href="tel:${listing.phone}" onclick="trackClick('call')" class="flex items-center gap-2 px-4 py-2 text-white rounded-lg font-medium" style="background-color:#055193;"><span>ðŸ“ž</span><span>Call</span></a>` : '';
        const directionsButton = !isBasedIn && listing.address ? `<a href="https://www.google.com/maps/place/${mapsAddress}" target="_blank" rel="noopener noreferrer" onclick="trackClick('directions')" class="flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-900 rounded-lg font-medium"><span>ðŸ“</span><span>Directions</span></a>` : '';

        let mapHTML = '';
        let coordinates = '';
        if (listing.address && !isBasedIn) {
            mapHTML = `<div class="bg-white rounded-lg p-4 card-shadow"><h2 class="text-xl font-bold text-gray-900 mb-3">Location</h2><div id="listingMap"></div></div>`;
            if (listing.coordinates) {
                coordinates = `${listing.coordinates.lat},${listing.coordinates.lng}`;
            }
        }

        const claimButton = listing.showClaimButton !== false ? 
            `<a href="mailto:contact@thegreekdirectory.org?subject=Claim%20My%20Listing%3A%20${encodeURIComponent(listing.businessName)}%20-%20${encodeURIComponent(listing.city)}%2C%20${encodeURIComponent(listing.state)}%2C%20${encodeURIComponent(listing.country)}" class="fixed bottom-6 right-6 px-6 py-3 text-white rounded-lg font-medium shadow-lg hover:shadow-xl transition-all z-50" style="background-color: #055193;">ðŸ“ Claim this Listing</a>` : 
            '';

        const keywords = `greek, greek american, hellenic, ${listing.businessName}, ${listing.category}, ${listing.city}, ${listing.state}, ${listing.zipCode}, ${listing.country}, ${fullAddress}, ${listing.phone || ''}, ${listing.website || ''}, ${listing.tagline || ''}`;
        const categorySlug = listing.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        const listingUrl = `https://thegreekdirectory.org/listings/${categorySlug}/${listing.slug}`;
        const websiteDomain = listing.website ? new URL(listing.website).hostname : '';
        
        // Replace all template variables
        console.log('Replacing template variables...');
        template = template
            .replace(/{{BUSINESS_NAME}}/g, listing.businessName)
            .replace(/{{CITY_STATE}}/g, cityState)
            .replace(/{{IN_CITY}}/g, inCity)
            .replace(/{{TAGLINE}}/g, listing.tagline || listing.description.substring(0, 150))
            .replace(/{{TAGLINE_DISPLAY}}/g, listing.tagline ? `<p class="text-lg text-gray-600 italic">"${listing.tagline}"</p>` : '')
            .replace(/{{DESCRIPTION}}/g, descriptionParagraphs)
            .replace(/{{CATEGORY}}/g, listing.category)
            .replace(/{{FULL_ADDRESS}}/g, fullAddress)
            .replace(/{{PHONE}}/g, listing.phone || '')
            .replace(/{{LOGO}}/g, listing.logo)
            .replace(/{{SLUG}}/g, listing.slug)
            .replace(/{{LISTING_ID}}/g, listing.id)
            .replace(/{{KEYWORDS}}/g, keywords)
            .replace(/{{LISTING_URL}}/g, listingUrl)
            .replace(/{{WEBSITE_DOMAIN}}/g, websiteDomain)
            .replace(/{{BUSINESS_NAME_ENCODED}}/g, encodeURIComponent(listing.businessName))
            .replace(/{{PHOTOS_SLIDES}}/g, carouselHTML)
            .replace(/{{CAROUSEL_CONTROLS}}/g, carouselControls)
            .replace(/{{TOTAL_PHOTOS}}/g, listing.photos ? listing.photos.length : 1)
            .replace(/{{STATUS_BADGES}}/g, statusBadges)
            .replace(/{{HOURS_JSON}}/g, hoursJSON)
            .replace(/{{ADDRESS_SECTION}}/g, addressSection)
            .replace(/{{PHONE_SECTION}}/g, phoneSection)
            .replace(/{{EMAIL_SECTION}}/g, listing.email ? `<div class="flex items-start gap-3"><span class="mt-1">ðŸ“§</span><div><p class="font-semibold text-gray-900">Email</p><a href="mailto:${listing.email}" class="text-blue-600 hover:underline">${listing.email}</a></div></div>` : '')
            .replace(/{{WEBSITE_SECTION}}/g, listing.website ? `<div class="flex items-start gap-3"><span class="mt-1">ðŸŒ</span><div><p class="font-semibold text-gray-900">Website</p><a href="${listing.website}" target="_blank" onclick="trackClick('website')" class="text-blue-600 hover:underline break-all">${listing.website}</a></div></div>` : '')
            .replace(/{{HOURS_SECTION}}/g, hoursHTML)
            .replace(/{{PHONE_BUTTON}}/g, phoneButton)
            .replace(/{{EMAIL_BUTTON}}/g, listing.email ? `<a href="mailto:${listing.email}" class="flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-900 rounded-lg font-medium"><span>ðŸ“§</span><span>Email</span></a>` : '')
            .replace(/{{WEBSITE_BUTTON}}/g, listing.website ? `<a href="${listing.website}" target="_blank" onclick="trackClick('website')" class="flex items-center gap-2 px-4 py-2 bg-gray-200 text-gray-900 rounded-lg font-medium"><span>ðŸŒ</span><span>Visit Website</span></a>` : '')
            .replace(/{{DIRECTIONS_BUTTON}}/g, directionsButton)
            .replace(/{{SOCIAL_MEDIA_SECTION}}/g, socialHTML)
            .replace(/{{REVIEW_SECTION}}/g, reviewHTML)
            .replace(/{{MAP_SECTION}}/g, mapHTML)
            .replace(/{{COORDINATES}}/g, coordinates)
            .replace(/{{CLAIM_BUTTON}}/g, claimButton);

        // Save HTML file
        const htmlPath = `listings/${categorySlug}/${listing.slug}.html`;
        console.log('Saving to path:', htmlPath);
        
        let fileSha = null;
        try {
            const existingFile = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${htmlPath}`, {
                headers: { 'Authorization': `token ${githubToken}` }
            });
            if (existingFile.ok) {
                const existingData = await existingFile.json();
                fileSha = existingData.sha;
                console.log('Found existing file, will update');
            }
        } catch (e) {
            console.log('No existing file, will create new');
        }

        const htmlContent = btoa(unescape(encodeURIComponent(template)));
        console.log('Uploading HTML file...');
        
        const htmlResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${htmlPath}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${githubToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Generate listing page for ${listing.businessName}`,
                content: htmlContent,
                ...(fileSha && { sha: fileSha })
            })
        });

        if (htmlResponse.ok) {
            console.log('âœ… Listing page generated successfully!');
            return true;
        } else {
            const errorData = await htmlResponse.json();
            console.error('âŒ Failed to save HTML file:', htmlResponse.status, errorData);
            alert(`ERROR: Failed to save listing page. ${errorData.message || 'Unknown error'}`);
            return false;
        }
    } catch (error) {
        console.error('âŒ Error generating listing page:', error);
        alert(`ERROR: ${error.message}`);
        return false;
    }
}
    
// Check for URL redirect on page load
document.addEventListener('DOMContentLoaded', () => {
    const urlParams = new URLSearchParams(window.location.search);
    const slug = urlParams.get('slug');
    
    if (slug && githubToken) {
        const checkListings = setInterval(() => {
            if (allListings.length > 0) {
                clearInterval(checkListings);
                const listing = allListings.find(l => l.slug === slug);
                if (listing) {
                    editListing(listing.id);
                }
            }
        }, 500);
    }
});
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Portal - The Greek Directory</title>
    <link rel="icon" href="https://social.thegreekdirectory.org/Logo2.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .hidden { display: none !important; }
        .image-preview { 
            width: 100px; 
            height: 100px; 
            object-fit: contain;
            background: #f3f4f6;
            border-radius: 8px; 
            border: 2px solid #e5e7eb; 
            pointer-events: none; 
            user-select: none; 
            -webkit-user-drag: none; 
        }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
        .upload-progress { display: none; background: #eff6ff; border: 1px solid #3b82f6; padding: 12px; border-radius: 8px; margin-top: 8px; }
        .sortable-ghost { opacity: 0.4; }
        .photo-item { position: relative; cursor: move; }
        .photo-item .delete-photo { position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
        .photo-item .photo-number { position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7); color: white; border-radius: 4px; padding: 2px 6px; font-size: 12px; font-weight: bold; }
        .owner-field { display: flex; gap: 8px; align-items: center; }
        .visibility-toggle { cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 12px; transition: all 0.2s; }
        .visibility-toggle.visible { background: #10b981; color: white; }
        .visibility-toggle.hidden { background: #ef4444; color: white; }
        img { pointer-events: none; user-select: none; -webkit-user-drag: none; }
        .analytics-tab { padding: 8px 16px; cursor: pointer; border-bottom: 2px solid transparent; transition: all 0.2s; }
        .analytics-tab.active { border-bottom-color: #055193; color: #055193; font-weight: 600; }
        .analytics-stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; }
        .analytics-detail-row { padding: 12px; border-bottom: 1px solid #e5e7eb; }
        .analytics-detail-row:hover { background: #f9fafb; }
        .subcategory-checkbox { display: flex; align-items: center; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; margin: 4px; cursor: pointer; transition: all 0.2s; }
        .subcategory-checkbox:hover { background: #f3f4f6; }
        .subcategory-checkbox input[type="checkbox"] { margin-right: 8px; }
        .subcategory-checkbox input[type="checkbox"]:checked + label { font-weight: 600; color: #055193; }
        .disabled-field { opacity: 0.6; pointer-events: none; background: #f3f4f6; }
        .info-notice { font-size: 12px; color: #6b7280; margin-top: 4px; font-style: italic; }
    </style>
    
    <svg width="0" height="0" class="hidden">
      <symbol version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2400 3160" id="yelp-icon">
        <path d="M0 0 C3.36669602 0.00318677 6.73253066 -0.02054504 10.09912109 -0.0456543 C29.31999973 -0.10118676 48.21577968 1.40188287 66.60302734 7.31567383 C67.22806152 7.51499512 67.8530957 7.71431641 68.49707031 7.91967773 C84.33909829 13.08374156 99.35811382 20.92210785 111.60302734 32.31567383 C112.11671875 32.78312012 112.63041016 33.25056641 113.15966797 33.73217773 C131.861949 50.87593534 143.67945252 72.73038835 145.83374023 98.19848633 C145.92831701 99.22470596 146.02289379 100.2509256 146.12033653 101.3082428 C146.4283003 104.68487939 146.72124033 108.06261714 147.01318359 111.44067383 C147.22883073 113.85908718 147.44490934 116.2774621 147.66139221 118.69580078 C149.89670328 143.89297233 151.85423632 169.11198735 153.74247742 194.33719254 C154.0491887 198.43128878 154.35740654 202.52526948 154.66589355 206.61923218 C161.86665442 302.2451326 168.55969677 397.91005406 218.91466141 1172.88392258 C219.07897372 1175.7472199 219.24368094 1178.61049397 219.40882492 1181.47374344 C221.15142342 1211.68913589 222.78217004 1241.90910205 224.21677661 1272.14068913 C224.31578591 1274.21342713 224.41665947 1276.28606609 224.51809883 1278.35868645 C227.54999537 1340.80697901 228.53435634 1419.04195046 184.54492188 1469.11352539 C182.29557868 1471.58342365 179.96396447 1473.95140675 177.60302734 1476.31567383 C176.74064453 1477.1896582 175.87826172 1478.06364258 174.98974609 1478.96411133 C153.37684255 1499.77653697 120.17667551 1509.7420006 90.66040039 1509.61645508 C48.12239429 1508.76894878 13.72476032 1483.00753198 -15.39697266 1454.31567383 C-17.27408899 1452.32794171 -19.06411774 1450.31573279 -20.81103516 1448.21411133 C-22.68543065 1445.97037682 -24.66482748 1443.8397365 -26.64697266 1441.69067383 C-42.48611343 1424.0856829 -55.70209563 1404.2424685 -68.39697266 1384.31567383 C-68.96029297 1383.43363281 -69.52361328 1382.5515918 -70.10400391 1381.64282227 C-73.61914584 1376.13801478 -77.12290719 1370.62605884 -80.62207031 1365.11108398 C-82.99448722 1361.37460894 -85.37271988 1357.64185083 -87.75073242 1353.90893555 C-93.13990593 1345.44819313 -98.51083871 1336.97627059 -103.86279297 1328.49194336 C-110.01218487 1318.74830293 -116.20658614 1309.03329803 -122.39697266 1299.31567383 C-129.57149376 1288.05316224 -136.73832405 1276.78619639 -143.86279297 1265.49194336 C-150.01218487 1255.74830293 -156.20658614 1246.03329803 -162.39697266 1236.31567383 C-169.57007367 1225.05539148 -176.73616269 1213.79107432 -183.85839844 1202.49853516 C-187.68927958 1196.42779877 -191.54034197 1190.37007876 -195.39697266 1184.31567383 C-200.23468895 1176.72109301 -205.05440337 1169.115523 -209.85791016 1161.49926758 C-213.68899624 1155.4283137 -217.54018434 1149.37032622 -221.39697266 1143.31567383 C-226.23468895 1135.72109301 -231.05440337 1128.115523 -235.85791016 1120.49926758 C-239.68899624 1114.4283137 -243.54018434 1108.37032622 -247.39697266 1102.31567383 C-252.23468895 1094.72109301 -257.05440337 1087.115523 -261.85791016 1079.49926758 C-265.68899624 1073.4283137 -269.54018434 1067.37032622 -273.39697266 1061.31567383 C-278.23468895 1053.72109301 -283.05440337 1046.115523 -287.85791016 1038.49926758 C-291.68899624 1032.4283137 -295.54018434 1026.37032622 -299.39697266 1020.31567383 C-304.23468895 1012.72109301 -309.05440337 1005.115523 -313.85791016 997.49926758 C-317.68899624 991.4283137 -321.54018434 985.37032622 -325.39697266 979.31567383 C-330.23468895 971.72109301 -335.05440337 964.115523 -339.85791016 956.49926758 C-343.68899624 950.4283137 -347.54018434 944.37032622 -351.39697266 938.31567383 C-356.23468895 930.72109301 -361.05440337 923.115523 -365.85791016 915.49926758 C-369.68899634 909.42831354 -373.54021762 903.37034755 -377.39697266 897.31567383 C-384.24575067 886.56281128 -391.05543619 875.78562021 -397.85595703 865.00219727 C-403.68441877 855.76147855 -409.52781277 846.53060822 -415.39697266 837.31567383 C-421.26329792 828.10518997 -427.10370283 818.8786838 -432.92919922 809.64233398 C-435.41680623 805.69907138 -437.9070368 801.75746615 -440.39697266 797.81567383 C-441.3969849 796.23234823 -442.39698491 794.6490149 -443.39697266 793.06567383 C-443.89197266 792.28192383 -444.38697266 791.49817383 -444.89697266 790.69067383 C-449.39697265 783.56567384 -449.39697265 783.56567384 -450.89648438 781.19140625 C-451.89806301 779.60560058 -452.89969073 778.01982591 -453.90136719 776.43408203 C-456.3776145 772.51382626 -458.85304966 768.59306275 -461.32666016 764.67114258 C-466.6658052 756.20802968 -472.02137465 747.75568635 -477.39697266 739.31567383 C-483.26329792 730.10518997 -489.10370283 720.8786838 -494.92919922 711.64233398 C-497.41680623 707.69907138 -499.9070368 703.75746615 -502.39697266 699.81567383 C-503.3969849 698.23234823 -504.39698491 696.6490149 -505.39697266 695.06567383 C-505.89197266 694.28192383 -506.38697266 693.49817383 -506.89697266 692.69067383 C-520.39697266 671.31567383 -533.89697266 649.94067383 -547.39697266 628.56567383 C-547.89173096 627.78232666 -548.38648926 626.99897949 -548.89624023 626.19189453 C-549.89875509 624.60453857 -550.9011962 623.01713604 -551.90356445 621.4296875 C-554.36449228 617.53251987 -556.82658977 613.63610282 -559.29150391 609.74145508 C-564.81350967 601.0129737 -570.30528869 592.26642112 -575.77197266 583.50317383 C-581.81785872 573.81399634 -587.92862755 564.16792255 -594.06884766 554.53833008 C-602.39414784 541.48143628 -610.62304911 528.36492213 -618.82373047 515.22949219 C-624.64827855 505.90379661 -630.5161801 496.60596865 -636.39697266 487.31567383 C-644.80192986 474.03778149 -653.15233274 460.72672322 -661.47363281 447.39624023 C-664.61286489 442.36820896 -667.75504417 437.34202042 -670.89697266 432.31567383 C-672.14698729 430.31568298 -673.39698728 428.31568297 -674.64697266 426.31567383 C-675.57509766 424.83067383 -675.57509766 424.83067383 -676.52197266 423.31567383 C-678.39697266 420.31567383 -680.27197266 417.31567383 -682.14697266 414.31567383 C-682.76580322 413.32559326 -683.38463379 412.3355127 -684.0222168 411.31542969 C-685.27157858 409.31635321 -686.52076492 407.31716708 -687.76977539 405.31787109 C-690.90310719 400.30282511 -694.03951005 395.28974996 -697.18212891 390.28051758 C-705.1252134 377.61177458 -712.9748114 364.89109861 -720.70947266 352.09399414 C-722.40474285 349.30288089 -724.11773028 346.52330919 -725.83447266 343.74536133 C-726.91795807 341.97722535 -728.00129795 340.20900017 -729.08447266 338.44067383 C-729.57778076 337.65080078 -730.07108887 336.86092773 -730.5793457 336.04711914 C-741.56028108 318.01072572 -740.40892504 294.85746672 -735.65478516 274.89770508 C-731.13942178 257.71284748 -722.51473027 242.06998092 -711.39697266 228.31567383 C-710.98656738 227.7984375 -710.57616211 227.28120117 -710.15332031 226.74829102 C-705.04601332 220.3174501 -699.83927285 214.43451337 -693.39697266 209.31567383 C-692.37990234 208.48551758 -691.36283203 207.65536133 -690.31494141 206.80004883 C-676.2590188 195.43641476 -661.15216634 186.12681469 -645.39697266 177.31567383 C-644.48802246 176.80633301 -643.57907227 176.29699219 -642.64257812 175.7722168 C-605.7055344 155.17551733 -566.77705695 138.6187875 -527.39697266 123.31567383 C-525.63643555 122.63045654 -525.63643555 122.63045654 -523.84033203 121.93139648 C-505.6256896 114.86934229 -487.26269516 108.26529577 -468.81152344 101.8527832 C-465.91183912 100.84468328 -463.01443774 99.83044504 -460.11914062 98.80981445 C-387.31728912 73.1580123 -312.60963977 52.31847368 -65.58447266 4.00317383 C-64.31369873 3.85581787 -63.0429248 3.70846191 -61.73364258 3.55664062 C-57.62456765 3.10524794 -53.51310589 2.69600232 -49.39697266 2.31567383 C-48.47140564 2.22953827 -47.54583862 2.14340271 -46.59222412 2.05465698 C-31.04988905 0.64433687 -15.60545992 -0.03074182 0 0 Z " fill="#BE2418" transform="translate(993.39697265625,4.684326171875)"></path>
      </symbol>
      <symbol version="1.1" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 366 366" id="tripadvisor-icon">
        <path d="M0 0 C0.75812988 0.2367041 1.51625977 0.4734082 2.29736328 0.71728516 C21.53481034 6.90381292 40.24761047 16.2741664 56 29 C56.86262451 29.69561035 56.86262451 29.69561035 57.74267578 30.40527344 C95.54856688 61.23906203 120.5015571 103.78730568 126.3125 152.62646484 C131.31586266 202.41885785 117.58638501 250.9631596 85.92578125 289.8125 C55.32289446 326.57700906 11.7598783 350.5920067 -36.03222656 355.53564453 C-85.82962503 359.74960909 -134.09026863 345.4654487 -172.60253906 313.44604492 C-175.45328573 311.01976893 -178.23803886 308.52655203 -181 306 C-181.94230469 305.14148438 -182.88460937 304.28296875 -183.85546875 303.3984375 C-216.89718572 271.83477713 -235.6116688 226.11845992 -237.33984375 180.84765625 C-238.44558008 129.57567422 -220.04374805 83.16227448 -185.06640625 45.84765625 C-177.97665924 38.44627201 -170.25447823 32.05735697 -162 26 C-161.44570312 25.58540527 -160.89140625 25.17081055 -160.3203125 24.74365234 C-115.11510679 -8.72252547 -53.09015518 -16.58155196 0 0 Z " fill="#33DFA0" transform="translate(237,9)"></path>
        <path d="M0 0 C8.98085558 6.4818349 15.30600146 15.92479182 18.24609375 26.62109375 C18.69217228 29.86202582 18.77098823 33.03985465 18.74609375 36.30859375 C18.74037354 37.18491455 18.73465332 38.06123535 18.72875977 38.96411133 C18.37611248 51.88620031 13.24975129 61.41316286 4.37109375 70.55078125 C-5.23019872 79.57135039 -16.78338377 83.22880713 -29.828125 82.93359375 C-39.32929476 81.91878256 -47.24562784 78.38694468 -54.75390625 72.62109375 C-55.62015625 72.04359375 -56.48640625 71.46609375 -57.37890625 70.87109375 C-64.24013385 64.37098339 -68.09066367 56.58448008 -70.75390625 47.62109375 C-70.94597656 47.00105469 -71.13804688 46.38101563 -71.3359375 45.7421875 C-73.77748865 33.35188588 -70.86124014 22.70431507 -64.69140625 11.99609375 C-57.59776372 1.43109423 -47.75720217 -4.25916607 -35.8125 -7.984375 C-22.83144528 -10.47220522 -10.91058097 -7.00022875 0 0 Z " fill="#33DC9E" transform="translate(141.75390625,159.37890625)"></path>
        <path d="M0 0 C1.16789062 0.36738281 1.16789062 0.36738281 2.359375 0.7421875 C14.92592793 5.15218899 22.39037658 13.89342089 28.8125 25.1875 C33.67506347 36.7040977 33.35244195 49.27439145 29 61 C23.12042523 72.92810285 14.87078321 81.78824205 2.19311523 86.26928711 C-10.79587034 90.46605886 -22.20286246 90.09894527 -34.5 83.875 C-45.85472399 77.14255303 -53.36800073 67.95632275 -57.38696289 55.43994141 C-58.4129545 51.35640491 -58.53171643 47.38220066 -58.5 43.1875 C-58.49500488 42.31383789 -58.49000977 41.44017578 -58.48486328 40.54003906 C-58.16318954 28.55602849 -53.2104517 19.38959935 -44.96875 10.91015625 C-32.66463569 -0.72243069 -16.38032623 -5.61058418 0 0 Z " fill="#33DC9E" transform="translate(262,153)"></path>
      </symbol>
    </svg>
</head>
<body class="bg-gray-50">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full">
            <div class="text-center mb-8">
                <img src="https://social.thegreekdirectory.org/Logo2.png" alt="The Greek Directory" class="h-20 w-auto mx-auto mb-4">
                <h1 class="text-3xl font-bold mb-2" style="color: #055193;">Admin Portal</h1>
            </div>
            <div class="bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Sign In</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Personal Access Token</label>
                        <input type="password" id="githubToken" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="--tw-ring-color: #055193;" placeholder="Enter token...">
                    </div>
                    <button id="loginBtn" class="w-full py-3 px-4 rounded-lg text-white font-semibold" style="background-color: #055193;">Sign In</button>
                </div>
            </div>
        </div>
    </div>

    <div id="dashboardPage" class="hidden">
        <header class="bg-white shadow-sm border-b sticky top-0 z-50">
            <div class="px-6 py-4 flex items-center justify-between">
                <div class="flex items-center gap-3">
                    <img src="https://social.thegreekdirectory.org/Logo2.png" alt="The Greek Directory" class="h-12 w-auto">
                    <h1 class="text-xl font-bold" style="color: #055193;">Admin Portal</h1>
                </div>
                <button id="logoutBtn" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Logout</button>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 py-6">
            <div class="mb-6 flex gap-3">
                <button id="newListingBtn" class="px-4 py-2 text-white rounded-lg font-medium" style="background-color: #055193;">+ New Listing</button>
                <input type="text" id="adminSearch" placeholder="Search listings..." 
                    class="px-4 py-2 border border-gray-300 rounded-lg" 
                    oninput="renderTable()">
                <button id="refreshBtn" class="px-4 py-2 bg-gray-200 text-gray-900 rounded-lg font-medium">ðŸ”„ Refresh</button>
            </div>

            <div class="bg-white rounded-lg shadow-sm overflow-hidden">
                <div class="overflow-x-auto">
                    <table class="w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">ID</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Status</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Tier</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Business Name</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Category</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Location</th>
                                <th class="text-left py-3 px-4 font-semibold text-gray-900">Last Updated</th>
                                <th class="text-right py-3 px-4 font-semibold text-gray-900">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="listingsTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <!-- Edit Modal -->
    <div id="editModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4 overflow-y-auto">
        <div class="bg-white rounded-lg max-w-4xl w-full my-8">
            <div class="p-6 border-b flex items-center justify-between">
                <h2 id="modalTitle" class="text-2xl font-bold text-gray-900">Edit Listing</h2>
                <button id="closeModal" class="text-gray-500 hover:text-gray-700 text-2xl">Ã—</button>
            </div>
            <div class="p-6 max-h-[70vh] overflow-y-auto">
                <div class="space-y-6">
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Tier & Status</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tier</label>
                                <select id="editTier" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="updateVerifiedBasedOnTier()">
                                    <option value="FREE">Free</option>
                                    <option value="VERIFIED">Verified</option>
                                    <option value="FEATURED">Featured</option>
                                    <option value="PREMIUM">Premium</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Show Claim Button</label>
                                <label class="inline-flex items-center cursor-pointer">
                                    <input type="checkbox" id="editShowClaim" class="w-4 h-4 mr-2">
                                    <span class="text-sm">Display on page</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Basic Information</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Listing ID *</label>
                                <input type="text" id="editListingId" class="w-full px-4 py-2 border border-gray-300 rounded-lg disabled-field" disabled>
                                <p class="info-notice">To change ID number, go to repo database.</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Business Name *</label>
                                <input type="text" id="editBusinessName" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tagline (max 75 chars) *</label>
                                <input type="text" id="editTagline" maxlength="75" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                <p class="text-xs text-gray-500 mt-1"><span id="taglineCount">0</span>/75 characters</p>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Description</label>
                                <textarea id="editDescription" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Use Enter/Return to create new paragraphs"></textarea>
                                <p class="text-xs text-gray-500 mt-1"><span id="descriptionCount">0</span>/<span id="descriptionMax">2000</span> characters</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Category *</label>
                                <select id="editCategory" class="w-full px-4 py-2 border border-gray-300 rounded-lg" onchange="updateSubcategoriesForCategory()">
                                    <option>Automotive & Transportation</option>
                                    <option>Beauty & Health</option>
                                    <option>Church & Religious Organization</option>
                                    <option>Cultural/Fraternal Organization</option>
                                    <option>Education & Community</option>
                                    <option>Entertainment, Arts & Recreation</option>
                                    <option>Food & Hospitality</option>
                                    <option>Grocery & Imports</option>
                                    <option>Home & Construction</option>
                                    <option>Industrial & Manufacturing</option>
                                    <option>Pets & Veterinary</option>
                                    <option>Professional & Business Services</option>
                                    <option>Real Estate & Development</option>
                                    <option>Retail & Shopping</option>
                                </select>
                            </div>
                            <div id="subcategoriesContainer" class="hidden md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Subcategories * (Select at least 1)</label>
                                <div id="subcategoryCheckboxes" class="grid grid-cols-2 gap-2"></div>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                                <input type="tel" id="editPhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Address (leave empty if Based In only)</label>
                                <input type="text" id="editAddress" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                                <input type="text" id="editCity" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                                <select id="editState" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option><option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option><option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option><option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option><option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option><option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option><option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option><option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option><option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option><option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option><option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option><option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option><option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option><option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option><option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option><option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option><option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Zip Code</label>
                                <input type="text" id="editZipCode" maxlength="10" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="60601">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                                <input type="text" id="editCountry" value="USA" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Places URL Ending 
                                    <span class="text-xs text-gray-500">(Optional - e.g., "chicago", "wyoming")</span>
                                </label>
                                <input type="text" id="editPlacesUrl" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="e.g., chicago, wyoming, los-angeles">
                                <p class="text-xs text-gray-500 mt-1">
                                    If specified, this listing will appear on pages like /places/chicago or /places/wyoming. 
                                    Leave blank if not needed. Use lowercase with hyphens for multi-word places.
                                </p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                                <input type="email" id="editEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                                <input type="url" id="editWebsite" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>
                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Hours of Operation</h3>
                        <div class="grid grid-cols-1 gap-3">
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Monday:</label>
                                <input type="text" id="editHoursMonday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Tuesday:</label>
                                <input type="text" id="editHoursTuesday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Wednesday:</label>
                                <input type="text" id="editHoursWednesday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Thursday:</label>
                                <input type="text" id="editHoursThursday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Friday:</label>
                                <input type="text" id="editHoursFriday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Saturday:</label>
                                <input type="text" id="editHoursSaturday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">Sunday:</label>
                                <input type="text" id="editHoursSunday" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Images</h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Logo (leave empty to use category default)</label>
                                <input type="file" id="logoUpload" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <div id="logoProgress" class="upload-progress"></div>
                                <div id="logoPreview" class="mt-2"></div>
                                <input type="hidden" id="editLogo">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Photos (max 15, leave empty to use category default) - Drag to reorder</label>
                                <input type="file" id="photosUpload" accept="image/*" multiple class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                <div id="photosProgress" class="upload-progress"></div>
                                <div id="photosPreview" class="mt-2 image-grid"></div>
                                <input type="hidden" id="editPhotos">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Social Media</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Facebook</label>
                                <input type="text" id="editFacebook" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Instagram</label>
                                <input type="text" id="editInstagram" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Twitter/X</label>
                                <input type="text" id="editTwitter" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">YouTube</label>
                                <input type="text" id="editYoutube" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">TikTok</label>
                                <input type="text" id="editTiktok" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">LinkedIn (full URL)</label>
                                <input type="url" id="editLinkedin" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Social 1 (full URL)</label>
                                <input type="url" id="editOther1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Social 2 (full URL)</label>
                                <input type="url" id="editOther2" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Social 3 (full URL)</label>
                                <input type="url" id="editOther3" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Review Sites</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Google Reviews (full URL)</label>
                                <input type="url" id="editGoogle" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Yelp (full URL)</label>
                                <input type="url" id="editYelp" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">TripAdvisor (full URL)</label>
                                <input type="url" id="editTripadvisor" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Review 1 (full URL)</label>
                                <input type="url" id="editReviewOther1" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Review 2 (full URL)</label>
                                <input type="url" id="editReviewOther2" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Other Review 3 (full URL)</label>
                                <input type="url" id="editReviewOther3" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="text-lg font-bold text-gray-900 mb-4">Owner Info (Optional - Private)</h3>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div class="owner-field">
                                <input type="text" id="editOwnerName" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Full Name">
                                <button class="visibility-toggle visible" data-field="name" onclick="toggleOwnerFieldVisibility('name')">Visible</button>
                            </div>
                            <div class="owner-field">
                                <input type="text" id="editOwnerTitle" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Title (Owner, Manager, etc.)">
                                <button class="visibility-toggle visible" data-field="title" onclick="toggleOwnerFieldVisibility('title')">Visible</button>
                            </div>
                            <div class="owner-field">
                                <input type="text" id="editOwnerGreece" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="From Greece (Athens, Crete, etc.)">
                                <button class="visibility-toggle hidden" data-field="greece" onclick="toggleOwnerFieldVisibility('greece')">Hidden</button>
                            </div>
                            <div class="owner-field">
                                <input type="email" id="editOwnerEmail" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Owner Email">
                                <button class="visibility-toggle hidden" data-field="email" onclick="toggleOwnerFieldVisibility('email')">Hidden</button>
                            </div>
                            <div class="owner-field">
                                <input type="tel" id="editOwnerPhone" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="Owner Phone">
                                <button class="visibility-toggle hidden" data-field="phone" onclick="toggleOwnerFieldVisibility('phone')">Hidden</button>
                            </div>
                            <div class="md:col-span-2">
                                <label class="block text-sm font-medium text-gray-700 mb-2">Business Portal Password (15 characters)</label>
                                <div class="flex gap-2">
                                    <input type="text" id="editPassword" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg font-mono" placeholder="Auto-generated or custom">
                                    <button type="button" onclick="generatePasswordField()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Generate</button>
                                </div>
                                <p class="text-xs text-gray-500 mt-1">Password for business portal access</p>
                            </div>
                        </div>
                        <input type="hidden" id="ownerFieldsVisibility" value='{"name":true,"title":true,"greece":false,"email":false,"phone":false}'>
                    </div>
                </div>
            </div>
            <div class="p-6 border-t flex justify-end gap-3">
                <button id="cancelEdit" class="px-6 py-2 bg-gray-200 text-gray-900 rounded-lg font-medium">Cancel</button>
                <button id="saveEdit" class="px-6 py-2 text-white rounded-lg font-medium" style="background-color: #055193;">Save</button>
            </div>
        </div>
    </div>
    <script>
    const GITHUB_OWNER = 'thegreekdirectory';
    const GITHUB_REPO = 'listings';
    const LINKS_REPO = 'links';
    const DATABASE_PATH = 'listings-database.json';
    const LINKS_DATABASE_PATH = 'data/links.json';

    const SUBCATEGORIES = {
        'Automotive & Transportation': ['Auto Detailer', 'Auto Repair Shop', 'Car Dealer', 'Taxi & Limo Service'],
        'Beauty & Health': ['Barbershops', 'Esthetician', 'Hair Salons', 'Nail Salon', 'Spas', 'Chiropractor', 'Dentist', 'Doctor', 'Nutritionist', 'Optometrist', 'Orthodontist', 'Physical Therapist', 'Physical Trainer'],
        'Church & Religious Organization': ['Church'],
        'Cultural/Fraternal Organization': ['Dance Troupe', 'Non-Profit', 'Philanthropic Group', 'Society', 'Youth Organization'],
        'Education & Community': ['Childcare', 'Greek School', 'Senior Care', 'Tutor'],
        'Entertainment, Arts & Recreation': ['Band', 'DJs', 'Entertainment Group', 'Photographer', 'Art'],
        'Food & Hospitality': ['Banquet Hall', 'Catering Service', 'Event Venue', 'Bakeries', 'Deli', 'Pastry Shop', 'Bar', 'Breakfast', 'Coffee', 'Lunch', 'Dinner', 'Restaurant', 'Hotel', 'Airbnb'],
        'Grocery & Imports': ['Butcher Shop', 'Liquor Shop', 'Market', 'Greek Alcohol', 'Honey', 'Olive Oil', 'Food Distribution', 'Food Manufacturer'],
        'Home & Construction': ['Carpenter', 'Electrician', 'General Contractor', 'Handyman', 'HVAC', 'Landscaping', 'Painter', 'Plumber', 'Roofing', 'Tile & Stone Specialist'],
        'Industrial & Manufacturing': ['Food Manufacturer'],
        'Pets & Veterinary': ['Veterinarian', 'Pet Accessories Maker'],
        'Professional & Business Services': ['Business Services', 'Consultant', 'CPA', 'Financial Advisor', 'Insurance Agent', 'IT Service & Repair', 'Lawyer', 'Marketing & Creative Agency', 'Notaries', 'Wedding Planner', 'Travel Agency'],
        'Real Estate & Development': ['Appraiser', 'Broker', 'Developer', 'Lender', 'Property Management', 'Real Estate Agent'],
        'Retail & Shopping': ['Boutique Shop', 'ECommerce', 'Jewelry', 'Souvenir Shop']
    };

    const CATEGORY_IMAGES = {
        'automotive-transportation': { main: 'https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?w=800&q=80', logo: 'https://images.unsplash.com/photo-1486262715619-67b85e0b08d3?w=200&h=200&fit=crop&q=80' },
        'beauty-health': { main: 'https://images.unsplash.com/photo-1560750588-73207b1ef5b8?w=800&q=80', logo: 'https://images.unsplash.com/photo-1560750588-73207b1ef5b8?w=200&h=200&fit=crop&q=80' },
        'church-religious-organization': { main: 'https://images.unsplash.com/photo-1438232992991-995b7058bbb3?w=800&q=80', logo: 'https://images.unsplash.com/photo-1438232992991-995b7058bbb3?w=200&h=200&fit=crop&q=80' },
        'cultural-fraternal-organization': { main: 'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=800&q=80', logo: 'https://images.unsplash.com/photo-1529156069898-49953e39b3ac?w=200&h=200&fit=crop&q=80' },
        'education-community': { main: 'https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=800&q=80', logo: 'https://images.unsplash.com/photo-1523050854058-8df90110c9f1?w=200&h=200&fit=crop&q=80' },
        'entertainment-arts-recreation': { main: 'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=800&q=80', logo: 'https://images.unsplash.com/photo-1514525253161-7a46d19cd819?w=200&h=200&fit=crop&q=80' },
        'food-hospitality': { main: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=800&q=80', logo: 'https://images.unsplash.com/photo-1517248135467-4c7edcad34c4?w=200&h=200&fit=crop&q=80' },
        'grocery-imports': { main: 'https://images.unsplash.com/photo-1542838132-92c53300491e?w=800&q=80', logo: 'https://images.unsplash.com/photo-1542838132-92c53300491e?w=200&h=200&fit=crop&q=80' },
        'home-construction': { main: 'https://images.unsplash.com/photo-1503387762-592deb58ef4e?w=800&q=80', logo: 'https://images.unsplash.com/photo-1503387762-592deb58ef4e?w=200&h=200&fit=crop&q=80' },
        'industrial-manufacturing': { main: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=800&q=80', logo: 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?w=200&h=200&fit=crop&q=80' },
        'pets-veterinary': { main: 'https://images.unsplash.com/photo-1548199973-03cce0bbc87b?w=800&q=80', logo: 'https://images.unsplash.com/photo-1548199973-03cce0bbc87b?w=200&h=200&fit=crop&q=80' },
        'professional-business-services': { main: 'https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=800&q=80', logo: 'https://images.unsplash.com/photo-1454165804606-c3d57bc86b40?w=200&h=200&fit=crop&q=80' },
        'real-estate-development': { main: 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=800&q=80', logo: 'https://images.unsplash.com/photo-1560518883-ce09059eeffa?w=200&h=200&fit=crop&q=80' },
        'retail-shopping': { main: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=800&q=80', logo: 'https://images.unsplash.com/photo-1441986300917-64674bd600d8?w=200&h=200&fit=crop&q=80' }
    };

    function getCategoryDefaults(category) {
        const slug = category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        return CATEGORY_IMAGES[slug] || { main: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=800&q=80', logo: 'https://images.unsplash.com/photo-1486406146926-c627a92ad1ab?w=200&h=200&fit=crop&q=80' };
    }

    let githubToken = null;
    let allListings = [];
    let editingListing = null;
    let databaseSha = null;
    let linksDatabaseSha = null;
    let linksData = null;
    let uploadedImages = { logo: null, photos: [] };
    let photosSortable = null;
    let ownerFieldsVisibility = { name: true, title: true, greece: false, email: false, phone: false };
    let selectedSubcategories = [];
    let nextListingId = 1;

    function generatePassword(length = 15) {
        const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZabcdefghjkmnpqrstuvwxyz23456789';
        let password = '';
        for (let i = 0; i < length; i++) {
            password += chars.charAt(Math.floor(Math.random() * chars.length));
        }
        return password;
    }

    function generateUUID() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    function generateSlug(name) {
        return name.toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-|-$/g, '');
    }

    document.getElementById('loginBtn').addEventListener('click', async () => {
        const tokenInput = document.getElementById('githubToken').value.trim();
        if (!tokenInput) {
            alert('Please enter your GitHub token');
            return;
        }
        githubToken = tokenInput;
        window.githubToken = tokenInput;
        sessionStorage.setItem('githubToken', tokenInput);
        await testToken();
    });

    async function testToken() {
        try {
            const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${DATABASE_PATH}`, {
                headers: { 
                    'Authorization': `token ${githubToken}`,
                    'Accept': 'application/vnd.github.v3+json'
                }
            });
            
            if (response.ok) {
                showDashboard();
                await loadListings();
                await loadLinksDatabase();
            } else {
                const errorData = await response.json();
                alert(`ERROR: Invalid token or insufficient permissions.\nStatus: ${response.status}\nMessage: ${errorData.message || 'Unknown error'}\n\nMake sure your token has 'repo' permissions.`);
                sessionStorage.removeItem('githubToken');
                githubToken = null;
                window.githubToken = null;
            }
        } catch (error) {
            alert('ERROR: Connection to GitHub failed. ' + error.message);
            sessionStorage.removeItem('githubToken');
            githubToken = null;
            window.githubToken = null;
        }
    }

    function showDashboard() {
        document.getElementById('loginPage').classList.add('hidden');
        document.getElementById('dashboardPage').classList.remove('hidden');
    }

    document.getElementById('logoutBtn').addEventListener('click', () => {
        githubToken = null;
        window.githubToken = null;
        sessionStorage.clear();
        location.reload();
    });

    if (sessionStorage.getItem('githubToken')) {
        githubToken = sessionStorage.getItem('githubToken');
        window.githubToken = githubToken;
        testToken();
    }
        // ADD THESE FUNCTIONS TO YOUR ADMIN.HTML JAVASCRIPT

async function createLinksRedirect(listingId, slug, categorySlug) {
    try {
        if (!linksData) {
            await loadLinksDatabase();
        }

        const listingLinkId = generateUUID();
        const listingPath = `/r/l/${listingId}`;
        const listingUrl = `https://thegreekdirectory.org/listings/${categorySlug}/${slug}`;
        
        const portalLinkId = generateUUID();
        const portalPath = `/r/b/${listingId}`;
        const portalUrl = `https://thegreekdirectory.org/business.html?slug=${slug}`;

        const listingLinkExists = linksData.links.some(l => l.path === listingPath);
        const portalLinkExists = linksData.links.some(l => l.path === portalPath);

        if (!listingLinkExists) {
            linksData.links.push({
                id: listingLinkId,
                title: `Listing #${listingId}`,
                path: listingPath,
                redirectTo: listingUrl
            });
        } else {
            const existingLink = linksData.links.find(l => l.path === listingPath);
            existingLink.redirectTo = listingUrl;
        }

        if (!portalLinkExists) {
            linksData.links.push({
                id: portalLinkId,
                title: `Portal #${listingId}`,
                path: portalPath,
                redirectTo: portalUrl
            });
        } else {
            const existingLink = linksData.links.find(l => l.path === portalPath);
            existingLink.redirectTo = portalUrl;
        }

        await saveLinksDatabase();
        await generateRedirectFile(listingPath, listingUrl);
        await generateRedirectFile(portalPath, portalUrl);

        console.log('Links created successfully');
    } catch (error) {
        console.error('Error creating links:', error);
    }
}

async function saveLinksDatabase() {
    try {
        const content = btoa(unescape(encodeURIComponent(JSON.stringify(linksData, null, 2))));
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${LINKS_REPO}/contents/${LINKS_DATABASE_PATH}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${githubToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: 'Update links database',
                content: content,
                sha: linksDatabaseSha
            })
        });

        if (response.ok) {
            const data = await response.json();
            linksDatabaseSha = data.content.sha;
        }
    } catch (error) {
        console.error('Error saving links database:', error);
    }
}

async function generateRedirectFile(path, redirectUrl) {
    try {
        const templateResponse = await fetch(`https://raw.githubusercontent.com/${GITHUB_OWNER}/${LINKS_REPO}/main/r/_template.html`);
        let template = await templateResponse.text();
        
        template = template.replace(/{{REDIRECT_URL}}/g, redirectUrl);
        
        const filePath = path.substring(1) + '.html';
        
        let fileSha = null;
        try {
            const existingFile = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${LINKS_REPO}/contents/${filePath}`, {
                headers: { 'Authorization': `token ${githubToken}` }
            });
            if (existingFile.ok) {
                const existingData = await existingFile.json();
                fileSha = existingData.sha;
            }
        } catch (e) {}

        const htmlContent = btoa(unescape(encodeURIComponent(template)));
        await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${LINKS_REPO}/contents/${filePath}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${githubToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Generate redirect for ${path}`,
                content: htmlContent,
                ...(fileSha && { sha: fileSha })
            })
        });
    } catch (error) {
        console.error('Error generating redirect file:', error);
    }
}

async function generateListingPage(listing) {
    console.log('ðŸ“„ Generating listing page for:', listing.businessName);
    
    try {
        const templateResponse = await fetch(`https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/listing-template.html`);
        let template = await templateResponse.text();
        
        const categorySlug = listing.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
        const listingUrl = `https://listings.thegreekdirectory.org/listings/${categorySlug}/${listing.slug}`;
        const cityState = listing.city && listing.state ? ` in ${listing.city}, ${listing.state}` : '';
        const inCity = listing.city ? ` in ${listing.city}` : '';
        
        // Replace all placeholders
        template = template.replace(/{{BUSINESS_NAME}}/g, listing.businessName);
        template = template.replace(/{{CITY_STATE}}/g, cityState);
        template = template.replace(/{{IN_CITY}}/g, inCity);
        template = template.replace(/{{TAGLINE}}/g, listing.tagline || '');
        template = template.replace(/{{LISTING_URL}}/g, listingUrl);
        template = template.replace(/{{LOGO}}/g, listing.logo || '');
        template = template.replace(/{{CATEGORY}}/g, listing.category);
        template = template.replace(/{{DESCRIPTION}}/g, listing.description || '');
        template = template.replace(/{{ADDRESS}}/g, listing.address || '');
        template = template.replace(/{{CITY}}/g, listing.city || '');
        template = template.replace(/{{STATE}}/g, listing.state || '');
        template = template.replace(/{{ZIP_CODE}}/g, listing.zipCode || '');
        template = template.replace(/{{COUNTRY}}/g, listing.country || 'USA');
        template = template.replace(/{{PHONE}}/g, listing.phone || '');
        template = template.replace(/{{WEBSITE_DOMAIN}}/g, listing.website ? new URL(listing.website).hostname : '');
        template = template.replace(/{{LISTING_ID}}/g, listing.id);
        template = template.replace(/{{BUSINESS_NAME_ENCODED}}/g, encodeURIComponent(listing.businessName));
        
        const fullAddress = listing.address && listing.city && listing.state 
            ? `${listing.address}, ${listing.city}, ${listing.state} ${listing.zipCode || ''}`
            : listing.city && listing.state 
            ? `${listing.city}, ${listing.state}`
            : '';
        template = template.replace(/{{FULL_ADDRESS}}/g, fullAddress);
        
        const coordinates = listing.coordinates 
            ? `${listing.coordinates.lat},${listing.coordinates.lng}` 
            : '';
        template = template.replace(/{{COORDINATES}}/g, coordinates);
        
        const hoursJson = JSON.stringify(listing.hours || {});
        template = template.replace(/{{HOURS_JSON}}/g, hoursJson);
        
        const photosSlides = (listing.photos && listing.photos.length > 0 
            ? listing.photos 
            : [listing.logo]).map(photo => 
            `<div class="carousel-slide h-full"><img src="${photo}" alt="${listing.businessName}" class="w-full h-full object-cover"></div>`
        ).join('');
        template = template.replace(/{{PHOTOS_SLIDES}}/g, photosSlides);
        
        const totalPhotos = (listing.photos && listing.photos.length > 0 ? listing.photos.length : 1);
        template = template.replace(/{{TOTAL_PHOTOS}}/g, totalPhotos);
        
        // Continue with all other replacements... (see original for full list)
        
        const filePath = `listings/${categorySlug}/${listing.slug}.html`;
        
        let fileSha = null;
        try {
            const existingFile = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filePath}`, {
                headers: { 'Authorization': `token ${githubToken}` }
            });
            if (existingFile.ok) {
                const existingData = await existingFile.json();
                fileSha = existingData.sha;
            }
        } catch (e) {}

        const htmlContent = btoa(unescape(encodeURIComponent(template)));
        const response = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${filePath}`, {
            method: 'PUT',
            headers: {
                'Authorization': `token ${githubToken}`,
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                message: `Generate listing page for ${listing.businessName}`,
                content: htmlContent,
                ...(fileSha && { sha: fileSha })
            })
        });

        if (response.ok) {
            console.log('âœ… Listing page generated successfully');
            return true;
        } else {
            console.error('âŒ Failed to generate listing page:', response.status);
            return false;
        }
    } catch (error) {
        console.error('âŒ Error generating listing page:', error);
        return false;
    }
}
</script>
</body>
</html>

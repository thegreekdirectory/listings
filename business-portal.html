<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Portal - The Greek Directory</title>
    <link rel="icon" href="https://social.thegreekdirectory.org/Logo2.png">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .hidden { display: none !important; }
        .image-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #e5e7eb; pointer-events: none; user-select: none; -webkit-user-drag: none; }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
        .upload-progress { display: none; background: #eff6ff; border: 1px solid #3b82f6; padding: 12px; border-radius: 8px; margin-top: 8px; }
        .sortable-ghost { opacity: 0.4; }
        .photo-item { position: relative; cursor: move; }
        .photo-item .delete-photo { position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
        .photo-item .photo-number { position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7); color: white; border-radius: 4px; padding: 2px 6px; font-size: 12px; font-weight: bold; }
        img { pointer-events: none; user-select: none; -webkit-user-drag: none; }
        .analytics-stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; }
        .tier-badge { display: inline-block; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 14px; }
        .tier-FREE { background: #e5e7eb; color: #374151; }
        .tier-VERIFIED { background: #dbeafe; color: #1e40af; }
        .tier-FEATURED { background: #fef3c7; color: #92400e; }
        .tier-PREMIUM { background: #f3e8ff; color: #6b21a8; }
        .char-counter { font-size: 12px; color: #6b7280; }
        .char-counter.warning { color: #f59e0b; }
        .char-counter.error { color: #ef4444; }
        .subcategory-checkbox { display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .subcategory-checkbox:hover { background: #f3f4f6; }
        .subcategory-checkbox input[type="checkbox"]:checked + label { font-weight: 600; color: #055193; }
        .disabled-field { opacity: 0.5; pointer-events: none; cursor: not-allowed; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login Page -->
    <div id="loginPage" class="min-h-screen flex items-center justify-center px-4">
        <div class="max-w-md w-full">
            <div class="text-center mb-8">
                <img src="https://social.thegreekdirectory.org/Logo2.png" alt="The Greek Directory" class="h-20 w-auto mx-auto mb-4">
                <h1 class="text-3xl font-bold mb-2" style="color: #055193;">Business Portal</h1>
                <p class="text-gray-600">Manage your listing on The Greek Directory</p>
            </div>
            <div class="bg-white rounded-lg shadow-md p-8">
                <h2 class="text-2xl font-bold text-gray-900 mb-6">Sign In</h2>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Listing URL Slug</label>
                        <input type="text" id="loginSlug" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="--tw-ring-color: #055193;" placeholder="e.g., eagle-restaurant">
                        <p class="text-xs text-gray-500 mt-1">This is the end part of your listing URL</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Owner Email</label>
                        <input type="email" id="loginEmail" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="--tw-ring-color: #055193;" placeholder="your@email.com">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                        <input type="password" id="loginPassword" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2" style="--tw-ring-color: #055193;" placeholder="Enter password">
                    </div>
                    <button id="loginBtn" class="w-full py-3 px-4 rounded-lg text-white font-semibold" style="background-color: #055193;">Sign In</button>
                    <div class="text-center mt-4">
                        <p class="text-sm text-gray-600">Don't have access? Contact us to claim your listing.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const GITHUB_OWNER = 'thegreekdirectory';
        const GITHUB_REPO = 'listings';
        const GITHUB_TOKEN = 'USE_YOUR_GITHUB_TOKEN_HERE'; // This should be set on server-side in production
        const DATABASE_PATH = 'listings-database.json';

        const SUBCATEGORIES = {
            'Automotive & Transportation': ['Auto Detailer', 'Auto Repair Shop', 'Car Dealer', 'Taxi & Limo Service'],
            'Beauty & Health': ['Barbershops', 'Esthetician', 'Hair Salons', 'Nail Salon', 'Spas', 'Chiropractor', 'Dentist', 'Doctor', 'Nutritionist', 'Optometrist', 'Orthodontist', 'Physical Therapist', 'Physical Trainer'],
            'Church & Religious Organization': ['Church'],
            'Cultural/Fraternal Organization': ['Dance Troupe', 'Non-Profit', 'Philanthropic Group', 'Society', 'Youth Organization'],
            'Education & Community': ['Childcare', 'Greek School', 'Senior Care', 'Tutor'],
            'Entertainment, Arts & Recreation': ['Band', 'DJs', 'Entertainment Group', 'Photographer', 'Art'],
            'Food & Hospitality': ['Banquet Hall', 'Catering Service', 'Event Venue', 'Bakeries', 'Deli', 'Pastry Shop', 'Bar', 'Breakfast', 'Coffee', 'Lunch', 'Dinner', 'Restaurant', 'Hotel', 'Airbnb'],
            'Grocery & Imports': ['Butcher Shop', 'Liquor Shop', 'Market', 'Greek Alcohol', 'Honey', 'Olive Oil', 'Food Distribution', 'Food Manufacturer'],
            'Home & Construction': ['Carpenter', 'Electrician', 'General Contractor', 'Handyman', 'HVAC', 'Landscaping', 'Painter', 'Plumber', 'Roofing', 'Tile & Stone Specialist'],
            'Industrial & Manufacturing': ['Food Manufacturer'],
            'Pets & Veterinary': ['Veterinarian', 'Pet Accessories Maker'],
            'Professional & Business Services': ['Business Services', 'Consultant', 'CPA', 'Financial Advisor', 'Insurance Agent', 'IT Service & Repair', 'Lawyer', 'Marketing & Creative Agency', 'Notaries', 'Wedding Planner', 'Travel Agency'],
            'Real Estate & Development': ['Appraiser', 'Broker', 'Developer', 'Lender', 'Property Management', 'Real Estate Agent'],
            'Retail & Shopping': ['Boutique Shop', 'ECommerce', 'Jewelry', 'Souvenir Shop']
        };

        let currentListing = null;
        let databaseSha = null;
        let allListings = [];
        let uploadedImages = { logo: null, photos: [] };
        let photosSortable = null;
        let selectedSubcategories = [];

        document.getElementById('loginBtn').addEventListener('click', async () => {
            const slug = document.getElementById('loginSlug').value.trim();
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value.trim();

            if (!slug || !email || !password) {
                alert('Please fill in all fields');
                return;
            }

            await attemptLogin(slug, email, password);
        });

        async function attemptLogin(slug, email, password) {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${DATABASE_PATH}`);
                const data = await response.json();
                allListings = data.listings;

                const listing = allListings.find(l => 
                    l.slug === slug && 
                    l.ownerInfo && 
                    l.ownerInfo.ownerEmail === email && 
                    l.businessPortalPassword === password
                );

                if (listing) {
                    if (listing.showClaimButton !== false && !listing.businessPortalPassword) {
                        alert('This listing has not been claimed yet. Please contact us to claim your listing.');
                        return;
                    }

                    currentListing = listing;
                    sessionStorage.setItem('businessPortalAuth', JSON.stringify({ slug, email, password }));
                    showDashboard();
                } else {
                    alert('Invalid credentials. Please check your listing slug, email, and password.');
                }
            } catch (error) {
                console.error('Login error:', error);
                alert('Login failed. Please try again.');
            }
        }

        // Check for existing session
        window.addEventListener('DOMContentLoaded', async () => {
            const savedAuth = sessionStorage.getItem('businessPortalAuth');
            if (savedAuth) {
                const { slug, email, password } = JSON.parse(savedAuth);
                await attemptLogin(slug, email, password);
            }
        });
        function showDashboard() {
            document.getElementById('loginPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            
            renderDashboard();
        }

        function logout() {
            sessionStorage.removeItem('businessPortalAuth');
            location.reload();
        }
    </script>

    <!-- Dashboard Page -->
    <div id="dashboardPage" class="hidden">
        <header class="bg-white shadow-sm border-b sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="https://social.thegreekdirectory.org/Logo2.png" alt="The Greek Directory" class="h-12 w-auto">
                        <div>
                            <h1 class="text-xl font-bold" style="color: #055193;">Business Portal</h1>
                            <p class="text-sm text-gray-600" id="businessName"></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="tierBadge" class="tier-badge"></span>
                        <button onclick="logout()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- Navigation Tabs -->
            <div class="flex gap-2 mb-6 overflow-x-auto">
                <button onclick="switchTab('overview')" id="tab-overview" class="px-4 py-2 rounded-lg font-medium bg-white border-2 border-blue-600 text-blue-600">Overview</button>
                <button onclick="switchTab('edit')" id="tab-edit" class="px-4 py-2 rounded-lg font-medium bg-white border border-gray-300 text-gray-700">Edit Listing</button>
                <button onclick="switchTab('analytics')" id="tab-analytics" class="px-4 py-2 rounded-lg font-medium bg-white border border-gray-300 text-gray-700">Analytics</button>
            </div>

            <!-- Overview Tab -->
            <div id="content-overview" class="space-y-6">
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Welcome!</h2>
                    <p class="text-gray-700 mb-4">Manage your listing on The Greek Directory. Your current tier allows you to access the following features:</p>
                    
                    <div id="tierFeatures" class="space-y-2 mb-6"></div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-900 mb-2">Quick Actions</h3>
                        <div class="flex gap-3">
                            <button onclick="switchTab('edit')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Edit Listing</button>
                            <button onclick="switchTab('analytics')" class="px-4 py-2 bg-white text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50">View Analytics</button>
                            <a href="/listings/${currentListing ? currentListing.category.toLowerCase().replace(/[^a-z0-9]+/g, '-') : ''}/${currentListing ? currentListing.slug : ''}" target="_blank" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">View Live Page</a>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Listing Preview</h3>
                    <div class="grid md:grid-cols-2 gap-4">
                        <div>
                            <img id="previewLogo" src="" alt="Logo" class="w-full h-48 object-cover rounded-lg">
                        </div>
                        <div id="previewInfo"></div>
                    </div>
                </div>
            </div>

            <!-- Edit Tab -->
            <div id="content-edit" class="hidden">
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Edit Your Listing</h2>
                        <button onclick="saveChanges()" class="px-6 py-2 text-white rounded-lg font-medium" style="background-color: #055193;">Save Changes</button>
                    </div>
                    
                    <div class="space-y-6" id="editForm"></div>
                </div>
            </div>

            <!-- Analytics Tab -->
            <div id="content-analytics" class="hidden">
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Analytics</h2>
                        <button onclick="loadDatabase()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">ðŸ”„ Refresh</button>
                    </div>
                    
                    <div id="analyticsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        function renderDashboard() {
            if (!currentListing) return;
            
            document.getElementById('businessName').textContent = currentListing.businessName;
            
            const tier = currentListing.tier || 'FREE';
            const tierBadge = document.getElementById('tierBadge');
            tierBadge.textContent = tier + ' Tier';
            tierBadge.className = `tier-badge tier-${tier}`;
            
            renderOverview();
            renderEditForm();
            renderAnalytics();
        }

        function switchTab(tab) {
            ['overview', 'edit', 'analytics'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).className = 'px-4 py-2 rounded-lg font-medium bg-white border border-gray-300 text-gray-700';
            });
            
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = 'px-4 py-2 rounded-lg font-medium bg-white border-2 border-blue-600 text-blue-600';
        }

        function renderOverview() {
            if (!currentListing) return;
            
            const tier = currentListing.tier || 'FREE';
            const features = {
                'FREE': [
                    'âœ… Basic listing with logo and 1 photo',
                    'âœ… Contact information (phone, email, website)',
                    'âœ… Hours of operation',
                    'âœ… Social media links',
                    'âœ… Review site links',
                    'âœ… Tagline (max 150 characters)',
                    'âœ… Description (max 500 characters)',
                    'âœ… Basic analytics (total views and engagement)'
                ],
                'VERIFIED': [
                    'âœ… All FREE features',
                    'âœ… Verified badge',
                    'âœ… Extended description (max 1000 characters)',
                    'âœ… Enhanced analytics (website, call, and direction clicks)',
                    'âœ… Monthly analytics totals'
                ],
                'FEATURED': [
                    'âœ… All VERIFIED features',
                    'âœ… Featured badge and priority placement',
                    'âœ… Photo gallery (up to 5 photos)',
                    'âœ… Advanced analytics (click breakdown and trends)',
                    'âœ… Category placement indicator'
                ],
                'PREMIUM': [
                    'âœ… All FEATURED features',
                    'âœ… Premium badge and top placement',
                    'âœ… Extended photo gallery (up to 15 photos)',
                    'âœ… Video embedding (1 video)',
                    'âœ… Comprehensive analytics (video plays, comparative performance)',
                    'âœ… Full engagement history'
                ]
            };
            
            const featuresList = document.getElementById('tierFeatures');
            featuresList.innerHTML = features[tier].map(f => `<div class="flex items-start gap-2"><span>${f}</span></div>`).join('');
            
            // Preview
            document.getElementById('previewLogo').src = currentListing.logo;
            const fullAddress = currentListing.address ? 
                `${currentListing.address}, ${currentListing.city}, ${currentListing.state} ${currentListing.zipCode || ''}` : 
                `${currentListing.city}, ${currentListing.state}`;
            
            document.getElementById('previewInfo').innerHTML = `
                <div class="space-y-3">
                    <h3 class="text-2xl font-bold text-gray-900">${currentListing.businessName}</h3>
                    <p class="text-gray-600 italic">"${currentListing.tagline || ''}"</p>
                    <div class="space-y-2 text-sm text-gray-700">
                        <div><span class="font-semibold">Category:</span> ${currentListing.category}</div>
                        ${currentListing.subcategories && currentListing.subcategories.length > 0 ? 
                            `<div><span class="font-semibold">Subcategories:</span> ${currentListing.subcategories.join(', ')}</div>` : ''}
                        <div><span class="font-semibold">Location:</span> ${fullAddress}</div>
                        ${currentListing.phone ? `<div><span class="font-semibold">Phone:</span> ${currentListing.phone}</div>` : ''}
                        ${currentListing.email ? `<div><span class="font-semibold">Email:</span> ${currentListing.email}</div>` : ''}
                        ${currentListing.website ? `<div><span class="font-semibold">Website:</span> <a href="${currentListing.website}" target="_blank" class="text-blue-600 hover:underline">${currentListing.website}</a></div>` : ''}
                    </div>
                </div>
            `;
        }

        function renderEditForm() {
            if (!currentListing) return;
            
            const tier = currentListing.tier || 'FREE';
            const maxDesc = tier === 'FREE' ? 500 : 1000;
            const maxPhotos = tier === 'FREE' ? 1 : tier === 'FEATURED' ? 5 : tier === 'PREMIUM' ? 15 : 1;
            
            selectedSubcategories = currentListing.subcategories || [];
            
            let html = `
                <!-- Basic Information -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Basic Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2 disabled-field">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Business Name (Cannot Edit)</label>
                            <input type="text" value="${currentListing.businessName}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" disabled>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tagline (max 150 chars) *</label>
                            <input type="text" id="editTagline" value="${currentListing.tagline || ''}" maxlength="150" class="w-full px-4 py-2 border border-gray-300 rounded-lg" oninput="updateCharCounter('tagline')">
                            <p class="char-counter mt-1"><span id="taglineCount">${(currentListing.tagline || '').length}</span>/150 characters</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description (max ${maxDesc} chars)</label>
                            <textarea id="editDescription" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg" oninput="updateCharCounter('description')">${currentListing.description || ''}</textarea>
                            <p class="char-counter mt-1"><span id="descriptionCount">${(currentListing.description || '').length}</span>/<span id="descriptionMax">${maxDesc}</span> characters</p>
                        </div>
                        <div class="disabled-field">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category (Cannot Edit)</label>
                            <input type="text" value="${currentListing.category}" class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-100" disabled>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Subcategories</label>
                            <div id="subcategoriesGrid" class="grid grid-cols-2 gap-2"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                            <input type="tel" id="editPhone" value="${currentListing.phone || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="editEmail" value="${currentListing.email || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                            <input type="url" id="editWebsite" value="${currentListing.website || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <input type="text" id="editAddress" value="${currentListing.address || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                            <input type="text" id="editCity" value="${currentListing.city || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                            <input type="text" id="editState" value="${currentListing.state || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Zip Code</label>
                            <input type="text" id="editZipCode" value="${currentListing.zipCode || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>

                <!-- Hours -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Hours of Operation</h3>
                    <div class="grid grid-cols-1 gap-3">
                        ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map(day => `
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">${day}:</label>
                                <input type="text" id="editHours${day}" value="${currentListing.hours && currentListing.hours[day.toLowerCase()] ? currentListing.hours[day.toLowerCase()] : ''}" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                        `).join('')}
                    </div>
                </div>

                <!-- Images -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Images ${tier === 'PREMIUM' ? '& Video' : ''}</h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Logo</label>
                            <input type="file" id="logoUpload" accept="image/*" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <div id="logoProgress" class="upload-progress"></div>
                            <div id="logoPreview" class="mt-2">
                                ${currentListing.logo ? `<img src="${currentListing.logo}" class="image-preview">` : ''}
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Photos (max ${maxPhotos}) - Drag to reorder</label>
                            <input type="file" id="photosUpload" accept="image/*" multiple class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                            <div id="photosProgress" class="upload-progress"></div>
                            <div id="photosPreview" class="mt-2 image-grid"></div>
                        </div>
                        ${tier === 'PREMIUM' ? `
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Video URL (YouTube, Vimeo, etc.)</label>
                            <input type="url" id="editVideo" value="${currentListing.video || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="https://www.youtube.com/watch?v=...">
                        </div>
                        ` : ''}
                    </div>
                </div>

                <!-- Social Media -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Social Media</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Facebook</label>
                            <input type="text" id="editFacebook" value="${currentListing.socialMedia?.facebook || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Instagram</label>
                            <input type="text" id="editInstagram" value="${currentListing.socialMedia?.instagram || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Twitter/X</label>
                            <input type="text" id="editTwitter" value="${currentListing.socialMedia?.twitter || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">YouTube</label>
                            <input type="text" id="editYoutube" value="${currentListing.socialMedia?.youtube || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">TikTok</label>
                            <input type="text" id="editTiktok" value="${currentListing.socialMedia?.tiktok || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="username">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">LinkedIn (full URL)</label>
                            <input type="url" id="editLinkedin" value="${currentListing.socialMedia?.linkedin || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>

                <!-- Review Sites -->
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Review Sites</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Google Reviews (full URL)</label>
                            <input type="url" id="editGoogle" value="${currentListing.reviews?.google || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Yelp (full URL)</label>
                            <input type="url" id="editYelp" value="${currentListing.reviews?.yelp || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">TripAdvisor (full URL)</label>
                            <input type="url" id="editTripadvisor" value="${currentListing.reviews?.tripadvisor || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('editForm').innerHTML = html;
            
            // Render subcategories
            renderSubcategories();
            
            // Show existing photos
            if (currentListing.photos && currentListing.photos.length > 0) {
                uploadedImages.photos = currentListing.photos.map(url => ({ url: url, existing: true }));
                renderPhotosPreview();
            }
            
            // Setup image upload handlers
            setupImageHandlers();
        }

        function renderSubcategories() {
            const category = currentListing.category;
            const grid = document.getElementById('subcategoriesGrid');
            
            if (SUBCATEGORIES[category] && SUBCATEGORIES[category].length > 0) {
                grid.innerHTML = '';
                SUBCATEGORIES[category].forEach(sub => {
                    const div = document.createElement('div');
                    div.className = 'subcategory-checkbox';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `subcat-${sub}`;
                    checkbox.value = sub;
                    checkbox.checked = selectedSubcategories.includes(sub);
                    checkbox.onchange = () => toggleSubcategory(sub);
                    
                    const label = document.createElement('label');
                    label.htmlFor = `subcat-${sub}`;
                    label.textContent = sub;
                    label.className = 'cursor-pointer flex-1 text-sm';
                    
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    grid.appendChild(div);
                });
            }
        }

        function toggleSubcategory(sub) {
            const index = selectedSubcategories.indexOf(sub);
            if (index > -1) {
                selectedSubcategories.splice(index, 1);
            } else {
                selectedSubcategories.push(sub);
            }
        }

        window.updateCharCounter = function(field) {
            if (field === 'tagline') {
                const input = document.getElementById('editTagline');
                const counter = document.getElementById('taglineCount');
                counter.textContent = input.value.length;
            } else if (field === 'description') {
                const input = document.getElementById('editDescription');
                const counter = document.getElementById('descriptionCount');
                const max = parseInt(document.getElementById('descriptionMax').textContent);
                const current = input.value.length;
                
                counter.textContent = current;
                counter.parentElement.className = 'char-counter mt-1';
                
                if (current > max) {
                    counter.parentElement.className = 'char-counter error mt-1';
                    input.value = input.value.substring(0, max);
                    counter.textContent = max;
                } else if (current > max * 0.9) {
                    counter.parentElement.className = 'char-counter warning mt-1';
                }
            }
        };
        function setupImageHandlers() {
            document.getElementById('logoUpload').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        uploadedImages.logo = { 
                            file: file,
                            base64: event.target.result.split(',')[1],
                            url: event.target.result
                        };
                        document.getElementById('logoPreview').innerHTML = `<img src="${event.target.result}" class="image-preview">`;
                    };
                    reader.readAsDataURL(file);
                }
            });

            document.getElementById('photosUpload').addEventListener('change', async (e) => {
                const tier = currentListing.tier || 'FREE';
                const maxPhotos = tier === 'FREE' ? 1 : tier === 'FEATURED' ? 5 : tier === 'PREMIUM' ? 15 : 1;
                
                const files = Array.from(e.target.files).slice(0, maxPhotos - uploadedImages.photos.length);
                
                for (const file of files) {
                    const reader = new FileReader();
                    await new Promise((resolve) => {
                        reader.onload = (event) => {
                            uploadedImages.photos.push({ 
                                file: file,
                                base64: event.target.result.split(',')[1],
                                url: event.target.result
                            });
                            renderPhotosPreview();
                            resolve();
                        };
                        reader.readAsDataURL(file);
                    });
                }
            });
        }

        function renderPhotosPreview() {
            const preview = document.getElementById('photosPreview');
            preview.innerHTML = uploadedImages.photos.map((photo, idx) => `
                <div class="photo-item" data-index="${idx}">
                    <div class="photo-number">#${idx + 1}</div>
                    <img src="${photo.url}" class="image-preview">
                    <div class="delete-photo" onclick="deletePhoto(${idx})">Ã—</div>
                </div>
            `).join('');
            
            if (photosSortable) {
                photosSortable.destroy();
            }
            initPhotosSortable();
        }

        function initPhotosSortable() {
            const preview = document.getElementById('photosPreview');
            if (preview && preview.children.length > 0) {
                photosSortable = Sortable.create(preview, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: function(evt) {
                        const oldIndex = evt.oldIndex;
                        const newIndex = evt.newIndex;
                        const item = uploadedImages.photos.splice(oldIndex, 1)[0];
                        uploadedImages.photos.splice(newIndex, 0, item);
                        renderPhotosPreview();
                    }
                });
            }
        }

        window.deletePhoto = function(index) {
            uploadedImages.photos.splice(index, 1);
            renderPhotosPreview();
        };

        function renderAnalytics() {
            if (!currentListing) return;
            
            const tier = currentListing.tier || 'FREE';
            const analytics = currentListing.analytics || {
                views: 0,
                callClicks: 0,
                websiteClicks: 0,
                directionClicks: 0,
                shareClicks: 0,
                videoPlays: 0,
                lastViewed: 'Never',
                detailedViews: []
            };
            
            let html = '';
            
            // FREE tier - only basic stats
            if (tier === 'FREE') {
                html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="analytics-stat-card">
                            <div class="text-4xl font-bold mb-2">${analytics.views || 0}</div>
                            <div class="text-sm opacity-90">Total Views</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="text-4xl font-bold mb-2">${(analytics.callClicks || 0) + (analytics.websiteClicks || 0) + (analytics.directionClicks || 0) + (analytics.shareClicks || 0)}</div>
                            <div class="text-sm opacity-90">Total Engagement</div>
                        </div>
                    </div>
                    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-900"><strong>Want more detailed analytics?</strong> Upgrade to Verified tier or higher to see individual click breakdowns, trends, and more!</p>
                    </div>
                `;
            }
            // VERIFIED tier - individual clicks
            else if (tier === 'VERIFIED') {
                html = `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="analytics-stat-card">
                            <div class="text-4xl font-bold mb-2">${analytics.views || 0}</div>
                            <div class="text-sm opacity-90">Total Views</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.callClicks || 0}</div>
                            <div class="text-sm opacity-90">Call Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.websiteClicks || 0}</div>
                            <div class="text-sm opacity-90">Website Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.directionClicks || 0}</div>
                            <div class="text-sm opacity-90">Direction Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.shareClicks || 0}</div>
                            <div class="text-sm opacity-90">Share Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                            <div class="text-lg font-bold mb-2">${analytics.lastViewed ? new Date(analytics.lastViewed).toLocaleString() : 'Never'}</div>
                            <div class="text-sm opacity-90">Last Viewed</div>
                        </div>
                    </div>
                    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-900"><strong>Want advanced analytics?</strong> Upgrade to Featured or Premium tier for click breakdowns, trends, and comparative performance!</p>
                    </div>
                `;
            }
            // FEATURED tier - trends and breakdowns
            else if (tier === 'FEATURED') {
                const recentViews = analytics.detailedViews?.slice(-30) || [];
                const thisMonth = recentViews.filter(v => {
                    const viewDate = new Date(v.timestamp);
                    const now = new Date();
                    return viewDate.getMonth() === now.getMonth() && viewDate.getFullYear() === now.getFullYear();
                });
                
                html = `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                        <div class="analytics-stat-card">
                            <div class="text-4xl font-bold mb-2">${analytics.views || 0}</div>
                            <div class="text-sm opacity-90">Total Views</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.callClicks || 0}</div>
                            <div class="text-sm opacity-90">Call Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.websiteClicks || 0}</div>
                            <div class="text-sm opacity-90">Website Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.directionClicks || 0}</div>
                            <div class="text-sm opacity-90">Direction Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.shareClicks || 0}</div>
                            <div class="text-sm opacity-90">Share Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                            <div class="text-4xl font-bold mb-2">${thisMonth.length}</div>
                            <div class="text-sm opacity-90">This Month</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4 mb-6">
                        <h3 class="font-bold text-gray-900 mb-3">Recent Activity (Last 30 actions)</h3>
                        <div class="space-y-2">
                            ${recentViews.slice(-10).reverse().map(v => `
                                <div class="flex justify-between text-sm">
                                    <span class="font-medium">${v.action}</span>
                                    <span class="text-gray-600">${new Date(v.timestamp).toLocaleString()}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-900"><strong>Want even more insights?</strong> Upgrade to Premium tier for video analytics, full history, and comparative performance!</p>
                    </div>
                `;
            }
            // PREMIUM tier - everything
            else {
                const recentViews = analytics.detailedViews || [];
                html = `
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                        <div class="analytics-stat-card">
                            <div class="text-4xl font-bold mb-2">${analytics.views || 0}</div>
                            <div class="text-sm opacity-90">Total Views</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.callClicks || 0}</div>
                            <div class="text-sm opacity-90">Call Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.websiteClicks || 0}</div>
                            <div class="text-sm opacity-90">Website Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.directionClicks || 0}</div>
                            <div class="text-sm opacity-90">Direction Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.shareClicks || 0}</div>
                            <div class="text-sm opacity-90">Share Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.videoPlays || 0}</div>
                            <div class="text-sm opacity-90">Video Plays</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                            <div class="text-lg font-bold mb-2">${analytics.lastViewed ? new Date(analytics.lastViewed).toLocaleString() : 'Never'}</div>
                            <div class="text-sm opacity-90">Last Viewed</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);">
                            <div class="text-4xl font-bold mb-2">${recentViews.length}</div>
                            <div class="text-sm opacity-90">Total Actions</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-bold text-gray-900 mb-3">Recent Activity</h3>
                        <div class="space-y-2">
                            ${recentViews.slice(-50).reverse().map(v => `
                                <div class="flex justify-between text-sm border-b pb-2">
                                    <span class="font-medium">${v.action}</span>
                                    <span class="text-gray-600">${new Date(v.timestamp).toLocaleString()}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('analyticsContent').innerHTML = html;
        }
        async function loadDatabase() {
            try {
                const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${DATABASE_PATH}`);
                const data = await response.json();
                allListings = data.listings;
                
                // Find updated current listing
                const updatedListing = allListings.find(l => l.id === currentListing.id);
                if (updatedListing) {
                    currentListing = updatedListing;
                    renderDashboard();
                }
            } catch (error) {
                console.error('Error loading database:', error);
                alert('Failed to refresh data. Please try again.');
            }
        }

        async function saveChanges() {
            if (!currentListing) return;
            
            // Validate inputs
            const tagline = document.getElementById('editTagline').value.trim();
            if (!tagline) {
                alert('Tagline is required');
                return;
            }
            
            const tier = currentListing.tier || 'FREE';
            const maxDesc = tier === 'FREE' ? 500 : 1000;
            const description = document.getElementById('editDescription').value;
            
            if (description.length > maxDesc) {
                alert(`Description too long! Maximum ${maxDesc} characters for ${tier} tier.`);
                return;
            }
            
            // Build updated listing
            const updatedListing = {
                ...currentListing,
                tagline: tagline,
                description: description,
                subcategories: selectedSubcategories,
                phone: document.getElementById('editPhone').value || null,
                email: document.getElementById('editEmail').value || null,
                website: document.getElementById('editWebsite').value || null,
                address: document.getElementById('editAddress').value || null,
                city: document.getElementById('editCity').value || null,
                state: document.getElementById('editState').value || null,
                zipCode: document.getElementById('editZipCode').value || null,
                hours: {
                    monday: document.getElementById('editHoursMonday').value || null,
                    tuesday: document.getElementById('editHoursTuesday').value || null,
                    wednesday: document.getElementById('editHoursWednesday').value || null,
                    thursday: document.getElementById('editHoursThursday').value || null,
                    friday: document.getElementById('editHoursFriday').value || null,
                    saturday: document.getElementById('editHoursSaturday').value || null,
                    sunday: document.getElementById('editHoursSunday').value || null
                },
                socialMedia: {
                    ...currentListing.socialMedia,
                    facebook: document.getElementById('editFacebook').value || null,
                    instagram: document.getElementById('editInstagram').value || null,
                    twitter: document.getElementById('editTwitter').value || null,
                    youtube: document.getElementById('editYoutube').value || null,
                    tiktok: document.getElementById('editTiktok').value || null,
                    linkedin: document.getElementById('editLinkedin').value || null
                },
                reviews: {
                    ...currentListing.reviews,
                    google: document.getElementById('editGoogle').value || null,
                    yelp: document.getElementById('editYelp').value || null,
                    tripadvisor: document.getElementById('editTripadvisor').value || null
                },
                metadata: {
                    ...currentListing.metadata,
                    updatedAt: new Date().toISOString()
                }
            };
            
            // Add video for Premium tier
            if (tier === 'PREMIUM') {
                updatedListing.video = document.getElementById('editVideo')?.value || null;
            }
            
            // Handle images if uploaded
            if (uploadedImages.logo && !uploadedImages.logo.existing) {
                // For now, alert user that image upload requires admin approval
                alert('Image uploads will be processed. Your other changes have been saved.');
                // In production, you'd upload to a staging area or notify admin
            }
            
            if (uploadedImages.photos.some(p => !p.existing)) {
                alert('New photo uploads will be processed. Your other changes have been saved.');
                // In production, you'd upload to a staging area or notify admin
            }
            
            // For photos, keep existing ones
            if (uploadedImages.photos.length > 0) {
                updatedListing.photos = uploadedImages.photos.map(p => p.url);
            }
            
            // Update in allListings array
            const index = allListings.findIndex(l => l.id === currentListing.id);
            if (index > -1) {
                allListings[index] = updatedListing;
            }
            
            // Save to GitHub
            try {
                // Note: In production, this should go through a proper API
                // For now, we'll use direct GitHub API (requires token)
                
                // Get current file
                const getResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${DATABASE_PATH}`, {
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Accept': 'application/vnd.github.v3+json'
                    }
                });
                
                if (!getResponse.ok) {
                    throw new Error('Failed to load current database');
                }
                
                const fileData = await getResponse.json();
                databaseSha = fileData.sha;
                
                // Update and save
                const content = btoa(unescape(encodeURIComponent(JSON.stringify({ listings: allListings }, null, 2))));
                
                const putResponse = await fetch(`https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${DATABASE_PATH}`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `token ${GITHUB_TOKEN}`,
                        'Content-Type': 'application/json',
                        'Accept': 'application/vnd.github.v3+json'
                    },
                    body: JSON.stringify({
                        message: `Business portal update: ${currentListing.businessName}`,
                        content: content,
                        sha: databaseSha
                    })
                });
                
                if (putResponse.ok) {
                    alert('Changes saved successfully!');
                    currentListing = updatedListing;
                    renderDashboard();
                    switchTab('overview');
                } else {
                    throw new Error('Failed to save changes');
                }
            } catch (error) {
                console.error('Save error:', error);
                alert('Failed to save changes. Please try again or contact support.');
            }
        }
    </script>
</body>
</html>

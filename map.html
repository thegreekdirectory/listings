<!-- map.html -->
<!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. This source code is proprietary and no part may not be used, reproduced, or distributed without written permission from The Greek Directory. For more information, visit https://thegreekdirectory.org/legal. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Map - The Greek Directory</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="https://static.thegreekdirectory.org/img/logo/bluefavicon.png" media="(prefers-color-scheme: light)">
    <link rel="icon" href="https://static.thegreekdirectory.org/img/logo/whitefavicon.png" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="https://static.thegreekdirectory.org/img/logo/icon-192.png">
    
    <!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. -->
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/listings.css">
    <link rel="stylesheet" href="css/pwa.css">
    
    <style>
        /* Copyright (C) The Greek Directory, 2025-present. All rights reserved. */
        .pwa-splash {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .pwa-splash.fade-out {
            opacity: 0;
            visibility: hidden;
        }
        
        .pwa-splash-logo {
            width: 120px;
            height: auto;
        }
        
        @media (prefers-color-scheme: dark) {
            .pwa-splash {
                background: #000000;
            }
        }
        
        /* Copyright (C) The Greek Directory, 2025-present. All rights reserved. */
        
        html, body {
            height: 100%;
        }

        .map-page {
            min-height: calc(100vh - 160px);
            display: flex;
            flex-direction: column;
        }

        .map-shell {
            flex: 1;
            min-height: 320px;
        }

        #map {
            height: 100%;
            width: 100%;
        }
        
        body.pwa-mode .map-page {
            min-height: calc(100vh - env(safe-area-inset-top, 0px) - env(safe-area-inset-bottom, 0px) - 80px);
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header (hidden in PWA mode) -->
    <div data-partial="header"></div>
    
    <!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. -->
    
    <div class="max-w-7xl mx-auto px-4 py-4 map-page">
        <div class="flex items-center justify-between mb-4">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Map View</h1>
                <p class="text-sm text-gray-600" id="resultsCount">Loading...</p>
            </div>
            <button id="filterBtn" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                <span>üîç</span>
                <span class="text-sm font-medium">Filters</span>
            </button>
        </div>
        
        <!-- Filter Panel -->
        <div id="filterPanel" class="hidden mb-4 p-4 bg-gray-50 rounded-lg border border-gray-200">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-900">Filters</h3>
                <div class="flex gap-2">
                    <button id="clearFiltersBtn" class="text-sm text-blue-600 hover:text-blue-800">Clear All</button>
                    <button id="closeFilterBtn" class="text-gray-500">‚úï</button>
                </div>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Categories</label>
                    <input type="text" id="categorySearch" placeholder="Type to search..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <div id="categoryFilters" class="grid grid-cols-2 gap-2"></div>
                </div>
                <div id="subcategoryContainer" class="hidden">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700">Subcategories</label>
                        <div class="toggle-group">
                            <button class="toggle-option active" data-mode="any" onclick="setSubcategoryMode('any')">Any</button>
                            <button class="toggle-option" data-mode="all" onclick="setSubcategoryMode('all')">All</button>
                        </div>
                    </div>
                    <div id="subcategoryFilters" class="flex flex-wrap gap-2"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                    <select id="countryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div id="stateFilterContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                    <select id="stateFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">All States</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. -->
        
        <!-- Map Container -->
        <div class="map-shell border rounded-lg relative bg-white">
            <div class="map-loading" id="mapLoading" style="display: none;">
                <div class="spinner"></div>
                <p class="text-sm text-gray-600 mt-2 text-center">Loading map...</p>
            </div>
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-control-btn" id="locateBtn" title="Find my location">
                    <svg id="locateBtnIcon" width="16" height="16" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg" fill="#045093">
                        <polygon points="0,9.28 9.894,9.99 10.78,20 20,0"/>
                    </svg>
                    <span class="desktop-only">Current Location</span>
                </button>
                <button class="map-control-btn" id="resetMapBtn" title="Reset map view">
                    <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="#045093"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/></svg>
                    <span class="desktop-only">Reload</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer (hidden in PWA mode) -->
    <div data-partial="footer"></div>
    
    <!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. -->
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script src="js/pwa/storage.js"></script>
    <script src="js/pwa/app.js"></script>
    <script src="js/pwa/dock.js"></script>
    <script src="js/pwa/starred.js"></script>
    <script src="js/partials-loader.js"></script>
    
    <script>
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        const SUPABASE_URL = 'https://luetekzqrrgdxtopzvqw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1ZXRla3pxcnJnZHh0b3B6dnF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNDc2NDcsImV4cCI6MjA4MzkyMzY0N30.TIrNG8VGumEJc_9JvNHW-Q-UWfUGpPxR0v8POjWZJYg';
        
        const CATEGORIES = [
            'Automotive & Transportation', 'Beauty & Health', 'Church & Religious Organization',
            'Cultural/Fraternal Organization', 'Education & Community', 'Entertainment, Arts & Recreation',
            'Food & Hospitality', 'Grocery & Imports', 'Home & Construction', 'Industrial & Manufacturing',
            'Pets & Veterinary', 'Professional & Business Services', 'Real Estate & Development', 'Retail & Shopping'
        ];
        
        const US_STATES = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
            'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
            'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
            'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
            'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
            'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
            'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
            'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
            'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
            'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
        };
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        let mapSupabase = null;
        let allListings = [];
        let filteredListings = [];
        let map = null;
        let markerClusterGroup = null;
        let userLocation = null;
        let userLocationMarker = null;
        let selectedCategory = 'All';
        let selectedSubcategories = [];
        let subcategoryMode = 'any';
        let selectedCountry = '';
        let selectedState = '';
        let SUBCATEGORIES = {};
        let filtersOpen = false;
        
        function formatPhoneDisplay(phone) {
            if (!phone) return '';
            const digits = phone.replace(/\D/g, '');
            if (phone.startsWith('+1') && digits.length === 11) {
                return `(${digits.substr(1, 3)}) ${digits.substr(4, 3)}-${digits.substr(7, 4)}`;
            }
            return phone;
        }

        function isPwaMode() {
            return (window.PWAApp && window.PWAApp.isStandalone) ||
                window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone === true;
        }

        function getFullAddress(listing) {
            if (listing.city && listing.state) {
                if (listing.address) {
                    return `${listing.address}, ${listing.city}, ${listing.state} ${listing.zip_code || ''}`.trim();
                }
                return `${listing.city}, ${listing.state}`.trim();
            }
            return listing.address || '';
        }

        function getDirectionsUrl(listing) {
            const fullAddr = getFullAddress(listing);
            const encoded = encodeURIComponent(fullAddr);
            const preferred = localStorage.getItem('tgd_default_map_app') || '';

            if (isPwaMode() && preferred) {
                if (preferred === 'apple') {
                    return `https://maps.apple.com/?daddr=${encoded}`;
                }
                if (preferred === 'waze') {
                    if (listing.coordinates) {
                        return `https://waze.com/ul?ll=${listing.coordinates.lat},${listing.coordinates.lng}&navigate=yes`;
                    }
                    return `https://waze.com/ul?q=${encoded}&navigate=yes`;
                }
                return `https://www.google.com/maps/dir/?api=1&destination=${encoded}`;
            }

            return `https://www.google.com/maps/dir/?api=1&destination=${encoded}`;
        }

        function isOpenNow(hours) {
            if (!hours || typeof hours !== 'object' || Object.keys(hours).length === 0) return null;
            const hasAnyHours = Object.values(hours).some(h => h && h.trim() !== '');
            if (!hasAnyHours) return null;
            const now = new Date();
            const centralTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = days[centralTime.getDay()];
            const todayHours = hours[today];
            if (!todayHours || todayHours.toLowerCase() === 'closed') return false;
            const match = todayHours.match(/(\d{1,2}):(\d{2})\s*(AM|PM)\s*-\s*(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) return null;
            const [, startHour, startMin, startPeriod, endHour, endMin, endPeriod] = match;
            let start = parseInt(startHour);
            let end = parseInt(endHour);
            if (startPeriod.toUpperCase() === 'PM' && start !== 12) start += 12;
            if (startPeriod.toUpperCase() === 'AM' && start === 12) start = 0;
            if (endPeriod.toUpperCase() === 'PM' && end !== 12) end += 12;
            if (endPeriod.toUpperCase() === 'AM' && end === 12) end = 0;
            const currentMinutes = centralTime.getHours() * 60 + centralTime.getMinutes();
            const startMinutes = start * 60 + parseInt(startMin);
            const endMinutes = end * 60 + parseInt(endMin);
            return currentMinutes >= startMinutes && currentMinutes <= endMinutes;
        }

        function isOpeningSoon(hours) {
            if (!hours || typeof hours !== 'object') return false;
            const now = new Date();
            const centralTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = days[centralTime.getDay()];
            const todayHours = hours[today];
            if (!todayHours || todayHours.toLowerCase() === 'closed') return false;
            const match = todayHours.match(/(\d{1,2}):(\d{2})\s*(AM|PM)\s*-\s*(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) return false;
            const [, startHour, startMin, startPeriod] = match;
            let start = parseInt(startHour);
            if (startPeriod.toUpperCase() === 'PM' && start !== 12) start += 12;
            if (startPeriod.toUpperCase() === 'AM' && start === 12) start = 0;
            const currentMinutes = centralTime.getHours() * 60 + centralTime.getMinutes();
            const startMinutes = start * 60 + parseInt(startMin);
            const diff = startMinutes - currentMinutes;
            return diff > 0 && diff <= 60;
        }

        function isClosingSoon(hours) {
            if (!hours || typeof hours !== 'object') return false;
            const now = new Date();
            const centralTime = new Date(now.toLocaleString('en-US', { timeZone: 'America/Chicago' }));
            const days = ['sunday', 'monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday'];
            const today = days[centralTime.getDay()];
            const todayHours = hours[today];
            if (!todayHours || todayHours.toLowerCase() === 'closed') return false;
            const match = todayHours.match(/(\d{1,2}):(\d{2})\s*(AM|PM)\s*-\s*(\d{1,2}):(\d{2})\s*(AM|PM)/i);
            if (!match) return false;
            const [, , , , endHour, endMin, endPeriod] = match;
            let end = parseInt(endHour);
            if (endPeriod.toUpperCase() === 'PM' && end !== 12) end += 12;
            if (endPeriod.toUpperCase() === 'AM' && end === 12) end = 0;
            const currentMinutes = centralTime.getHours() * 60 + centralTime.getMinutes();
            const endMinutes = end * 60 + parseInt(endMin);
            const diff = endMinutes - currentMinutes;
            return diff > 0 && diff <= 60;
        }

        function buildBadges(listing) {
            const badges = [];
            const openStatus = isOpenNow(listing.hours);
            const openingSoon = isOpeningSoon(listing.hours);
            const closingSoon = isClosingSoon(listing.hours);

            if (openingSoon) {
                badges.push('<span class="badge badge-opening-soon">Opening Soon</span>');
            } else if (closingSoon) {
                badges.push('<span class="badge badge-closing-soon">Closing Soon</span>');
            } else if (openStatus === true) {
                badges.push('<span class="badge badge-open">Open</span>');
            } else if (openStatus === false) {
                badges.push('<span class="badge badge-closed">Closed</span>');
            }

            const isFeatured = listing.tier === 'FEATURED' || listing.tier === 'PREMIUM';
            const isVerified = listing.verified || listing.tier === 'VERIFIED';

            if (isFeatured) {
                badges.push('<span class="badge badge-featured">Featured</span>');
            } else if (isVerified) {
                badges.push('<span class="badge badge-verified">Verified</span>');
            }

            return badges;
        }

        function showsVerifiedCheckmark(listing) {
            const isFeatured = listing.tier === 'FEATURED' || listing.tier === 'PREMIUM';
            const isVerified = listing.verified || listing.tier === 'VERIFIED';
            return isFeatured || isVerified || listing.show_claim_button === false;
        }

        function generateCallButton(listing) {
            if (!listing.phone) return '';
            return `
                <a href="tel:${listing.phone}" 
                   onclick="event.stopPropagation();"
                   style="position:absolute;bottom:8px;right:116px;display:inline-flex;align-items:center;gap:4px;padding:6px 10px;background:#10b981;color:white;border-radius:6px;font-size:12px;font-weight:500;text-decoration:none;box-shadow:0 2px 4px rgba(0,0,0,0.1);transition:background 0.2s;z-index:10;" 
                   onmouseover="this.style.background='#059669'" 
                   onmouseout="this.style.background='#10b981'">
                    <svg style="width:14px;height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                    </svg>
                    Call
                </a>
            `;
        }

        function buildMapPopupContent(listing) {
            const badges = buildBadges(listing);
            const checkmarkHtml = showsVerifiedCheckmark(listing)
                ? '<svg style="width:16px;height:16px;margin-left:4px;flex-shrink:0;" viewBox="0 0 24 24" fill="none"><circle cx="12" cy="12" r="12" fill="#055193"/><path d="M7 12.5l3.5 3.5L17 9" stroke="white" stroke-width="2.2" stroke-linecap="round" stroke-linejoin="round"/></svg>'
                : '';
            const categorySlug = listing.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            const firstPhoto = listing.photos && listing.photos.length > 0 ? listing.photos[0] : (listing.logo || '');
            const heroImage = firstPhoto || '';
            const logoImage = listing.logo || '';
            const fullAddr = getFullAddress(listing);
            const directionsUrl = getDirectionsUrl(listing);
            const callButton = generateCallButton(listing);

            return `
                <div class="map-popup" style="width: 280px;">
                    ${heroImage ? `
                        <img src="${heroImage}" 
                             alt="${listing.business_name}" 
                             style="width:100%;height:140px;object-fit:cover;border-radius:12px 12px 0 0;">
                    ` : `
                        <div style="width:100%;height:140px;background:linear-gradient(135deg, #045093 0%, #0369a1 100%);border-radius:12px 12px 0 0;display:flex;align-items:center;justify-content:center;">
                            <svg style="width:48px;height:48px;color:rgba(255,255,255,0.5);" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M4 3a2 2 0 00-2 2v10a2 2 0 002 2h12a2 2 0 002-2V5a2 2 0 00-2-2H4zm12 12H4l4-8 3 6 2-4 3 6z" clip-rule="evenodd"/>
                            </svg>
                        </div>
                    `}
                    
                    <div class="map-popup-content" style="padding: 12px; padding-bottom: 50px; position: relative;">
                        ${logoImage ? `<div style="width:48px;height:48px;background:white;border-radius:8px;padding:4px;display:flex;align-items:center;justify-content:center;position:absolute;top:-24px;right:12px;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.15);"><img src="${logoImage}" alt="${listing.business_name} logo" style="width:100%;height:100%;object-fit:contain;border-radius:4px;"></div>` : ''}
                        
                        <div class="map-popup-info">
                            <div class="map-popup-badges" style="display:flex;flex-wrap:wrap;gap:4px;margin-bottom:8px;">
                                ${badges.join('')}
                            </div>
                            
                            <a href="/listing/${listing.slug}" 
                               class="map-popup-title" 
                               style="font-size:16px;font-weight:700;color:#1f2937;text-decoration:none;display:flex;align-items:center;gap:4px;margin-bottom:6px;line-height:1.3;">
                                ${listing.business_name}${checkmarkHtml}
                            </a>
                            
                            ${listing.tagline ? `
                                <div class="map-popup-tagline" style="font-size:13px;color:#6b7280;margin-bottom:8px;line-height:1.4;">
                                    ${listing.tagline}
                                </div>
                            ` : ''}
                            
                            <div class="map-popup-details" style="font-size:12px;color:#6b7280;margin-bottom:4px;">
                                <div style="display:flex;align-items:start;gap:6px;margin-bottom:4px;">
                                    <svg style="width:14px;height:14px;margin-top:2px;flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z"/>
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"/>
                                    </svg>
                                    <span style="line-height:1.4;">${fullAddr}</span>
                                </div>
                                
                                ${listing.phone ? `
                                    <div style="display:flex;align-items:center;gap:6px;">
                                        <svg style="width:14px;height:14px;flex-shrink:0;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"/>
                                        </svg>
                                        <span>${formatPhoneDisplay(listing.phone)}</span>
                                    </div>
                                ` : ''}
                            </div>
                            
                            ${callButton}
                            
                            <a href="${directionsUrl}" 
                               target="_blank" 
                               rel="noopener noreferrer"
                               onclick="event.stopPropagation();"
                               style="position:absolute;bottom:8px;right:8px;display:inline-flex;align-items:center;gap:4px;padding:6px 10px;background:#045093;color:white;border-radius:6px;font-size:12px;font-weight:500;text-decoration:none;box-shadow:0 2px 4px rgba(0,0,0,0.1);transition:background 0.2s;" 
                               onmouseover="this.style.background='#033d7a'" 
                               onmouseout="this.style.background='#045093'">
                                <svg style="width:14px;height:14px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"/>
                                </svg>
                                Directions
                            </a>
                        </div>
                    </div>
                </div>
            `;
        }
        
        function extractSubcategoriesFromListings(listings) {
            const subcatsByCategory = {};
            listings.forEach(listing => {
                if (listing.category && listing.subcategories && Array.isArray(listing.subcategories)) {
                    if (!subcatsByCategory[listing.category]) {
                        subcatsByCategory[listing.category] = new Set();
                    }
                    listing.subcategories.forEach(sub => {
                        subcatsByCategory[listing.category].add(sub);
                    });
                }
            });
            const result = {};
            Object.keys(subcatsByCategory).forEach(category => {
                result[category] = Array.from(subcatsByCategory[category]).sort();
            });
            return result;
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        async function loadListings() {
            try {
                document.getElementById('mapLoading').style.display = 'block';
                
                mapSupabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                const { data, error } = await mapSupabase
                    .from('listings')
                    .select('*')
                    .eq('visible', true)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allListings = data || [];
                filteredListings = [...allListings];
                
                SUBCATEGORIES = extractSubcategoriesFromListings(allListings);
                
                populateCountryFilter();
                createCategoryButtons();
                await geocodeAllListings();
                updateResultsCount();
                initMap();
                
                document.getElementById('mapLoading').style.display = 'none';
            } catch (error) {
                console.error('Error loading listings:', error);
                document.getElementById('mapLoading').style.display = 'none';
            }
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function initMap() {
            if (map) return;
            
            map = L.map('map', { 
                center: [39.8283, -98.5795], 
                zoom: 4, 
                zoomControl: true,
                scrollWheelZoom: false
            });
            
            map.on('click', function() {
                map.scrollWheelZoom.enable();
            });
            
            map.on('mouseout', function() {
                map.scrollWheelZoom.disable();
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 50,
                disableClusteringAtZoom: 18,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count >= 10) size = 'medium';
                    if (count >= 50) size = 'large';
                    return L.divIcon({
                        html: `<div class="marker-cluster marker-cluster-${size}">${count}</div>`,
                        className: '',
                        iconSize: size === 'small' ? [40, 40] : size === 'medium' ? [50, 50] : [60, 60]
                    });
                }
            });
            
            map.addLayer(markerClusterGroup);
            
            if (userLocation) addUserLocationMarker();
            
            setTimeout(() => {
                map.invalidateSize();
                updateMapMarkers();
            }, 500);
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        async function geocodeAllListings() {
            for (let listing of allListings) {
                if (!listing.coordinates && listing.address && listing.city && listing.state) {
                    await geocodeListing(listing);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            if (map) updateMapMarkers();
        }
        
        async function geocodeListing(listing) {
            const fullAddress = `${listing.address}, ${listing.city}, ${listing.state}`;
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    listing.coordinates = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                }
            } catch (e) {
                console.error('Geocoding failed for', listing.business_name, e);
            }
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function updateMapMarkers() {
            if (!map || !markerClusterGroup) return;
            
            markerClusterGroup.clearLayers();
            const bounds = [];
            
            filteredListings.forEach(listing => {
                if (listing.coordinates) {
                    const logoImage = listing.logo || '';
                    const isFeatured = listing.tier === 'FEATURED' || listing.tier === 'PREMIUM';
                    
                    const iconClass = isFeatured ? 'custom-marker featured' : 'custom-marker';
                    const iconHtml = logoImage ? 
                        `<div class="${iconClass}"><img src="${logoImage}" alt="${listing.business_name}"></div>` :
                        `<div class="${iconClass}"><div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:12px;color:#666;">No logo</div></div>`;
                    
                    const customIcon = L.divIcon({ 
                        html: iconHtml, 
                        className: '', 
                        iconSize: [40, 40], 
                        iconAnchor: [20, 20] 
                    });
                    
                    const marker = L.marker([listing.coordinates.lat, listing.coordinates.lng], { 
                        icon: customIcon, 
                        riseOnHover: true 
                    });

                    const popupContent = buildMapPopupContent(listing);
                    marker.bindPopup(popupContent, { maxWidth: 320, className: 'custom-popup' });
                    markerClusterGroup.addLayer(marker);
                    bounds.push([listing.coordinates.lat, listing.coordinates.lng]);
                }
            });
            
            if (bounds.length > 0) {
                map.fitBounds(L.latLngBounds(bounds), { padding: [50, 50], maxZoom: 15 });
            }
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function addUserLocationMarker() {
            if (!map || !userLocation) return;
            if (userLocationMarker) map.removeLayer(userLocationMarker);
            
            const userIcon = L.divIcon({
                html: '<div style="width: 16px; height: 16px; background: #4285F4; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 8px rgba(0,0,0,0.3);"></div>',
                className: '', 
                iconSize: [22, 22], 
                iconAnchor: [11, 11]
            });
            
            userLocationMarker = L.marker([userLocation.lat, userLocation.lng], {
                icon: userIcon, 
                zIndexOffset: 1000
            }).addTo(map);
            
            userLocationMarker.bindPopup('<strong>Your Location</strong>');
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function applyFilters() {
            filteredListings = allListings.filter(listing => {
                const matchesCategory = selectedCategory === 'All' || listing.category === selectedCategory;
                
                let matchesSubcategory = true;
                if (selectedSubcategories.length > 0 && listing.subcategories) {
                    if (subcategoryMode === 'all') {
                        matchesSubcategory = selectedSubcategories.every(sub => listing.subcategories.includes(sub));
                    } else {
                        matchesSubcategory = selectedSubcategories.some(sub => listing.subcategories.includes(sub));
                    }
                } else if (selectedSubcategories.length > 0) {
                    matchesSubcategory = false;
                }
                
                const matchesCountry = !selectedCountry || (listing.country || 'USA') === selectedCountry;
                const matchesState = !selectedState || listing.state === selectedState;
                
                return matchesCategory && matchesSubcategory && matchesCountry && matchesState;
            });
            
            updateResultsCount();
            if (map) updateMapMarkers();
        }
        
        function updateResultsCount() {
            const count = filteredListings.length;
            document.getElementById('resultsCount').textContent = `${count} ${count === 1 ? 'listing' : 'listings'} found`;
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function createCategoryButtons() {
            const container = document.getElementById('categoryFilters');
            if (!container) return;
            
            container.innerHTML = '';
            
            const allButton = document.createElement('button');
            allButton.className = selectedCategory === 'All' ? 
                'px-3 py-2 rounded-lg text-sm font-medium text-white' : 
                'px-3 py-2 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300';
            if (selectedCategory === 'All') allButton.style.backgroundColor = '#055193';
            allButton.textContent = 'All';
            allButton.onclick = () => filterByCategory('All');
            container.appendChild(allButton);
            
            CATEGORIES.forEach(cat => {
                const button = document.createElement('button');
                button.className = selectedCategory === cat ? 
                    'px-3 py-2 rounded-lg text-sm font-medium text-white' : 
                    'px-3 py-2 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300';
                if (selectedCategory === cat) button.style.backgroundColor = '#055193';
                button.textContent = cat;
                button.onclick = () => filterByCategory(cat);
                container.appendChild(button);
            });
        }
        
        function filterByCategory(category) {
            selectedCategory = category || 'All';
            selectedSubcategories = [];
            createCategoryButtons();
            updateSubcategoryDisplay();
            applyFilters();
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function updateSubcategoryDisplay() {
            const container = document.getElementById('subcategoryContainer');
            const filtersDiv = document.getElementById('subcategoryFilters');
            
            if (selectedCategory && selectedCategory !== 'All' && SUBCATEGORIES[selectedCategory]) {
                container.classList.remove('hidden');
                filtersDiv.innerHTML = '';
                
                SUBCATEGORIES[selectedCategory].forEach(sub => {
                    const tag = document.createElement('div');
                    tag.className = 'subcategory-tag';
                    tag.textContent = sub;
                    if (selectedSubcategories.includes(sub)) {
                        tag.classList.add('selected');
                    }
                    tag.onclick = () => toggleSubcategory(sub);
                    filtersDiv.appendChild(tag);
                });
            } else {
                container.classList.add('hidden');
            }
        }
        
        function toggleSubcategory(subcategory) {
            const index = selectedSubcategories.indexOf(subcategory);
            if (index > -1) {
                selectedSubcategories.splice(index, 1);
            } else {
                selectedSubcategories.push(subcategory);
            }
            updateSubcategoryDisplay();
            applyFilters();
        }
        
        window.setSubcategoryMode = function(mode) {
            subcategoryMode = mode;
            document.querySelectorAll('.toggle-option').forEach(opt => {
                if (opt.dataset.mode === mode) opt.classList.add('active');
                else opt.classList.remove('active');
            });
            applyFilters();
        };
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function populateCountryFilter() {
            const countries = [...new Set(allListings.map(l => l.country || 'USA'))].sort();
            const select = document.getElementById('countryFilter');
            if (select) {
                select.innerHTML = '<option value="">All Countries</option>';
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country === 'USA' ? 'United States' : country;
                    select.appendChild(option);
                });
            }
        }
        
        function populateStateFilter(country) {
            if (country === 'USA') {
                const states = [...new Set(allListings.filter(l => (l.country || 'USA') === 'USA').map(l => l.state))].sort();
                const select = document.getElementById('stateFilter');
                if (select) {
                    select.innerHTML = '<option value="">All States</option>';
                    states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state;
                        option.textContent = `${US_STATES[state] || state} (${state})`;
                        select.appendChild(option);
                    });
                }
            }
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function setupEventListeners() {
            document.getElementById('filterBtn')?.addEventListener('click', () => {
                filtersOpen = !filtersOpen;
                const panel = document.getElementById('filterPanel');
                if (filtersOpen) {
                    panel.classList.remove('hidden');
                } else {
                    panel.classList.add('hidden');
                }
            });
            
            document.getElementById('closeFilterBtn')?.addEventListener('click', () => {
                document.getElementById('filterPanel').classList.add('hidden');
                filtersOpen = false;
            });
            
            document.getElementById('clearFiltersBtn')?.addEventListener('click', () => {
                selectedCategory = 'All';
                selectedSubcategories = [];
                selectedCountry = '';
                selectedState = '';
                
                document.getElementById('categorySearch').value = '';
                document.getElementById('countryFilter').value = '';
                document.getElementById('stateFilter').value = '';
                document.getElementById('stateFilterContainer').classList.add('hidden');
                
                createCategoryButtons();
                updateSubcategoryDisplay();
                applyFilters();
            });
            
            document.getElementById('categorySearch')?.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (!searchTerm) {
                    createCategoryButtons();
                    return;
                }
                
                const matchingCategories = CATEGORIES.filter(cat => 
                    cat.toLowerCase().includes(searchTerm)
                );
                
                const container = document.getElementById('categoryFilters');
                container.innerHTML = '';
                
                matchingCategories.forEach(cat => {
                    const button = document.createElement('button');
                    button.className = selectedCategory === cat ? 
                        'px-3 py-2 rounded-lg text-sm font-medium text-white' : 
                        'px-3 py-2 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300';
                    if (selectedCategory === cat) button.style.backgroundColor = '#055193';
                    button.textContent = cat;
                    button.onclick = () => filterByCategory(cat);
                    container.appendChild(button);
                });
            });
            
            document.getElementById('countryFilter')?.addEventListener('change', (e) => {
                selectedCountry = e.target.value;
                
                if (selectedCountry === 'USA') {
                    document.getElementById('stateFilterContainer').classList.remove('hidden');
                    populateStateFilter('USA');
                } else {
                    document.getElementById('stateFilterContainer').classList.add('hidden');
                    selectedState = '';
                }
                
                applyFilters();
            });
            
            document.getElementById('stateFilter')?.addEventListener('change', (e) => {
                selectedState = e.target.value;
                applyFilters();
            });
            
            document.getElementById('locateBtn')?.addEventListener('click', () => {
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        position => {
                            userLocation = { 
                                lat: position.coords.latitude, 
                                lng: position.coords.longitude 
                            };
                            if (map) {
                                map.setView([userLocation.lat, userLocation.lng], 13);
                                addUserLocationMarker();
                            }
                        },
                        error => console.error('Location error:', error)
                    );
                }
            });
            
            document.getElementById('resetMapBtn')?.addEventListener('click', () => {
                if (map) {
                    map.setView([39.8283, -98.5795], 4);
                }
            });
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        document.addEventListener('DOMContentLoaded', () => {
            loadListings();
            setupEventListeners();
        });
    </script>
</body>
</html>
<!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. This source code is proprietary and no part may not be used, reproduced, or distributed without written permission from The Greek Directory. For more information, visit https://thegreekdirectory.org/legal. -->

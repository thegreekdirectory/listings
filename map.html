<!-- map.html -->
<!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. This source code is proprietary and no part may not be used, reproduced, or distributed without written permission from The Greek Directory. For more information, visit https://thegreekdirectory.org/legal. -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Map - The Greek Directory</title>
    
    <link rel="manifest" href="/manifest.json">
    <link rel="icon" href="https://static.thegreekdirectory.org/img/logo/bluefavicon.png" media="(prefers-color-scheme: light)">
    <link rel="icon" href="https://static.thegreekdirectory.org/img/logo/whitefavicon.png" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="https://static.thegreekdirectory.org/img/logo/icon-192.png">
    
    <!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. -->
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" />
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="css/index.css">
    <link rel="stylesheet" href="css/listings.css">
    <link rel="stylesheet" href="css/pwa.css">
    
    <!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. -->
    
    <style>
        /* Inline splash screen styles for immediate render */
        .pwa-splash {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease, visibility 0.5s ease;
        }
        
        .pwa-splash.fade-out {
            opacity: 0;
            visibility: hidden;
        }
        
        .pwa-splash-logo {
            width: 120px;
            height: auto;
        }
        
        @media (prefers-color-scheme: dark) {
            .pwa-splash {
                background: #000000;
            }
        }
        
        /* Copyright (C) The Greek Directory, 2025-present. All rights reserved. */
        
        #map {
            height: calc(100vh - 140px);
            width: 100%;
        }
        
        body.pwa-mode #map {
            height: calc(100vh - env(safe-area-inset-top, 0px) - 60px - env(safe-area-inset-bottom, 0px) - 80px);
        }
        
        .filter-panel-map {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Header (hidden in PWA mode) -->
    <div data-partial="header"></div>
    
    <!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. -->
    
    <div class="max-w-7xl mx-auto px-4 py-4">
        <div class="mb-4 flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">Map View</h1>
                <p id="resultsCount" class="text-sm text-gray-600">Loading...</p>
            </div>
            <button id="filterBtn" class="flex items-center gap-2 px-4 py-2 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                <span>üîç</span>
                <span class="text-sm font-medium">Filters</span>
            </button>
        </div>
        
        <!-- Filter Panel -->
        <div id="filterPanel" class="hidden mt-4 mb-4 p-4 bg-white rounded-lg border border-gray-200 filter-panel-map">
            <div class="flex items-center justify-between mb-3">
                <h3 class="font-semibold text-gray-900">Filters</h3>
                <div class="flex gap-2">
                    <button id="clearFiltersBtn" class="text-sm text-blue-600 hover:text-blue-800">Clear All</button>
                    <button id="closeFilterBtn" class="text-gray-500">‚úï</button>
                </div>
            </div>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search Categories</label>
                    <input type="text" id="categorySearch" placeholder="Type to search..." 
                        class="w-full px-3 py-2 border border-gray-300 rounded-lg mb-2">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                    <div id="categoryFilters" class="grid grid-cols-2 gap-2"></div>
                </div>
                <div id="subcategoryContainer" class="hidden">
                    <div class="flex items-center justify-between mb-2">
                        <label class="block text-sm font-medium text-gray-700">Subcategories</label>
                        <div class="toggle-group">
                            <button class="toggle-option active" data-mode="any" onclick="setSubcategoryMode('any')">Any</button>
                            <button class="toggle-option" data-mode="all" onclick="setSubcategoryMode('all')">All</button>
                        </div>
                    </div>
                    <div id="subcategoryFilters" class="flex flex-wrap gap-2"></div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Country</label>
                    <select id="countryFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">All Countries</option>
                    </select>
                </div>
                <div id="stateFilterContainer" class="hidden">
                    <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                    <select id="stateFilter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                        <option value="">All States</option>
                    </select>
                </div>
            </div>
        </div>
        
        <!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. -->
        
        <!-- Map Container -->
        <div id="mapContainer" class="border rounded-lg overflow-hidden relative">
            <div class="map-loading" id="mapLoading">
                <div class="spinner"></div>
                <p class="text-sm text-gray-600 mt-2 text-center">Loading map...</p>
            </div>
            <div id="map"></div>
            <div class="map-controls">
                <button class="map-control-btn" id="locateBtn" title="Find my location">
                    <img src="https://help.apple.com/assets/68FABD5B6EF504342600E3E5/68FABD675A41CCC23909151C/en_US/7e877be3da64a66caf9a6dfb5fddad8f.png" alt="Location">
                    <span class="desktop-only">Current Location</span>
                </button>
                <button class="map-control-btn" id="resetMapBtn" title="Reset map view">
                    <span>üîÑ</span>
                    <span class="desktop-only">Reset</span>
                </button>
            </div>
        </div>
    </div>
    
    <!-- Footer (hidden in PWA mode) -->
    <div data-partial="footer"></div>
    
    <!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. -->
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
    
    <script src="js/pwa/storage.js"></script>
    <script src="js/pwa/app.js"></script>
    <script src="js/pwa/dock.js"></script>
    <script src="js/pwa/starred.js"></script>
    <script src="js/partials-loader.js"></script>
    
    <script>
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        const SUPABASE_URL = 'https://luetekzqrrgdxtopzvqw.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imx1ZXRla3pxcnJnZHh0b3B6dnF3Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgzNDc2NDcsImV4cCI6MjA4MzkyMzY0N30.TIrNG8VGumEJc_9JvNHW-Q-UWfUGpPxR0v8POjWZJYg';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        const CATEGORIES = [
            'Automotive & Transportation', 'Beauty & Health', 'Church & Religious Organization',
            'Cultural/Fraternal Organization', 'Education & Community', 'Entertainment, Arts & Recreation',
            'Food & Hospitality', 'Grocery & Imports', 'Home & Construction', 'Industrial & Manufacturing',
            'Pets & Veterinary', 'Professional & Business Services', 'Real Estate & Development', 'Retail & Shopping'
        ];
        
        const US_STATES = {
            'AL': 'Alabama', 'AK': 'Alaska', 'AZ': 'Arizona', 'AR': 'Arkansas', 'CA': 'California',
            'CO': 'Colorado', 'CT': 'Connecticut', 'DE': 'Delaware', 'FL': 'Florida', 'GA': 'Georgia',
            'HI': 'Hawaii', 'ID': 'Idaho', 'IL': 'Illinois', 'IN': 'Indiana', 'IA': 'Iowa',
            'KS': 'Kansas', 'KY': 'Kentucky', 'LA': 'Louisiana', 'ME': 'Maine', 'MD': 'Maryland',
            'MA': 'Massachusetts', 'MI': 'Michigan', 'MN': 'Minnesota', 'MS': 'Mississippi', 'MO': 'Missouri',
            'MT': 'Montana', 'NE': 'Nebraska', 'NV': 'Nevada', 'NH': 'New Hampshire', 'NJ': 'New Jersey',
            'NM': 'New Mexico', 'NY': 'New York', 'NC': 'North Carolina', 'ND': 'North Dakota', 'OH': 'Ohio',
            'OK': 'Oklahoma', 'OR': 'Oregon', 'PA': 'Pennsylvania', 'RI': 'Rhode Island', 'SC': 'South Carolina',
            'SD': 'South Dakota', 'TN': 'Tennessee', 'TX': 'Texas', 'UT': 'Utah', 'VT': 'Vermont',
            'VA': 'Virginia', 'WA': 'Washington', 'WV': 'West Virginia', 'WI': 'Wisconsin', 'WY': 'Wyoming'
        };
        
        let map, markerClusterGroup, allListings = [], filteredListings = [];
        let selectedCategory = 'All', selectedSubcategories = [], subcategoryMode = 'any';
        let selectedCountry = '', selectedState = '', userLocation = null, SUBCATEGORIES = {};
        let mapReady = false, userLocationMarker = null;
        const defaultMapCenter = [39.8283, -98.5795], defaultMapZoom = 4;
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function formatPhoneDisplay(phone) {
            if (!phone) return '';
            const digits = phone.replace(/\D/g, '');
            if (phone.startsWith('+1') && digits.length === 11) {
                return `(${digits.substr(1, 3)}) ${digits.substr(4, 3)}-${digits.substr(7, 4)}`;
            }
            return phone;
        }
        
        function getFullAddress(listing) {
            if (listing.city && listing.state) {
                if (listing.address) {
                    return `${listing.address}, ${listing.city}, ${listing.state} ${listing.zip_code || ''}`.trim();
                }
                return `${listing.city}, ${listing.state}`.trim();
            }
            return listing.address || '';
        }
        
        function isBasedIn(listing) {
            return listing.city && listing.state && !listing.address;
        }
        
        function extractSubcategoriesFromListings(listings) {
            const subcatsByCategory = {};
            listings.forEach(listing => {
                if (listing.category && listing.subcategories && Array.isArray(listing.subcategories)) {
                    if (!subcatsByCategory[listing.category]) {
                        subcatsByCategory[listing.category] = new Set();
                    }
                    listing.subcategories.forEach(sub => {
                        subcatsByCategory[listing.category].add(sub);
                    });
                }
            });
            const result = {};
            Object.keys(subcatsByCategory).forEach(category => {
                result[category] = Array.from(subcatsByCategory[category]).sort();
            });
            return result;
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        async function loadListings() {
            try {
                const { data, error } = await supabase
                    .from('listings')
                    .select('*')
                    .eq('visible', true)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                allListings = data || [];
                filteredListings = [...allListings];
                
                SUBCATEGORIES = extractSubcategoriesFromListings(allListings);
                console.log('Loaded', allListings.length, 'listings');
                
                populateCountryFilter();
                createCategoryButtons();
                applyFilters();
                geocodeAllListings();
            } catch (error) {
                console.error('Error loading listings:', error);
            }
        }
        
        function applyFilters() {
            filteredListings = allListings.filter(listing => {
                const matchesCategory = selectedCategory === 'All' || listing.category === selectedCategory;
                
                let matchesSubcategory = true;
                if (selectedSubcategories.length > 0 && listing.subcategories) {
                    if (subcategoryMode === 'all') {
                        matchesSubcategory = selectedSubcategories.every(sub => listing.subcategories.includes(sub));
                    } else {
                        matchesSubcategory = selectedSubcategories.some(sub => listing.subcategories.includes(sub));
                    }
                } else if (selectedSubcategories.length > 0) {
                    matchesSubcategory = false;
                }
                
                const matchesCountry = !selectedCountry || (listing.country || 'USA') === selectedCountry;
                const matchesState = !selectedState || listing.state === selectedState;
                
                return matchesCategory && matchesSubcategory && matchesCountry && matchesState;
            });
            
            updateResultsCount();
            updateMapMarkers();
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function updateResultsCount() {
            const count = filteredListings.length;
            const resultsCount = document.getElementById('resultsCount');
            if (resultsCount) {
                resultsCount.textContent = `${count} ${count === 1 ? 'listing' : 'listings'} found${selectedCategory !== 'All' ? ` in ${selectedCategory}` : ''}`;
            }
        }
        
        function createCategoryButtons() {
            const container = document.getElementById('categoryFilters');
            if (!container) return;
            
            container.innerHTML = '';
            
            const allButton = document.createElement('button');
            allButton.className = selectedCategory === 'All' ? 
                'px-3 py-2 rounded-lg text-sm font-medium text-white' : 
                'px-3 py-2 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300';
            if (selectedCategory === 'All') allButton.style.backgroundColor = '#055193';
            allButton.textContent = 'All';
            allButton.onclick = () => filterByCategory('All');
            container.appendChild(allButton);
            
            CATEGORIES.forEach(cat => {
                const button = document.createElement('button');
                button.className = selectedCategory === cat ? 
                    'px-3 py-2 rounded-lg text-sm font-medium text-white' : 
                    'px-3 py-2 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300';
                if (selectedCategory === cat) button.style.backgroundColor = '#055193';
                button.textContent = cat;
                button.onclick = () => filterByCategory(cat);
                container.appendChild(button);
            });
        }
        
        function filterByCategory(category) {
            selectedCategory = category || 'All';
            selectedSubcategories = [];
            createCategoryButtons();
            updateSubcategoryDisplay();
            applyFilters();
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function updateSubcategoryDisplay() {
            const container = document.getElementById('subcategoryContainer');
            const filtersDiv = document.getElementById('subcategoryFilters');
            
            if (selectedCategory && selectedCategory !== 'All' && SUBCATEGORIES[selectedCategory]) {
                if (container) container.classList.remove('hidden');
                if (filtersDiv) {
                    filtersDiv.innerHTML = '';
                    SUBCATEGORIES[selectedCategory].forEach(sub => {
                        const tag = document.createElement('div');
                        tag.className = 'subcategory-tag';
                        tag.textContent = sub;
                        if (selectedSubcategories.includes(sub)) {
                            tag.classList.add('selected');
                        }
                        tag.onclick = () => toggleSubcategory(sub);
                        filtersDiv.appendChild(tag);
                    });
                }
            } else {
                if (container) container.classList.add('hidden');
            }
        }
        
        function toggleSubcategory(subcategory) {
            const index = selectedSubcategories.indexOf(subcategory);
            if (index > -1) {
                selectedSubcategories.splice(index, 1);
            } else {
                selectedSubcategories.push(subcategory);
            }
            updateSubcategoryDisplay();
            applyFilters();
        }
        
        window.setSubcategoryMode = function(mode) {
            subcategoryMode = mode;
            document.querySelectorAll('.toggle-option').forEach(opt => {
                if (opt.dataset.mode === mode) opt.classList.add('active');
                else opt.classList.remove('active');
            });
            applyFilters();
        };
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function populateCountryFilter() {
            const countries = [...new Set(allListings.map(l => l.country || 'USA'))].sort();
            const select = document.getElementById('countryFilter');
            if (select) {
                select.innerHTML = '<option value="">All Countries</option>';
                countries.forEach(country => {
                    const option = document.createElement('option');
                    option.value = country;
                    option.textContent = country === 'USA' ? 'United States' : country;
                    select.appendChild(option);
                });
            }
        }
        
        function populateStateFilter(country) {
            if (country === 'USA') {
                const states = [...new Set(allListings.filter(l => (l.country || 'USA') === 'USA').map(l => l.state))].sort();
                const select = document.getElementById('stateFilter');
                if (select) {
                    select.innerHTML = '<option value="">All States</option>';
                    states.forEach(state => {
                        const option = document.createElement('option');
                        option.value = state;
                        option.textContent = `${US_STATES[state] || state} (${state})`;
                        select.appendChild(option);
                    });
                }
            }
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function initMap() {
            console.log('Initializing map...');
            
            map = L.map('map', { 
                center: defaultMapCenter, 
                zoom: defaultMapZoom, 
                zoomControl: true,
                scrollWheelZoom: false
            });
            
            map.on('click', function() {
                map.scrollWheelZoom.enable();
            });
            map.on('mouseout', function() {
                map.scrollWheelZoom.disable();
            });
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors',
                maxZoom: 19
            }).addTo(map);
            
            markerClusterGroup = L.markerClusterGroup({
                maxClusterRadius: 50,
                disableClusteringAtZoom: 18,
                spiderfyOnMaxZoom: true,
                showCoverageOnHover: false,
                zoomToBoundsOnClick: true,
                iconCreateFunction: function(cluster) {
                    const count = cluster.getChildCount();
                    let size = 'small';
                    if (count >= 10) size = 'medium';
                    if (count >= 50) size = 'large';
                    return L.divIcon({
                        html: `<div class="marker-cluster marker-cluster-${size}">${count}</div>`,
                        className: '',
                        iconSize: size === 'small' ? [40, 40] : size === 'medium' ? [50, 50] : [60, 60]
                    });
                }
            });
            map.addLayer(markerClusterGroup);
            
            setTimeout(() => {
                map.invalidateSize();
                mapReady = true;
                hideMapLoading();
                console.log('Map ready');
            }, 500);
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        async function geocodeAllListings() {
            console.log('Starting geocoding...');
            for (let listing of allListings) {
                if (!listing.coordinates && listing.address && !isBasedIn(listing)) {
                    await geocodeListing(listing);
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
            console.log('Geocoding complete');
            if (map && mapReady) {
                updateMapMarkers();
            }
        }
        
        async function geocodeListing(listing) {
            const fullAddress = getFullAddress(listing);
            try {
                const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1`);
                const data = await response.json();
                if (data && data.length > 0) {
                    listing.coordinates = { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) };
                    console.log('Geocoded:', listing.business_name);
                }
            } catch (e) {
                console.error('Geocoding failed for', listing.business_name, e);
            }
        }
        
        function updateMapMarkers() {
            if (!map || !markerClusterGroup || !mapReady) return;
            
            console.log('Updating map markers for', filteredListings.length, 'listings');
            markerClusterGroup.clearLayers();
            const bounds = [];
            
            filteredListings.forEach(listing => {
                if (listing.coordinates && !isBasedIn(listing)) {
                    const isFeatured = listing.tier === 'FEATURED' || listing.tier === 'PREMIUM';
                    const logoImage = listing.logo || '';
                    
                    const iconClass = isFeatured ? 'custom-marker featured' : 'custom-marker';
                    const iconHtml = logoImage ? 
                        `<div class="${iconClass}"><img src="${logoImage}" alt="${listing.business_name}"></div>` :
                        `<div class="${iconClass}"><div style="width:100%;height:100%;display:flex;align-items:center;justify-content:center;font-size:12px;color:#666;">No logo</div></div>`;
                    const customIcon = L.divIcon({ html: iconHtml, className: '', iconSize: [40, 40], iconAnchor: [20, 20] });
                    const marker = L.marker([listing.coordinates.lat, listing.coordinates.lng], { icon: customIcon, riseOnHover: true });
                    
                    const categorySlug = listing.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
                    const firstPhoto = listing.photos && listing.photos.length > 0 ? listing.photos[0] : (listing.logo || '');
                    const badges = [];
                    
                    if (isFeatured) badges.push('<span class="badge badge-featured">Featured</span>');
                    if (listing.verified) badges.push('<span class="badge badge-verified">Verified</span>');
                    
                    const popupContent = `
                        <div class="map-popup">
                            ${firstPhoto ? `<img src="${firstPhoto}" alt="${listing.business_name}" class="map-popup-hero">` : '<div class="map-popup-hero" style="background:#f3f4f6;"></div>'}
                            <div class="map-popup-content">
                                ${logoImage ? `<img src="${logoImage}" alt="${listing.business_name}" class="map-popup-logo">` : '<div class="map-popup-logo" style="background:#f3f4f6;"></div>'}
                                <div class="map-popup-info">
                                    <div class="map-popup-badges">${badges.join('')}</div>
                                    <a href="/listing/${categorySlug}/${listing.slug}" class="map-popup-title">${listing.business_name}</a>
                                    <div class="map-popup-tagline">${listing.tagline || listing.description?.substring(0, 60) + '...' || ''}</div>
                                    <div class="map-popup-details">üìç ${getFullAddress(listing)}<br>${listing.phone ? 'üìû ' + formatPhoneDisplay(listing.phone) : ''}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    marker.bindPopup(popupContent, { maxWidth: 320, className: 'custom-popup' });
                    marker.on('popupopen', () => {
                        const closeBtn = document.querySelector('.leaflet-popup-close-button');
                        if (closeBtn) closeBtn.textContent = '√ó';
                    });
                    markerClusterGroup.addLayer(marker);
                    bounds.push([listing.coordinates.lat, listing.coordinates.lng]);
                }
            });
            
            if (bounds.length > 0) {
                map.fitBounds(L.latLngBounds(bounds), { padding: [50, 50], maxZoom: 15 });
            }
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        function showMapLoading() {
            const loading = document.getElementById('mapLoading');
            if (loading) loading.style.display = 'block';
        }
        
        function hideMapLoading() {
            const loading = document.getElementById('mapLoading');
            if (loading) loading.style.display = 'none';
        }
        
        function addUserLocationMarker() {
            if (!map || !userLocation) return;
            if (userLocationMarker) map.removeLayer(userLocationMarker);
            const userIcon = L.divIcon({
                html: '<div style="width: 16px; height: 16px; background: #4285F4; border: 3px solid white; border-radius: 50%; box-shadow: 0 0 8px rgba(0,0,0,0.3);"></div>',
                className: '', iconSize: [22, 22], iconAnchor: [11, 11]
            });
            userLocationMarker = L.marker([userLocation.lat, userLocation.lng], {
                icon: userIcon, zIndexOffset: 1000
            }).addTo(map);
            userLocationMarker.bindPopup('<strong>Your Location</strong>');
        }
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
        
        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            console.log('DOM ready, loading listings...');
            loadListings();
            initMap();
            
            document.getElementById('filterBtn')?.addEventListener('click', () => {
                const panel = document.getElementById('filterPanel');
                panel?.classList.toggle('hidden');
            });
            
            document.getElementById('closeFilterBtn')?.addEventListener('click', () => {
                const panel = document.getElementById('filterPanel');
                panel?.classList.add('hidden');
            });
            
            document.getElementById('clearFiltersBtn')?.addEventListener('click', () => {
                selectedCategory = 'All';
                selectedSubcategories = [];
                selectedCountry = '';
                selectedState = '';
                
                const categorySearch = document.getElementById('categorySearch');
                if (categorySearch) categorySearch.value = '';
                
                const countryFilter = document.getElementById('countryFilter');
                if (countryFilter) countryFilter.value = '';
                
                const stateFilter = document.getElementById('stateFilter');
                if (stateFilter) stateFilter.value = '';
                
                const stateContainer = document.getElementById('stateFilterContainer');
                if (stateContainer) stateContainer.classList.add('hidden');
                
                createCategoryButtons();
                updateSubcategoryDisplay();
                applyFilters();
            });
            
            document.getElementById('countryFilter')?.addEventListener('change', (e) => {
                selectedCountry = e.target.value;
                if (selectedCountry === 'USA') {
                    const stateContainer = document.getElementById('stateFilterContainer');
                    if (stateContainer) stateContainer.classList.remove('hidden');
                    populateStateFilter('USA');
                } else {
                    const stateContainer = document.getElementById('stateFilterContainer');
                    if (stateContainer) stateContainer.classList.add('hidden');
                    selectedState = '';
                }
                applyFilters();
            });
            
            document.getElementById('stateFilter')?.addEventListener('change', (e) => {
                selectedState = e.target.value;
                applyFilters();
            });
            
            document.getElementById('locateBtn')?.addEventListener('click', () => {
                if (userLocation) {
                    map.setView([userLocation.lat, userLocation.lng], 13);
                } else {
                    if (navigator.geolocation) {
                        navigator.geolocation.getCurrentPosition(
                            position => {
                                userLocation = { lat: position.coords.latitude, lng: position.coords.longitude };
                                map.setView([userLocation.lat, userLocation.lng], 13);
                                addUserLocationMarker();
                            },
                            error => console.log('Location error:', error.message)
                        );
                    }
                }
            });
            
            document.getElementById('resetMapBtn')?.addEventListener('click', () => {
                if (map) {
                    map.setView(defaultMapCenter, defaultMapZoom);
                }
            });
            
            document.getElementById('categorySearch')?.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                if (!searchTerm) {
                    createCategoryButtons();
                    return;
                }
                
                const matchingCategories = CATEGORIES.filter(cat => 
                    cat.toLowerCase().includes(searchTerm)
                );
                
                const container = document.getElementById('categoryFilters');
                if (container) {
                    container.innerHTML = '';
                    matchingCategories.forEach(cat => {
                        const button = document.createElement('button');
                        button.className = selectedCategory === cat ? 
                            'px-3 py-2 rounded-lg text-sm font-medium text-white' : 
                            'px-3 py-2 rounded-lg text-sm font-medium bg-white text-gray-700 border border-gray-300';
                        if (selectedCategory === cat) button.style.backgroundColor = '#055193';
                        button.textContent = cat;
                        button.onclick = () => filterByCategory(cat);
                        container.appendChild(button);
                    });
                }
            });
        });
        
        // Copyright (C) The Greek Directory, 2025-present. All rights reserved.
    </script>
</body>
</html>
<!-- Copyright (C) The Greek Directory, 2025-present. All rights reserved. This source code is proprietary and no part may not be used, reproduced, or distributed without written permission from The Greek Directory. For more information, visit https://thegreekdirectory.org/legal. -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    
    <title>Business Portal - The Greek Directory</title>
    <meta name="apple-mobile-web-app-status-bar-style" content="white">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="TGD Business">
    <link rel="apple-touch-startup-image" href="https://listings.thegreekdirectory.org/Squarekeylogoapple4.png">
    <link rel="apple-touch-icon" href="https://listings.thegreekdirectory.org/Squarekeylogoapple4.png">
    <link rel="icon" href="https://listings.thegreekdirectory.org/Square%20key%20logo.png">
    
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <style>
        :root {
            --tgd-blue: #055193;
            --tgd-gold: #D4AF37;
            --tgd-white: #FFFFFF;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
        .hidden { display: none !important; }
        .image-preview { width: 100px; height: 100px; object-fit: cover; border-radius: 8px; border: 2px solid #e5e7eb; pointer-events: none; user-select: none; -webkit-user-drag: none; }
        .image-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 12px; }
        .upload-progress { display: none; background: #eff6ff; border: 1px solid #3b82f6; padding: 12px; border-radius: 8px; margin-top: 8px; }
        .sortable-ghost { opacity: 0.4; }
        .photo-item { position: relative; cursor: move; }
        .photo-item .delete-photo { position: absolute; top: 4px; right: 4px; background: #ef4444; color: white; border-radius: 50%; width: 24px; height: 24px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 14px; }
        .photo-item .photo-number { position: absolute; top: 4px; left: 4px; background: rgba(0,0,0,0.7); color: white; border-radius: 4px; padding: 2px 6px; font-size: 12px; font-weight: bold; }
        img { pointer-events: none; user-select: none; -webkit-user-drag: none; }
        .analytics-stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px; border-radius: 12px; }
        .tier-badge { display: inline-block; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 14px; }
        .tier-FREE { background: #e5e7eb; color: #374151; }
        .tier-VERIFIED { background: #dbeafe; color: #1e40af; }
        .tier-FEATURED { background: #fef3c7; color: #92400e; }
        .tier-PREMIUM { background: #f3e8ff; color: #6b21a8; }
        .char-counter { font-size: 12px; color: #6b7280; }
        .char-counter.warning { color: #f59e0b; }
        .char-counter.error { color: #ef4444; }
        .subcategory-checkbox { display: flex; align-items: center; gap: 8px; padding: 8px; border: 1px solid #e5e7eb; border-radius: 6px; cursor: pointer; transition: all 0.2s; }
        .subcategory-checkbox:hover { background: #f3f4f6; }
        .subcategory-checkbox input[type="checkbox"]:checked + label { font-weight: 600; color: #055193; }
        .disabled-field { opacity: 0.5; pointer-events: none; cursor: not-allowed; background: #f9fafb; }
        .preview-card { display: flex; gap: 16px; padding: 16px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .preview-main-image { width: 200px; height: 200px; object-fit: cover; border-radius: 8px; flex-shrink: 0; }
        .preview-info { flex: 1; }
        .preview-logo { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }
        .info-notice { font-size: 12px; color: #6b7280; margin-top: 4px; font-style: italic; }
        .visibility-toggle { cursor: pointer; padding: 4px 8px; border-radius: 4px; font-size: 12px; transition: all 0.2s; }
        .visibility-toggle.visible { background: #10b981; color: white; }
        .visibility-toggle.hidden { background: #ef4444; color: white; }
        .owner-field { display: flex; gap: 8px; align-items: center; }
        .slug-preview { font-family: monospace; background: #f3f4f6; padding: 8px 12px; border-radius: 6px; font-size: 14px; color: #374151; display: inline-block; }
        .id-badge { display: inline-block; background: #055193; color: white; padding: 4px 12px; border-radius: 4px; font-weight: 600; font-size: 12px; margin-left: 8px; }
        
        .tgd-button-primary {
            background: linear-gradient(135deg, var(--tgd-blue) 0%, #044080 100%);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            border: none;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tgd-button-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(5, 81, 147, 0.3);
        }
        .tgd-button-secondary {
            background: white;
            color: var(--tgd-blue);
            border: 2px solid var(--tgd-blue);
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .tgd-button-secondary:hover {
            background: var(--tgd-blue);
            color: white;
        }
        .tgd-input {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 12px 16px;
            width: 100%;
            transition: all 0.3s;
        }
        .tgd-input:focus {
            outline: none;
            border-color: var(--tgd-blue);
            box-shadow: 0 0 0 3px rgba(5, 81, 147, 0.1);
        }
        .tgd-card {
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
            padding: 24px;
        }
        .tgd-gold-accent {
            color: var(--tgd-gold);
            font-weight: 600;
        }
        
        .auth-container {
            min-height: 100vh;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .auth-card {
            background: white;
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
            max-width: 480px;
            width: 100%;
            overflow: hidden;
        }
        .auth-header {
            background: linear-gradient(135deg, var(--tgd-blue) 0%, #044080 100%);
            padding: 32px 24px;
            text-align: center;
            color: white;
        }
        .auth-body {
            padding: 32px 24px;
        }
        .auth-divider {
            display: flex;
            align-items: center;
            text-align: center;
            margin: 24px 0;
        }
        .auth-divider::before,
        .auth-divider::after {
            content: '';
            flex: 1;
            border-bottom: 1px solid #e5e7eb;
        }
        .auth-divider span {
            padding: 0 12px;
            color: #6b7280;
            font-size: 14px;
        }
        .error-message {
            background: #fee;
            border: 1px solid #fcc;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        .success-message {
            background: #efe;
            border: 1px solid #cfc;
            color: #3c3;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        @media (max-width: 768px) {
            .preview-card { flex-direction: column; }
            .preview-main-image { width: 100%; height: 200px; }
            .preview-logo { width: 60px; height: 60px; }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Login/Signup Page -->
    <div id="authPage" class="auth-container hidden">
        <div class="auth-card">
            <div class="auth-header">
                <img src="https://static.thegreekdirectory.org/Logo2white.png" alt="The Greek Directory logo" class="h-16 w-auto mx-auto mb-4">
                <h1 class="text-3xl font-bold">Business Portal</h1>
                <p class="text-blue-100 mt-2">Manage your listing on The Greek Directory</p>
            </div>
            
            <div class="auth-body">
                <div id="authMessage" class="hidden"></div>
                
                <!-- Sign In Form -->
                <div id="signInForm">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Sign In</h2>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="signInEmail" class="tgd-input" placeholder="your@email.com" autocomplete="email">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password</label>
                            <input type="password" id="signInPassword" class="tgd-input" placeholder="Enter your password" autocomplete="current-password">
                        </div>
                        <div class="flex items-center justify-between">
                            <label class="flex items-center">
                                <input type="checkbox" id="rememberMe" class="w-4 h-4 mr-2">
                                <span class="text-sm text-gray-700">Remember me</span>
                            </label>
                            <a href="#" onclick="showForgotPassword()" class="text-sm text-blue-600 hover:text-blue-800">Forgot password?</a>
                        </div>
                        <button onclick="handleSignIn()" class="tgd-button-primary w-full">
                            Sign In
                        </button>
                    </div>
                    
                    <div class="auth-divider">
                        <span>Don't have an account?</span>
                    </div>
                    
                    <button onclick="showSignUpForm()" class="tgd-button-secondary w-full">
                        Create Account
                    </button>
                    
                    <p class="text-center text-sm text-gray-600 mt-4">
                        Need help? <a href="mailto:contact@thegreekdirectory.org" class="text-blue-600 hover:underline">Contact us</a>
                    </p>
                </div>
                
                <!-- Sign Up Form -->
                <div id="signUpForm" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Create Account</h2>
                    <p class="text-sm text-gray-600 mb-6">Sign up to claim and manage your business listing</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Listing ID or Business Name *</label>
                            <input type="text" id="signUpListingSearch" class="tgd-input" placeholder="Search for your business..." oninput="searchListingForSignup()">
                            <div id="listingSearchResults" class="mt-2 max-h-48 overflow-y-auto"></div>
                            <input type="hidden" id="signUpListingId">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Business Email *</label>
                            <input type="email" id="signUpEmail" class="tgd-input" placeholder="your@business.com" autocomplete="email">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Business Phone (Optional)</label>
                            <input type="tel" id="signUpPhone" class="tgd-input" placeholder="(555) 123-4567" autocomplete="tel">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Password *</label>
                            <input type="password" id="signUpPassword" class="tgd-input" placeholder="Create a secure password" autocomplete="new-password">
                            <p class="text-xs text-gray-500 mt-1">Must be at least 6 characters</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Confirm Password *</label>
                            <input type="password" id="signUpPasswordConfirm" class="tgd-input" placeholder="Re-enter your password" autocomplete="new-password">
                        </div>
                        
                        <div class="flex items-start">
                            <input type="checkbox" id="agreeTerms" class="w-4 h-4 mt-1 mr-2">
                            <label for="agreeTerms" class="text-sm text-gray-700">
                                I agree to the <a href="https://thegreekdirectory.org/terms" target="_blank" class="text-blue-600 hover:underline">Terms of Service</a> and <a href="https://thegreekdirectory.org/privacy" target="_blank" class="text-blue-600 hover:underline">Privacy Policy</a>
                            </label>
                        </div>
                        
                        <button onclick="handleSignUp()" class="tgd-button-primary w-full">
                            Create Account
                        </button>
                    </div>
                    
                    <div class="auth-divider">
                        <span>Already have an account?</span>
                    </div>
                    
                    <button onclick="showSignInForm()" class="tgd-button-secondary w-full">
                        Sign In
                    </button>
                </div>
                
                <!-- Forgot Password Form -->
                <div id="forgotPasswordForm" class="hidden">
                    <h2 class="text-2xl font-bold text-gray-900 mb-2">Reset Password</h2>
                    <p class="text-sm text-gray-600 mb-6">Enter your email to receive a password reset link</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email Address</label>
                            <input type="email" id="resetEmail" class="tgd-input" placeholder="your@email.com" autocomplete="email">
                        </div>
                        
                        <button onclick="handlePasswordReset()" class="tgd-button-primary w-full">
                            Send Reset Link
                        </button>
                    </div>
                    
                    <div class="auth-divider">
                        <span>Remember your password?</span>
                    </div>
                    
                    <button onclick="showSignInForm()" class="tgd-button-secondary w-full">
                        Back to Sign In
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- Dashboard Page -->
    <div id="dashboardPage" class="hidden">
        <header class="bg-white shadow-sm border-b sticky top-0 z-50">
            <div class="max-w-7xl mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="https://social.thegreekdirectory.org/Logo2.png" alt="The Greek Directory" class="h-12 w-auto">
                        <div>
                            <h1 class="text-xl font-bold" style="color: #055193;">Business Portal</h1>
                            <p class="text-sm text-gray-600"><span id="businessName"></span> <span id="listingIdDisplay" class="id-badge"></span></p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3">
                        <span id="tierBadge" class="tier-badge"></span>
                        <button onclick="logout()" class="px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">Logout</button>
                    </div>
                </div>
            </div>
        </header>

        <div class="max-w-7xl mx-auto px-4 py-6">
            <!-- Navigation Tabs -->
            <div class="flex gap-2 mb-6 overflow-x-auto">
                <button onclick="switchTab('overview')" id="tab-overview" class="px-4 py-2 rounded-lg font-medium bg-white border-2 border-blue-600 text-blue-600">Overview</button>
                <button onclick="switchTab('edit')" id="tab-edit" class="px-4 py-2 rounded-lg font-medium bg-white border border-gray-300 text-gray-700">Edit Listing</button>
                <button onclick="switchTab('analytics')" id="tab-analytics" class="px-4 py-2 rounded-lg font-medium bg-white border border-gray-300 text-gray-700">Analytics</button>
                <button onclick="switchTab('settings')" id="tab-settings" class="px-4 py-2 rounded-lg font-medium bg-white border border-gray-300 text-gray-700">Settings</button>
            </div>
            
            <!-- Overview Tab -->
            <div id="content-overview" class="space-y-6">
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h2 class="text-2xl font-bold text-gray-900 mb-4">Welcome!</h2>
                    <p class="text-gray-700 mb-4">Manage your listing on The Greek Directory. Your current tier allows you to access the following features:</p>
                    
                    <div id="tierFeatures" class="space-y-2 mb-6"></div>
                    
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <h3 class="font-semibold text-blue-900 mb-2">Quick Actions</h3>
                        <div class="flex gap-3">
                            <button onclick="switchTab('edit')" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Edit Listing</button>
                            <button onclick="switchTab('analytics')" class="px-4 py-2 bg-white text-blue-600 border border-blue-600 rounded-lg hover:bg-blue-50">View Analytics</button>
                            <a id="viewLiveBtn" href="#" target="_blank" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">View Live Page</a>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h3 class="text-xl font-bold text-gray-900 mb-4">Listing Preview</h3>
                    <div class="preview-card">
                        <img id="previewMainImage" src="" alt="Main preview" class="preview-main-image">
                        <div class="preview-info">
                            <div class="flex items-start justify-between mb-3">
                                <div class="flex-1">
                                    <h4 id="previewBusinessName" class="text-2xl font-bold text-gray-900 mb-1"></h4>
                                    <p id="previewTagline" class="text-gray-600 italic text-sm mb-2"></p>
                                    <div id="previewCategory" class="inline-block px-3 py-1 text-sm font-semibold text-white rounded-full mb-2" style="background-color:#055193;"></div>
                                </div>
                                <img id="previewLogo" src="" alt="Logo" class="preview-logo ml-4">
                            </div>
                            <div id="previewDetails" class="text-sm text-gray-700 space-y-1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Edit Tab -->
            <div id="content-edit" class="hidden">
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Edit Your Listing</h2>
                        <button onclick="saveChanges()" class="px-6 py-2 text-white rounded-lg font-medium" style="background-color: #055193;">Save Changes</button>
                    </div>
                    
                    <div class="space-y-6" id="editForm"></div>
                </div>
            </div>
            
            <!-- Analytics Tab -->
            <div id="content-analytics" class="hidden">
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-gray-900">Analytics</h2>
                        <button onclick="loadListingData()" class="px-4 py-2 bg-blue-100 text-blue-700 rounded-lg hover:bg-blue-200">üîÑ Refresh</button>
                    </div>
                    
                    <div id="analyticsContent"></div>
                </div>
            </div>

            <!-- Settings Tab -->
            <div id="content-settings" class="hidden">
                <div class="bg-white rounded-lg p-6 shadow-sm">
                    <h2 class="text-2xl font-bold text-gray-900 mb-6">Account Settings</h2>
                    
                    <div class="space-y-6">
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Contact Information</h3>
                            <p class="text-sm text-gray-600 mb-4">This information is stored securely in Supabase and can be displayed on your listing page.</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div class="owner-field">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Email</label>
                                        <input type="email" id="settingsOwnerEmail" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="business@email.com">
                                    </div>
                                    <div class="mt-6">
                                        <button class="visibility-toggle hidden" data-field="email" onclick="toggleSettingsFieldVisibility('email')">Hidden</button>
                                    </div>
                                </div>
                                
                                <div class="owner-field">
                                    <div class="flex-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-2">Business Phone</label>
                                        <input type="tel" id="settingsOwnerPhone" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="(555) 123-4567">
                                    </div>
                                    <div class="mt-6">
                                        <button class="visibility-toggle hidden" data-field="phone" onclick="toggleSettingsFieldVisibility('phone')">Hidden</button>
                                    </div>
                                </div>
                            </div>
                            
                            <p class="text-xs text-gray-500 mt-4">
                                <strong>Note:</strong> Toggle visibility to control whether these details appear on your public listing page.
                            </p>
                        </div>
                        
                        <div>
                            <h3 class="text-lg font-bold text-gray-900 mb-4">Password</h3>
                            <div class="max-w-md space-y-4">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">New Password</label>
                                    <input type="password" id="settingsNewPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Enter new password">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 mb-2">Confirm New Password</label>
                                    <input type="password" id="settingsConfirmPassword" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="Confirm new password">
                                </div>
                                <button onclick="updatePassword()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Update Password</button>
                            </div>
                        </div>
                        
                        <div class="border-t pt-6">
                            <button onclick="saveSettings()" class="px-6 py-3 text-white rounded-lg font-medium" style="background-color: #055193;">Save Settings</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <script src="js/supabase-config.js"></script>
    <script>

        const SUBCATEGORIES = {
            'Automotive & Transportation': ['Auto Detailer', 'Auto Repair Shop', 'Car Dealer', 'Taxi & Limo Service'],
            'Beauty & Health': ['Barbershops', 'Esthetician', 'Hair Salons', 'Nail Salon', 'Spas', 'Chiropractor', 'Dentist', 'Doctor', 'Nutritionist', 'Optometrist', 'Orthodontist', 'Physical Therapist', 'Physical Trainer'],
            'Church & Religious Organization': ['Church'],
            'Cultural/Fraternal Organization': ['Dance Troupe', 'Non-Profit', 'Philanthropic Group', 'Society', 'Youth Organization'],
            'Education & Community': ['Childcare', 'Greek School', 'Senior Care', 'Tutor'],
            'Entertainment, Arts & Recreation': ['Band', 'DJs', 'Entertainment Group', 'Photographer', 'Art'],
            'Food & Hospitality': ['Banquet Hall', 'Catering Service', 'Event Venue', 'Bakeries', 'Deli', 'Pastry Shop', 'Bar', 'Breakfast', 'Coffee', 'Lunch', 'Dinner', 'Restaurant', 'Hotel', 'Airbnb'],
            'Grocery & Imports': ['Butcher Shop', 'Liquor Shop', 'Market', 'Greek Alcohol', 'Honey', 'Olive Oil', 'Food Distribution', 'Food Manufacturer'],
            'Home & Construction': ['Carpenter', 'Electrician', 'General Contractor', 'Handyman', 'HVAC', 'Landscaping', 'Painter', 'Plumber', 'Roofing', 'Tile & Stone Specialist'],
            'Industrial & Manufacturing': ['Food Manufacturer'],
            'Pets & Veterinary': ['Veterinarian', 'Pet Accessories Maker'],
            'Professional & Business Services': ['Business Services', 'Consultant', 'CPA', 'Financial Advisor', 'Insurance Agent', 'IT Service & Repair', 'Lawyer', 'Marketing & Creative Agency', 'Notaries', 'Wedding Planner', 'Travel Agency'],
            'Real Estate & Development': ['Appraiser', 'Broker', 'Developer', 'Lender', 'Property Management', 'Real Estate Agent'],
            'Retail & Shopping': ['Boutique Shop', 'ECommerce', 'Jewelry', 'Souvenir Shop']
        };

        let currentUser = null;
        let currentListing = null;
        let ownerData = null;
        let allListings = [];
        let uploadedImages = { logo: null, photos: [] };
        let photosSortable = null;
        let selectedSubcategories = [];
        let settingsVisibility = { email: false, phone: false };

        document.addEventListener('DOMContentLoaded', async () => {
            console.log('üöÄ Initializing Business Portal...');
            
            await checkAuthState();
            
            window.TGDAuth.onAuthStateChange(async (event, session) => {
                console.log('Auth state changed:', event);
                if (event === 'SIGNED_IN') {
                    await handleAuthSuccess(session);
                } else if (event === 'SIGNED_OUT') {
                    showAuthPage();
                } else if (event === 'TOKEN_REFRESHED') {
                    console.log('Token refreshed');
                }
            });
        });

        async function checkAuthState() {
            console.log('üîç Checking authentication state...');
            
            const session = await window.TGDAuth.getCurrentSession();
            
            if (session) {
                console.log('‚úÖ User is authenticated');
                currentUser = session.user;
                await handleAuthSuccess(session);
            } else {
                console.log('‚ùå User not authenticated');
                showAuthPage();
            }
        }

        async function handleAuthSuccess(session) {
            currentUser = session.user;
            
            ownerData = await window.TGDAuth.getBusinessOwnerData();
            
            if (!ownerData) {
                showError('Could not load business owner data. Please contact support.');
                await window.TGDAuth.signOut();
                showAuthPage();
                return;
            }
            
            await loadListingData();
            
            showDashboard();
        }

        function showAuthPage() {
            document.getElementById('authPage').classList.remove('hidden');
            document.getElementById('dashboardPage').classList.add('hidden');
        }

        function showDashboard() {
            document.getElementById('authPage').classList.add('hidden');
            document.getElementById('dashboardPage').classList.remove('hidden');
            renderDashboard();
        }

        function showSignInForm() {
            document.getElementById('signInForm').classList.remove('hidden');
            document.getElementById('signUpForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            clearAuthMessage();
        }

        function showSignUpForm() {
            document.getElementById('signInForm').classList.add('hidden');
            document.getElementById('signUpForm').classList.remove('hidden');
            document.getElementById('forgotPasswordForm').classList.add('hidden');
            clearAuthMessage();
        }

        function showForgotPassword() {
            document.getElementById('signInForm').classList.add('hidden');
            document.getElementById('signUpForm').classList.add('hidden');
            document.getElementById('forgotPasswordForm').classList.remove('hidden');
            clearAuthMessage();
        }

        function showError(message) {
            const msgDiv = document.getElementById('authMessage');
            msgDiv.className = 'error-message';
            msgDiv.textContent = message;
            msgDiv.classList.remove('hidden');
        }

        function showSuccess(message) {
            const msgDiv = document.getElementById('authMessage');
            msgDiv.className = 'success-message';
            msgDiv.textContent = message;
            msgDiv.classList.remove('hidden');
        }

        function clearAuthMessage() {
            const msgDiv = document.getElementById('authMessage');
            msgDiv.classList.add('hidden');
            msgDiv.textContent = '';
        }

        async function handleSignIn() {
            const email = document.getElementById('signInEmail').value.trim();
            const password = document.getElementById('signInPassword').value;
            
            if (!email || !password) {
                showError('Please enter both email and password');
                return;
            }
            
            clearAuthMessage();
            const result = await window.TGDAuth.signInBusinessOwner(email, password);
            
            if (result.success) {
                showSuccess('Signing in...');
            } else {
                showError(result.error);
            }
        }

        async function searchListingForSignup() {
            const searchTerm = document.getElementById('signUpListingSearch').value.trim().toLowerCase();
            const resultsDiv = document.getElementById('listingSearchResults');
            
            if (searchTerm.length < 2) {
                resultsDiv.innerHTML = '';
                return;
            }
            
            if (!allListings || allListings.length === 0) {
                try {
                    const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${DATABASE_PATH}`);
                    const data = await response.json();
                    allListings = data.listings;
                } catch (error) {
                    console.error('Error loading listings:', error);
                    return;
                }
            }
            
            const matches = allListings.filter(l => 
                l.businessName.toLowerCase().includes(searchTerm) ||
                l.listingId.toString().includes(searchTerm) ||
                l.id.includes(searchTerm)
            ).slice(0, 5);
            
            if (matches.length === 0) {
                resultsDiv.innerHTML = '<p class="text-sm text-gray-500 p-2">No listings found</p>';
                return;
            }
            
            resultsDiv.innerHTML = matches.map(l => `
                <div class="p-2 hover:bg-gray-100 cursor-pointer rounded" onclick="selectListing('${l.id}', '${l.businessName}')">
                    <div class="font-medium">${l.businessName}</div>
                    <div class="text-xs text-gray-500">ID: ${l.listingId} ‚Ä¢ ${l.city}, ${l.state}</div>
                </div>
            `).join('');
        }

        function selectListing(listingId, businessName) {
            document.getElementById('signUpListingId').value = listingId;
            document.getElementById('signUpListingSearch').value = businessName;
            document.getElementById('listingSearchResults').innerHTML = '';
        }

        async function handleSignUp() {
            const listingId = document.getElementById('signUpListingId').value;
            const email = document.getElementById('signUpEmail').value.trim();
            const phone = document.getElementById('signUpPhone').value.trim();
            const password = document.getElementById('signUpPassword').value;
            const confirmPassword = document.getElementById('signUpPasswordConfirm').value;
            const agreeTerms = document.getElementById('agreeTerms').checked;
            
            if (!listingId) {
                showError('Please search and select your business listing');
                return;
            }
            
            if (!email) {
                showError('Please enter your business email');
                return;
            }
            
            if (!password || password.length < 6) {
                showError('Password must be at least 6 characters');
                return;
            }
            
            if (password !== confirmPassword) {
                showError('Passwords do not match');
                return;
            }
            
            if (!agreeTerms) {
                showError('Please agree to the Terms of Service and Privacy Policy');
                return;
            }
            
            clearAuthMessage();
            const result = await window.TGDAuth.signUpBusinessOwner(email, password, listingId, phone);
            
            if (result.success) {
                showSuccess(result.message);
                setTimeout(() => showSignInForm(), 3000);
            } else {
                showError(result.error);
            }
        }

        async function handlePasswordReset() {
            const email = document.getElementById('resetEmail').value.trim();
            
            if (!email) {
                showError('Please enter your email address');
                return;
            }
            
            clearAuthMessage();
            const result = await window.TGDAuth.resetPassword(email);
            
            if (result.success) {
                showSuccess(result.message);
            } else {
                showError(result.error);
            }
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await window.TGDAuth.signOut();
                showAuthPage();
            }
        }

        window.handleSignIn = handleSignIn;
        window.handleSignUp = handleSignUp;
        window.handlePasswordReset = handlePasswordReset;
        window.showSignInForm = showSignInForm;
        window.showSignUpForm = showSignUpForm;
        window.showForgotPassword = showForgotPassword;
        window.searchListingForSignup = searchListingForSignup;
        window.selectListing = selectListing;
        window.logout = logout;
        async function loadListingData() {
            if (!ownerData || !ownerData.listing_id) {
                console.error('No listing ID found in owner data');
                return;
            }
            
            try {
                console.log('üì• Loading listing data from GitHub...');
                
                const response = await fetch(`https://raw.githubusercontent.com/${GITHUB_OWNER}/${GITHUB_REPO}/main/${DATABASE_PATH}`);
                
                if (!response.ok) {
                    throw new Error(`Failed to fetch database: ${response.status}`);
                }
                
                const data = await response.json();
                allListings = data.listings || [];
                
                currentListing = allListings.find(l => l.id === ownerData.listing_id);
                
                if (!currentListing) {
                    throw new Error('Listing not found in database');
                }
                
                console.log('‚úÖ Listing data loaded:', currentListing.businessName);
                
            } catch (error) {
                console.error('‚ùå Error loading listing data:', error);
                alert('Failed to load listing data. Please try again.');
            }
        }

        function renderDashboard() {
            if (!currentListing) return;
            
            document.getElementById('businessName').textContent = currentListing.businessName;
            document.getElementById('listingIdDisplay').textContent = `#${currentListing.listingId}`;
            
            const tier = currentListing.tier || 'FREE';
            const tierBadge = document.getElementById('tierBadge');
            tierBadge.textContent = tier + ' Tier';
            tierBadge.className = `tier-badge tier-${tier}`;
            
            const categorySlug = currentListing.category.toLowerCase().replace(/[^a-z0-9]+/g, '-');
            const listingUrl = `https://listings.thegreekdirectory.org/listings/${categorySlug}/${currentListing.slug}`;
            document.getElementById('viewLiveBtn').href = listingUrl;
            
            renderOverview();
            renderEditForm();
            renderAnalytics();
            renderSettings();
        }

        function switchTab(tab) {
            ['overview', 'edit', 'analytics', 'settings'].forEach(t => {
                document.getElementById(`content-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).className = 'px-4 py-2 rounded-lg font-medium bg-white border border-gray-300 text-gray-700';
            });
            
            document.getElementById(`content-${tab}`).classList.remove('hidden');
            document.getElementById(`tab-${tab}`).className = 'px-4 py-2 rounded-lg font-medium bg-white border-2 border-blue-600 text-blue-600';
        }
        
        function renderOverview() {
            if (!currentListing) return;
            
            const tier = currentListing.tier || 'FREE';
            const features = {
                'FREE': [
                    '‚úÖ Basic listing with logo and 1 photo',
                    '‚úÖ Contact information (phone, email, website)',
                    '‚úÖ Hours of operation',
                    '‚úÖ Social media links',
                    '‚úÖ Review site links',
                    '‚úÖ Tagline (max 75 characters)',
                    '‚úÖ Description (max 1000 characters)',
                    '‚úÖ Basic analytics (total views and engagement)'
                ],
                'VERIFIED': [
                    '‚úÖ All FREE features',
                    '‚úÖ Verified badge',
                    '‚úÖ Extended description (max 2000 characters)',
                    '‚úÖ Enhanced analytics (website, call, and direction clicks)',
                    '‚úÖ Monthly analytics totals'
                ],
                'FEATURED': [
                    '‚úÖ All VERIFIED features',
                    '‚úÖ Featured badge and priority placement',
                    '‚úÖ Photo gallery (up to 5 photos)',
                    '‚úÖ Advanced analytics (click breakdown and trends)',
                    '‚úÖ Category placement indicator'
                ],
                'PREMIUM': [
                    '‚úÖ All FEATURED features',
                    '‚úÖ Premium badge and top placement',
                    '‚úÖ Extended photo gallery (up to 15 photos)',
                    '‚úÖ Video embedding (1 video)',
                    '‚úÖ Comprehensive analytics (video plays, comparative performance)',
                    '‚úÖ Full engagement history'
                ]
            };
            
            const featuresList = document.getElementById('tierFeatures');
            featuresList.innerHTML = features[tier].map(f => `<div class="flex items-start gap-2"><span>${f}</span></div>`).join('');
            
            const mainImage = (currentListing.photos && currentListing.photos.length > 0) ? currentListing.photos[0] : currentListing.logo;
            document.getElementById('previewMainImage').src = mainImage;
            document.getElementById('previewLogo').src = currentListing.logo;
            document.getElementById('previewBusinessName').textContent = currentListing.businessName;
            document.getElementById('previewTagline').textContent = currentListing.tagline ? `"${currentListing.tagline}"` : '';
            document.getElementById('previewCategory').textContent = currentListing.category;
            
            const fullAddress = currentListing.address ? 
                `${currentListing.address}, ${currentListing.city}, ${currentListing.state} ${currentListing.zipCode || ''}` : 
                `${currentListing.city}, ${currentListing.state}`;
            
            let details = `<div><span class="font-semibold">Listing ID:</span> #${currentListing.listingId}</div>`;
            if (currentListing.subcategories && currentListing.subcategories.length > 0) {
                details += `<div><span class="font-semibold">Subcategories:</span> ${currentListing.subcategories.join(', ')}</div>`;
            }
            details += `<div><span class="font-semibold">Location:</span> ${fullAddress}</div>`;
            if (currentListing.phone) {
                details += `<div><span class="font-semibold">Phone:</span> ${currentListing.phone}</div>`;
            }
            if (currentListing.email) {
                details += `<div><span class="font-semibold">Email:</span> ${currentListing.email}</div>`;
            }
            if (currentListing.website) {
                details += `<div><span class="font-semibold">Website:</span> <a href="${currentListing.website}" target="_blank" class="text-blue-600 hover:underline">${currentListing.website}</a></div>`;
            }
            
            document.getElementById('previewDetails').innerHTML = details;
        }

        function renderSettings() {
            if (!ownerData) return;
            
            document.getElementById('settingsOwnerEmail').value = ownerData.owner_email || '';
            document.getElementById('settingsOwnerPhone').value = ownerData.owner_phone || '';
            
            settingsVisibility = {
                email: ownerData.email_visible || false,
                phone: ownerData.phone_visible || false
            };
            
            document.querySelectorAll('.visibility-toggle').forEach(btn => {
                const field = btn.getAttribute('data-field');
                if (settingsVisibility[field]) {
                    btn.className = 'visibility-toggle visible';
                    btn.textContent = 'Visible';
                } else {
                    btn.className = 'visibility-toggle hidden';
                    btn.textContent = 'Hidden';
                }
            });
        }

        window.toggleSettingsFieldVisibility = function(field) {
            settingsVisibility[field] = !settingsVisibility[field];
            const button = document.querySelector(`.visibility-toggle[data-field="${field}"]`);
            if (settingsVisibility[field]) {
                button.className = 'visibility-toggle visible';
                button.textContent = 'Visible';
            } else {
                button.className = 'visibility-toggle hidden';
                button.textContent = 'Hidden';
            }
        };

        async function updatePassword() {
            const newPassword = document.getElementById('settingsNewPassword').value;
            const confirmPassword = document.getElementById('settingsConfirmPassword').value;
            
            if (!newPassword || !confirmPassword) {
                alert('Please enter and confirm your new password');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                alert('Passwords do not match');
                return;
            }
            
            if (newPassword.length < 6) {
                alert('Password must be at least 6 characters');
                return;
            }
            
            const result = await window.TGDAuth.updatePassword(newPassword);
            
            if (result.success) {
                alert(result.message);
                document.getElementById('settingsNewPassword').value = '';
                document.getElementById('settingsConfirmPassword').value = '';
            } else {
                alert('Error: ' + result.error);
            }
        }

        async function saveSettings() {
            if (!ownerData) return;
            
            const updatedEmail = document.getElementById('settingsOwnerEmail').value.trim();
            const updatedPhone = document.getElementById('settingsOwnerPhone').value.trim();
            
            const updates = {
                owner_email: updatedEmail,
                owner_phone: updatedPhone,
                email_visible: settingsVisibility.email,
                phone_visible: settingsVisibility.phone
            };
            
            const result = await window.TGDAuth.updateBusinessOwnerContact(updates);
            
            if (result.success) {
                ownerData = result.data;
                alert('Settings saved successfully!');
                renderSettings();
            } else {
                alert('Error: ' + result.error);
            }
        }

        window.saveSettings = saveSettings;
        window.updatePassword = updatePassword;
        window.switchTab = switchTab;
        function renderAnalytics() {
            if (!currentListing) return;
            
            const tier = currentListing.tier || 'FREE';
            const analytics = currentListing.analytics || {
                views: 0,
                callClicks: 0,
                websiteClicks: 0,
                directionClicks: 0,
                shareClicks: 0,
                videoPlays: 0,
                lastViewed: 'Never',
                detailedViews: []
            };
            
            let html = '';
            
            if (tier === 'FREE') {
                html = `
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="analytics-stat-card">
                            <div class="text-4xl font-bold mb-2">${analytics.views || 0}</div>
                            <div class="text-sm opacity-90">Total Views</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="text-4xl font-bold mb-2">${(analytics.callClicks || 0) + (analytics.websiteClicks || 0) + (analytics.directionClicks || 0) + (analytics.shareClicks || 0)}</div>
                            <div class="text-sm opacity-90">Total Engagement</div>
                        </div>
                    </div>
                    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-900"><strong>Want more detailed analytics?</strong> Upgrade to Verified tier or higher to see individual click breakdowns, trends, and more!</p>
                    </div>
                `;
            } else if (tier === 'VERIFIED') {
                html = `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                        <div class="analytics-stat-card">
                            <div class="text-4xl font-bold mb-2">${analytics.views || 0}</div>
                            <div class="text-sm opacity-90">Total Views</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.callClicks || 0}</div>
                            <div class="text-sm opacity-90">Call Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.websiteClicks || 0}</div>
                            <div class="text-sm opacity-90">Website Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.directionClicks || 0}</div>
                            <div class="text-sm opacity-90">Direction Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.shareClicks || 0}</div>
                            <div class="text-sm opacity-90">Share Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%);">
                            <div class="text-lg font-bold mb-2">${analytics.lastViewed ? new Date(analytics.lastViewed).toLocaleString() : 'Never'}</div>
                            <div class="text-sm opacity-90">Last Viewed</div>
                        </div>
                    </div>
                    <div class="mt-6 bg-blue-50 border border-blue-200 rounded-lg p-4">
                        <p class="text-sm text-blue-900"><strong>Want advanced analytics?</strong> Upgrade to Featured or Premium tier for click breakdowns, trends, and comparative performance!</p>
                    </div>
                `;
            } else {
                const recentViews = analytics.detailedViews?.slice(-30) || [];
                html = `
                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4 mb-6">
                        <div class="analytics-stat-card">
                            <div class="text-4xl font-bold mb-2">${analytics.views || 0}</div>
                            <div class="text-sm opacity-90">Total Views</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.callClicks || 0}</div>
                            <div class="text-sm opacity-90">Call Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.websiteClicks || 0}</div>
                            <div class="text-sm opacity-90">Website Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.directionClicks || 0}</div>
                            <div class="text-sm opacity-90">Direction Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);">
                            <div class="text-4xl font-bold mb-2">${analytics.shareClicks || 0}</div>
                            <div class="text-sm opacity-90">Share Clicks</div>
                        </div>
                        <div class="analytics-stat-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%);">
                            <div class="text-4xl font-bold mb-2">${recentViews.length}</div>
                            <div class="text-sm opacity-90">Recent Activity</div>
                        </div>
                    </div>
                    <div class="bg-gray-50 rounded-lg p-4">
                        <h3 class="font-bold text-gray-900 mb-3">Recent Activity (Last 30 actions)</h3>
                        <div class="space-y-2">
                            ${recentViews.slice(-10).reverse().map(v => `
                                <div class="flex justify-between text-sm">
                                    <span class="font-medium">${v.action}</span>
                                    <span class="text-gray-600">${new Date(v.timestamp).toLocaleString()}</span>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
            }
            
            document.getElementById('analyticsContent').innerHTML = html;
        }

        function renderEditForm() {
            if (!currentListing) return;
            
            const tier = currentListing.tier || 'FREE';
            const maxDesc = tier === 'FREE' ? 1000 : 2000;
            const maxPhotos = tier === 'FREE' ? 1 : tier === 'FEATURED' ? 5 : tier === 'PREMIUM' ? 15 : 1;
            
            selectedSubcategories = currentListing.subcategories || [];
            
            let html = `
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Basic Information</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="md:col-span-2 disabled-field">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Listing ID</label>
                            <input type="text" value="#${currentListing.listingId}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" disabled>
                            <p class="info-notice">Listing ID number cannot be changed.</p>
                        </div>
                        <div class="md:col-span-2 disabled-field">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Business Name</label>
                            <input type="text" value="${currentListing.businessName}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" disabled>
                            <p class="info-notice">Contact Support to change this information.</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Tagline (max 75 chars) *</label>
                            <input type="text" id="editTagline" value="${currentListing.tagline || ''}" maxlength="75" class="w-full px-4 py-2 border border-gray-300 rounded-lg" oninput="updateCharCounter('tagline')">
                            <p class="char-counter mt-1"><span id="taglineCount">${(currentListing.tagline || '').length}</span>/75 characters</p>
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Description (max ${maxDesc} chars)</label>
                            <textarea id="editDescription" rows="5" class="w-full px-4 py-2 border border-gray-300 rounded-lg" oninput="updateCharCounter('description')">${currentListing.description || ''}</textarea>
                            <p class="char-counter mt-1"><span id="descriptionCount">${(currentListing.description || '').length}</span>/<span id="descriptionMax">${maxDesc}</span> characters</p>
                        </div>
                        <div class="disabled-field">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Category</label>
                            <input type="text" value="${currentListing.category}" class="w-full px-4 py-2 border border-gray-300 rounded-lg" disabled>
                            <p class="info-notice">Contact Support to change this information.</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Subcategories</label>
                            <div id="subcategoriesGrid" class="grid grid-cols-2 gap-2"></div>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Phone</label>
                            <input type="tel" id="editPhone" value="${currentListing.phone || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" id="editEmail" value="${currentListing.email || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Website</label>
                            <input type="url" id="editWebsite" value="${currentListing.website || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div class="md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Address</label>
                            <input type="text" id="editAddress" value="${currentListing.address || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">City</label>
                            <input type="text" id="editCity" value="${currentListing.city || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">State</label>
                            <input type="text" id="editState" value="${currentListing.state || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Zip Code</label>
                            <input type="text" id="editZipCode" value="${currentListing.zipCode || ''}" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        </div>
                    </div>
                </div>
            `;
            
            html += `
                <div>
                    <h3 class="text-lg font-bold text-gray-900 mb-4">Hours of Operation</h3>
                    <div class="grid grid-cols-1 gap-3">
                        ${['Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday', 'Sunday'].map(day => `
                            <div class="flex gap-2">
                                <label class="w-28 flex items-center font-medium text-gray-700">${day}:</label>
                                <input type="text" id="editHours${day}" value="${currentListing.hours && currentListing.hours[day.toLowerCase()] ? currentListing.hours[day.toLowerCase()] : ''}" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg" placeholder="9:00 AM - 5:00 PM or Closed">
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('editForm').innerHTML = html;
            
            renderSubcategories();
            
            if (currentListing.photos && currentListing.photos.length > 0) {
                uploadedImages.photos = currentListing.photos.map(url => ({ url: url, existing: true }));
                renderPhotosPreview();
            }
            
            setupImageHandlers();
        }

        function renderSubcategories() {
            const category = currentListing.category;
            const grid = document.getElementById('subcategoriesGrid');
            
            if (SUBCATEGORIES[category] && SUBCATEGORIES[category].length > 0) {
                grid.innerHTML = '';
                SUBCATEGORIES[category].forEach(sub => {
                    const div = document.createElement('div');
                    div.className = 'subcategory-checkbox';
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.id = `subcat-${sub}`;
                    checkbox.value = sub;
                    checkbox.checked = selectedSubcategories.includes(sub);
                    checkbox.onchange = () => toggleSubcategory(sub);
                    
                    const label = document.createElement('label');
                    label.htmlFor = `subcat-${sub}`;
                    label.textContent = sub;
                    label.className = 'cursor-pointer flex-1 text-sm';
                    
                    div.appendChild(checkbox);
                    div.appendChild(label);
                    grid.appendChild(div);
                });
            }
        }

        function toggleSubcategory(subcategory) {
            const index = selectedSubcategories.indexOf(subcategory);
            if (index > -1) {
                selectedSubcategories.splice(index, 1);
            } else {
                selectedSubcategories.push(subcategory);
            }
        }

        window.updateCharCounter = function(field) {
            if (field === 'tagline') {
                const input = document.getElementById('editTagline');
                const counter = document.getElementById('taglineCount');
                counter.textContent = input.value.length;
            } else if (field === 'description') {
                const input = document.getElementById('editDescription');
                const counter = document.getElementById('descriptionCount');
                const max = parseInt(document.getElementById('descriptionMax').textContent);
                const current = input.value.length;
                
                counter.textContent = current;
                counter.parentElement.className = 'char-counter mt-1';
                
                if (current > max) {
                    counter.parentElement.className = 'char-counter error mt-1';
                    input.value = input.value.substring(0, max);
                    counter.textContent = max;
                } else if (current > max * 0.9) {
                    counter.parentElement.className = 'char-counter warning mt-1';
                }
            }
        };
        function setupImageHandlers() {
            const logoUpload = document.getElementById('logoUpload');
            const photosUpload = document.getElementById('photosUpload');
            
            if (logoUpload) {
                logoUpload.addEventListener('change', async (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            uploadedImages.logo = { 
                                file: file,
                                base64: event.target.result.split(',')[1],
                                url: event.target.result
                            };
                            const logoPreview = document.getElementById('logoPreview');
                            if (logoPreview) {
                                logoPreview.innerHTML = `<img src="${event.target.result}" class="image-preview">`;
                            }
                        };
                        reader.readAsDataURL(file);
                    }
                });
            }

            if (photosUpload) {
                photosUpload.addEventListener('change', async (e) => {
                    const tier = currentListing.tier || 'FREE';
                    const maxPhotos = tier === 'FREE' ? 1 : tier === 'FEATURED' ? 5 : tier === 'PREMIUM' ? 15 : 1;
                    
                    const files = Array.from(e.target.files).slice(0, maxPhotos - uploadedImages.photos.length);
                    
                    for (const file of files) {
                        const reader = new FileReader();
                        await new Promise((resolve) => {
                            reader.onload = (event) => {
                                uploadedImages.photos.push({ 
                                    file: file,
                                    base64: event.target.result.split(',')[1],
                                    url: event.target.result
                                });
                                renderPhotosPreview();
                                resolve();
                            };
                            reader.readAsDataURL(file);
                        });
                    }
                });
            }
        }

        function renderPhotosPreview() {
            const preview = document.getElementById('photosPreview');
            if (!preview) return;
            
            preview.innerHTML = uploadedImages.photos.map((photo, idx) => `
                <div class="photo-item" data-index="${idx}">
                    <div class="photo-number">#${idx + 1}</div>
                    <img src="${photo.url}" class="image-preview">
                    <div class="delete-photo" onclick="deletePhoto(${idx})">√ó</div>
                </div>
            `).join('');
            
            if (photosSortable) {
                photosSortable.destroy();
            }
            initPhotosSortable();
        }

        function initPhotosSortable() {
            const preview = document.getElementById('photosPreview');
            if (preview && preview.children.length > 0) {
                photosSortable = Sortable.create(preview, {
                    animation: 150,
                    ghostClass: 'sortable-ghost',
                    onEnd: function(evt) {
                        const oldIndex = evt.oldIndex;
                        const newIndex = evt.newIndex;
                        const item = uploadedImages.photos.splice(oldIndex, 1)[0];
                        uploadedImages.photos.splice(newIndex, 0, item);
                        renderPhotosPreview();
                    }
                });
            }
        }

        window.deletePhoto = function(index) {
            uploadedImages.photos.splice(index, 1);
            renderPhotosPreview();
        };

        async function saveChanges() {
            const tagline = document.getElementById('editTagline').value.trim();
            if (!tagline) {
                alert('Tagline is required');
                return;
            }
            
            const tier = currentListing.tier || 'FREE';
            const maxDesc = tier === 'FREE' ? 1000 : 2000;
            const description = document.getElementById('editDescription').value;
            
            if (description.length > maxDesc) {
                alert(`Description too long! Maximum ${maxDesc} characters for ${tier} tier.`);
                return;
            }
            
            const changes = [];
            if (currentListing.tagline !== tagline) changes.push(`Tagline: "${currentListing.tagline}" ‚Üí "${tagline}"`);
            if (currentListing.description !== description) changes.push('Description updated');
            
            const newSubcategories = selectedSubcategories.sort().join(',');
            const oldSubcategories = (currentListing.subcategories || []).sort().join(',');
            if (oldSubcategories !== newSubcategories) changes.push(`Subcategories: ${oldSubcategories || 'None'} ‚Üí ${newSubcategories}`);
            
            const newPhone = document.getElementById('editPhone').value || null;
            if (currentListing.phone !== newPhone) changes.push(`Phone: ${currentListing.phone || 'None'} ‚Üí ${newPhone || 'None'}`);
            
            const newEmail = document.getElementById('editEmail').value || null;
            if (currentListing.email !== newEmail) changes.push(`Email: ${currentListing.email || 'None'} ‚Üí ${newEmail || 'None'}`);
            
            const newWebsite = document.getElementById('editWebsite').value || null;
            if (currentListing.website !== newWebsite) changes.push(`Website: ${currentListing.website || 'None'} ‚Üí ${newWebsite || 'None'}`);
            
            const newAddress = document.getElementById('editAddress').value || null;
            if (currentListing.address !== newAddress) changes.push(`Address: ${currentListing.address || 'None'} ‚Üí ${newAddress || 'None'}`);
            
            if (uploadedImages.logo && !uploadedImages.logo.existing) changes.push('Logo updated');
            if (uploadedImages.photos.some(p => !p.existing)) changes.push('Photos updated');
            
            if (changes.length === 0) {
                alert('No changes detected.');
                return;
            }
            
            const confirmMessage = `Are you sure you want to save these changes?\n\nChanges:\n${changes.map(c => `‚Ä¢ ${c}`).join('\n')}\n\nThese changes will take effect immediately.`;
            
            if (!confirm(confirmMessage)) return;
            
            currentListing.tagline = tagline;
            currentListing.description = description;
            currentListing.subcategories = selectedSubcategories;
            currentListing.phone = newPhone;
            currentListing.email = newEmail;
            currentListing.website = newWebsite;
            currentListing.address = newAddress;
            currentListing.city = document.getElementById('editCity').value || null;
            currentListing.state = document.getElementById('editState').value || null;
            currentListing.zipCode = document.getElementById('editZipCode').value || null;
            
            currentListing.hours = {
                monday: document.getElementById('editHoursMonday').value || null,
                tuesday: document.getElementById('editHoursTuesday').value || null,
                wednesday: document.getElementById('editHoursWednesday').value || null,
                thursday: document.getElementById('editHoursThursday').value || null,
                friday: document.getElementById('editHoursFriday').value || null,
                saturday: document.getElementById('editHoursSaturday').value || null,
                sunday: document.getElementById('editHoursSunday').value || null
            };
            
            if (uploadedImages.photos.length > 0) {
                currentListing.photos = uploadedImages.photos.map(p => p.url);
            }
            
            currentListing.metadata.updatedAt = new Date().toISOString();
            
            const index = allListings.findIndex(l => l.id === currentListing.id);
            if (index !== -1) {
                allListings[index] = currentListing;
                
                const databaseContent = { listings: allListings };
                const jsonString = JSON.stringify(databaseContent, null, 2);
                
                const result = await window.TGDAuth.updateGitHubFile(
                    GITHUB_OWNER,
                    GITHUB_REPO,
                    DATABASE_PATH,
                    jsonString,
                    `Update ${currentListing.businessName} - Business Portal`
                );
                
                if (result.success) {
                    alert('‚úÖ Changes saved and live immediately!');
                    renderDashboard();
                    switchTab('overview');
                } else {
                    alert('‚ùå Failed to save changes. Please try again.');
                }
            }
        }

        window.saveChanges = saveChanges;
        window.loadListingData = loadListingData;
    </script>
</body>
</html>
